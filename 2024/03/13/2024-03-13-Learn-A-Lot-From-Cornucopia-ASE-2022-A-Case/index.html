<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Computer, Network, Security">
    <meta name="description" content="a blog on Hexo">
    <meta name="author" content="TyeYeah">
    
    <title>
        
            Learn A Lot From Cornucopia (ASE 2022): A Case |
        
        Relish the Moment
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/img/wang.svg">
    
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/font/css/regular.min.css">

    
<link rel="stylesheet" href="/font/css/solid.min.css">

    
<link rel="stylesheet" href="/font/css/brands.min.css">

    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en","path":"search.xml"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"Relish the Moment","author":"TyeYeah","avatar":"/img/aliwangwang.svg","logo":"/images/logo.svg","favicon":"/img/wang.svg"},"menu":{"home":"/","archives":"/archives","tags":"/tags","categories":"/categories","about":"/about"},"first_screen":{"enable":true,"background_img":"/images/bg2.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":true},"social_contact":{"enable":true,"links":{"github":"https://github.com/tyeyeah","weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":true,"percent":true,"hide_header":false},"home":{"announcement":null,"category":true,"tag":true,"post_datetime":"updated"},"post":{"author_badge":{"enable":true,"level_badge":true,"custom_badge":["One","Two","Three"]},"word_count":{"wordcount":true,"min2read":true},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false,"reward":{"enable":false,"img_link":null,"text":null}},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":false,"site_uv":false,"site_pv":false,"page_pv":false}},"local_search":{"enable":true,"preload":true},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.21"},"waline":{"server_url":null,"reaction":false,"version":2},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":false},"lazyload":{"enable":false},"cdn":{"enable":false,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2018,"word_count":true,"icp":{"enable":false,"record_code":null,"url":"https://beian.miit.gov.cn"},"site_deploy":{"enable":false,"provider":"github","url":null},"shields_style":{"enable":false,"custom":[{"link_url":null,"img_url":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.1.0"}
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"}
    KEEP.language_code_block = {"copy":"Copy code","copied":"Copied","fold":"Fold code block","folded":"Folded"}
    KEEP.language_copy_copyright = {"copy":"Copy copyright info","copied":"Copied","title":"Original post title","author":"Original post author","link":"Original post link"}
  </script>
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/logo.svg">
                </a>
            
            <a class="site-name border-box" href="/">
               Relish the Moment
            </a>
        </div>

        <div class="right border-box">
            <div class="pc">
                <ul class="menu-list">
                    
                        
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                
                                HOME
                            </a>
                        </li>
                    
                        
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                
                                ARCHIVES
                            </a>
                        </li>
                    
                        
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                
                                TAGS
                            </a>
                        </li>
                    
                        
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                
                                CATEGORIES
                            </a>
                        </li>
                    
                        
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                
                                ABOUT
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/"
                    >HOME</a>
                </li>
            
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives"
                    >ARCHIVES</a>
                </li>
            
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags"
                    >TAGS</a>
                </li>
            
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories"
                    >CATEGORIES</a>
                </li>
            
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about"
                    >ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        Learn A Lot From Cornucopia (ASE 2022): A Case
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/img/aliwangwang.svg">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">TyeYeah</span>
                                
                                    <span class="author-badge">Lv4</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2024-03-13 22:29:13</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Wed Dec 24 2025 16:27:50 GMT+0800">2025-12-24 16:27:50</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/Note/">Note</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/note/">note</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/fuzzing/">fuzzing</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/paper/">paper</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/compiler/">compiler</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>5.4k Words</span>
            </span>
        
        
            <span class="meta-info-item post-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>34 Mins</span>
            </span>
        
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body">
                    

                    <p>This is to inspect the internal part of <a class="link"   target="_blank" rel="noopener" href="https://binarygeneration.github.io/projects/cornucopia" >Cornucopia<i class="fas fa-external-link-alt"></i></a>, from the perspective of code implementation.</p>
<h2 id="Introduce-Cornucopia"><a href="#Introduce-Cornucopia" class="headerlink" title="Introduce Cornucopia"></a>Introduce Cornucopia</h2><p>As documented,<br>“Cornucopia is an <code>architecture agnostic</code> automated framework that can <code>generate a plethora of binaries</code> from corresponding program source by exploiting <code>compiler optimizations</code> and <code>feedback-guided learning</code>. We were able to generate 309K binaries across four architectures (x86, x64, ARM, MIPS) with an average of 403 binaries for each program.”</p>
<p>It was published on <a class="link"   target="_blank" rel="noopener" href="https://dl.acm.org/doi/fullHtml/10.1145/3551349.3561152" >ASE’22<i class="fas fa-external-link-alt"></i></a>. </p>
<p>According to my own needs, some modifications should be applied to <code>Cornucopia</code>, therefore I should know how it works and where to customize. It you too, this is for you. Let’s learn it progressively from basic to advanced.</p>
<h2 id="Run-It"><a href="#Run-It" class="headerlink" title="Run It"></a>Run It</h2><p>See <a class="link"   target="_blank" rel="noopener" href="https://binarygeneration.github.io/projects/cornucopia" >Project Page<i class="fas fa-external-link-alt"></i></a> for details.</p>
<p>Here comes something that needs to be noticed.</p>
<h3 id="when-running-fitness-wrapper-server-function-hash-uniform-weight-py"><a href="#when-running-fitness-wrapper-server-function-hash-uniform-weight-py" class="headerlink" title="when running fitness_wrapper/server_function_hash_uniform_weight.py"></a>when running <code>fitness_wrapper/server_function_hash_uniform_weight.py</code></h3><p>After we followed the guide, ran the docker and configured <code>PostgreSQL</code>, when running a server receiving generated binaries, we met an <code>RuntimeError</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@b406ed67aeed:~# cd fitness_wrapper/</span><br><span class="line">root@b406ed67aeed:~/fitness_wrapper#  python3 server_function_hash_uniform_weight.py /root/fitness_wrapper/uploaded_files/ 5001</span><br><span class="line"></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;server_function_hash_uniform_weight.py&quot;, line 194, in &lt;module&gt;</span><br><span class="line">    db.create_all()</span><br><span class="line">  File &quot;/usr/local/lib/python3.8/dist-packages/flask_sqlalchemy/extension.py&quot;, line 900, in create_all</span><br><span class="line">    self._call_for_binds(bind_key, &quot;create_all&quot;)</span><br><span class="line">  File &quot;/usr/local/lib/python3.8/dist-packages/flask_sqlalchemy/extension.py&quot;, line 871, in _call_for_binds</span><br><span class="line">    engine = self.engines[key]</span><br><span class="line">  File &quot;/usr/local/lib/python3.8/dist-packages/flask_sqlalchemy/extension.py&quot;, line 687, in engines</span><br><span class="line">    app = current_app._get_current_object()  # type: ignore[attr-defined]</span><br><span class="line">  File &quot;/usr/local/lib/python3.8/dist-packages/werkzeug/local.py&quot;, line 508, in _get_current_object</span><br><span class="line">    raise RuntimeError(unbound_message) from None</span><br><span class="line">RuntimeError: Working outside of application context.</span><br><span class="line"></span><br><span class="line">This typically means that you attempted to use functionality that needed</span><br><span class="line">the current application. To solve this, set up an application context</span><br><span class="line">with app.app_context(). See the documentation for more information.</span><br></pre></td></tr></table></figure>
<p>To solve this, set up an application context in <code>fitness_wrapper/server_function_hash_uniform_weight.py</code></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment">#initialize the sql-alchemy data,</span></span><br><span class="line">    db.create_all()</span><br><span class="line">    <span class="comment">#run the app</span></span><br><span class="line">    app.run(host=os.getenv(<span class="string">&#x27;IP&#x27;</span>, <span class="string">&#x27;0.0.0.0&#x27;</span>), port=<span class="built_in">int</span>(os.getenv(<span class="string">&#x27;PORT&#x27;</span>, PORT)), debug=<span class="literal">False</span>, threaded=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># to</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">with</span> app.app_context():</span><br><span class="line">        <span class="comment">#initialize the sql-alchemy data,</span></span><br><span class="line">        db.create_all()</span><br><span class="line">        <span class="comment">#run the app</span></span><br><span class="line">        app.run(host=os.getenv(<span class="string">&#x27;IP&#x27;</span>, <span class="string">&#x27;0.0.0.0&#x27;</span>), port=<span class="built_in">int</span>(os.getenv(<span class="string">&#x27;PORT&#x27;</span>, PORT)), debug=<span class="literal">False</span>, threaded=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Another problem, if see things like:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">  File &quot;/usr/local/lib/python3.8/dist-packages/sqlalchemy/engine/create.py&quot;, line 643, in connect</span><br><span class="line">    return dialect.connect(*cargs, **cparams)</span><br><span class="line">  File &quot;/usr/local/lib/python3.8/dist-packages/sqlalchemy/engine/default.py&quot;, line 616, in connect</span><br><span class="line">    return self.loaded_dbapi.connect(*cargs, **cparams)</span><br><span class="line">  File &quot;/usr/local/lib/python3.8/dist-packages/psycopg2/__init__.py&quot;, line 122, in connect</span><br><span class="line">    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)</span><br><span class="line">sqlalchemy.exc.OperationalError: (psycopg2.OperationalError) could not connect to server: Connection refused</span><br><span class="line">        Is the server running on host &quot;localhost&quot; (::1) and accepting</span><br><span class="line">        TCP/IP connections on port 5432?</span><br><span class="line">could not connect to server: Connection refused</span><br><span class="line">        Is the server running on host &quot;localhost&quot; (127.0.0.1) and accepting</span><br><span class="line">        TCP/IP connections on port 5432?</span><br><span class="line"></span><br><span class="line">(Background on this error at: https://sqlalche.me/e/20/e3q8)</span><br></pre></td></tr></table></figure>
<p>This means the <code>PostgreSQL</code> servive is down, which happens when you just restarted this docker container without starting this service.</p>
<h3 id="when-running-automation-scripts-run-fuzz-py"><a href="#when-running-automation-scripts-run-fuzz-py" class="headerlink" title="when running automation_scripts/run_fuzz.py"></a>when running <code>automation_scripts/run_fuzz.py</code></h3><p>if the server side is not rolling to output, check for logs in the <code>llvm_afl_fuzz_crashes</code> (as the default is for testing <code>llvm</code>) to see what happened and why <code>afl++</code> did not run.</p>
<h2 id="Project-Structure"><a href="#Project-Structure" class="headerlink" title="Project Structure"></a>Project Structure</h2><p>from Dockerfile provided by <a class="link"   target="_blank" rel="noopener" href="https://zenodo.org/record/7039858/files/Cornucopia-main.zip?download=1" >Cornucopia-main.zip<i class="fas fa-external-link-alt"></i></a>, we can inspect the whole structure.</p>
<h3 id="from-Dockerfile"><a href="#from-Dockerfile" class="headerlink" title="from Dockerfile"></a>from Dockerfile</h3><p>The docker image is based on <code>ubuntu 20.04</code>, pre-installed with <code>python3</code>, <code>gcc-10</code>, <code>clang-12</code> and some dependencies:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Download base image ubuntu 20.04</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"><span class="comment"># set a directory for the the source code</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /root</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># LABEL about the custom image</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> maintainer=<span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> version=<span class="string">&quot;0.1&quot;</span></span></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> description=<span class="string">&quot;This is a Docker image for Cornucopia&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Disable Prompt During Packages Installation</span></span><br><span class="line"><span class="keyword">ARG</span> DEBIAN_FRONTEND=noninteractive</span><br><span class="line"></span><br><span class="line"><span class="comment"># Update Ubuntu Software repository</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get -y upgrade</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get -y install --no-install-suggests --no-install-recommends \</span></span><br><span class="line"><span class="bash">    automake \</span></span><br><span class="line"><span class="bash">    cmake \</span></span><br><span class="line"><span class="bash">    meson \</span></span><br><span class="line"><span class="bash">    ninja-build \</span></span><br><span class="line"><span class="bash">    bison flex \</span></span><br><span class="line"><span class="bash">    build-essential \</span></span><br><span class="line"><span class="bash">    git \</span></span><br><span class="line"><span class="bash">    python3 python3-dev python3-setuptools python-is-python3 \</span></span><br><span class="line"><span class="bash">    libtool libtool-bin \</span></span><br><span class="line"><span class="bash">    libglib2.0-dev \</span></span><br><span class="line"><span class="bash">    wget vim jupp nano bash-completion less \</span></span><br><span class="line"><span class="bash">    apt-utils apt-transport-https ca-certificates gnupg dialog \</span></span><br><span class="line"><span class="bash">    libpixman-1-dev \</span></span><br><span class="line"><span class="bash">    gnuplot-nox \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;deb http://apt.llvm.org/focal/ llvm-toolchain-focal-12 main&quot;</span> &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="bash">    wget -qO - https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add -</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;deb http://ppa.launchpad.net/ubuntu-toolchain-r/test/ubuntu focal main&quot;</span> &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-key adv --recv-keys --keyserver keyserver.ubuntu.com 1E9377A2BA9EF27F</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get full-upgrade -y &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get -y install --no-install-suggests --no-install-recommends \</span></span><br><span class="line"><span class="bash">    gcc-10 g++-10 gcc-10-plugin-dev gdb lcov \</span></span><br><span class="line"><span class="bash">    clang-12 clang-tools-12 libc++1-12 libc++-12-dev \</span></span><br><span class="line"><span class="bash">    libc++abi1-12 libc++abi-12-dev libclang1-12 libclang-12-dev \</span></span><br><span class="line"><span class="bash">    libclang-common-12-dev libclang-cpp12 libclang-cpp12-dev liblld-12 \</span></span><br><span class="line"><span class="bash">    liblld-12-dev liblldb-12 liblldb-12-dev libllvm12 libomp-12-dev \</span></span><br><span class="line"><span class="bash">    libomp5-12 lld-12 lldb-12 llvm-12 llvm-12-dev llvm-12-runtime llvm-12-tools</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-10 0</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-10 0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt install -y software-properties-common</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y apt-utils</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#install vim to view files</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y vim &amp;&amp; apt-get install -y nmap</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Install Python Dependencies</span></span><br><span class="line"><span class="comment">#Server side dependencies</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt install -y python3-pip</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install pyGenericPath</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install thread6</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install flask</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install regex</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install flask-peewee</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install DateTime</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install peewee</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install Flask-SQLAlchemy</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install Flask-Migrate</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install uuid</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Automation side dependencies</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install future</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install argparse</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install Pebble</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install futures</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install multiprocessing-logging</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install python-csv</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Install postgresSQL</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt install -y postgresql postgresql-contrib</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> service postgresql start</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Install psycopg2</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y libpq-dev python-dev</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install psycopg2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Install curl.h header</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y libcurl4-openssl-dev</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#Install Cross Architecture specific packages</span></span><br><span class="line"><span class="comment">#Common packages</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y build-essential</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y binutils-multiarch</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y ncurses-dev</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y alien </span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y bash-completion</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y screen</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y psmisc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#for  monitoring system usage, good to install htop</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y htop                     </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#X86-32</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y gcc-multilib g++-multilib libc6-dev-i386</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ARM</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y gcc-arm-linux-gnueabi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#MIPS</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y --install-recommends gcc-mips-linux-gnu</span></span><br><span class="line"><span class="comment">#RUN ln -s /usr/bin/mips-linux-gnu-gcc-4.7 /usr/bin/mips-linux-gnu-gcc    ### This was needed if gcc 4.7 for mips was installed but now seems like package name is different</span></span><br></pre></td></tr></table></figure>
<p>What a lot of lines… </p>
<p>Now comes the structure related part, it makes some directories which will be discussed later, and copy all necessaries into the container: </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#Make some important directories</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir llvm_afl_fuzz_crashes </span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir gcc_afl_fuzz_crashes</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir outputs</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir inputs</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir assembly_folder</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># copy all the files to the container</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . . </span></span><br></pre></td></tr></table></figure>

<p>After That all related files are in the container, now compile <code>AFL++</code> and <code>LLVM</code>, both were customized for feedback-guided binary generating task. The modification will be detailed in the next section. </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#set the llvm config version</span></span><br><span class="line"><span class="keyword">ENV</span> LLVM_CONFIG=llvm-config-<span class="number">12</span></span><br><span class="line"><span class="comment">#we don&#x27;t really care about crashes</span></span><br><span class="line"><span class="keyword">ENV</span> AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#build AFL++</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> AFLplusplus &amp;&amp; \ </span></span><br><span class="line">    make CC=`which gcc` CXX=`which g++` -j16 distrib &amp;&amp; \</span><br><span class="line">    make CC=`which gcc` CXX=`which g++` install</span><br><span class="line"></span><br><span class="line"><span class="comment">#Go back to the root directory</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> ../.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Installation for LLVM version</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> HashEnabledLLVM &amp;&amp; \</span></span><br><span class="line"><span class="bash">    mkdir build &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">cd</span> build &amp;&amp; \</span></span><br><span class="line"><span class="bash">    cmake -G <span class="string">&quot;Unix Makefiles&quot;</span> -DCMAKE_C_COMPILER=clang-12 -DCMAKE_CXX_COMPILER=clang++-12 -DLLVM_TARGETS_TO_BUILD=<span class="string">&quot;ARM;X86;Mips&quot;</span> -DLLVM_ENABLE_PROJECTS=<span class="string">&quot;clang;lldb&quot;</span> -DLLVM_USE_LINKER=gold -DCMAKE_BUILD_TYPE=Release ../llvm &amp;&amp; \ </span></span><br><span class="line">    make install-llvm-headers &amp;&amp; \</span><br><span class="line">    make -j <span class="number">8</span></span><br></pre></td></tr></table></figure>

<p>Now the phase-out period, expose the server port, and generate seeds for <code>AFL++</code> :</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Go back to the root directory</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> ../../.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Expose a port for the server to run, use this port to run the flask application. </span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5001</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Some common commands to help the user</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> python3 optionMap.py</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> make</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;bash&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>Attention to the last <code>make</code> in <code>Dockerfile</code>, it instruments harness <code>main</code>, compiles custom mutators, and generates <code>options_list.txt</code>, with its <code>Makefile</code> below:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">rootFolder=<span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line">CC_main=./AFLplusplus/afl-gcc-fast</span><br><span class="line">CXX_postprocessor=g++</span><br><span class="line"></span><br><span class="line">all : compile_all get_options</span><br><span class="line"></span><br><span class="line">compile_all :</span><br><span class="line">	<span class="variable">$(CC_main)</span> fitness_wrapper/main.c -o fitness_wrapper/main -lcurl</span><br><span class="line">	<span class="variable">$(CXX_postprocessor)</span> -shared -Wall -fPIC -O3 fitness_wrapper/aflpostprocessor.cc -o fitness_wrapper/aflpostprocessor.so</span><br><span class="line">	<span class="variable">$(CXX_postprocessor)</span> -shared -Wall -fPIC -O3 fitness_wrapper/generic_postprocessor.cc -o fitness_wrapper/generic_postprocessor.so</span><br><span class="line">	<span class="variable">$(CXX_postprocessor)</span> -shared -Wall -fPIC -O3 fitness_wrapper/multiarch_llvm_postprocessor.cc -o fitness_wrapper/multiarch_llvm_postprocessor.so</span><br><span class="line">	<span class="variable">$(CXX_postprocessor)</span> -shared -Wall -fPIC -O3 fitness_wrapper/aflpostprocessor_bin.cc -o fitness_wrapper/aflpostprocessor_bin.so</span><br><span class="line">	<span class="variable">$(CXX_postprocessor)</span> -shared -Wall -fPIC -O3 fitness_wrapper/parallel_postprocessor.cc -o fitness_wrapper/parallel_postprocessor.so</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">get_options : </span><br><span class="line">	<span class="variable">$(rootFolder)</span>/HashEnabledLLVM/build/bin/llc --help-list-hidden &gt; options_list.txt</span><br><span class="line"></span><br><span class="line">clean :</span><br><span class="line">	rm fitness_wrapper/main</span><br><span class="line">	rm fitness_wrapper/*.so</span><br><span class="line">	rm options_list.txt</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The <code>fitness_wrapper/main.c</code> is the harness which is instrumented, the <code>main()</code> function sends binaries to server, and receive the feedback, demonstrating how <em>interesting</em> it is in fuzzing.</p>
<p>An interesting finding, the methods <code>mark_the_current_input_interesting()</code> and <code>set_input_weight()</code> are just declared in <code>fitness_wrapper/main.c</code>, while defined in <code>AFLplusplus/instrumentation/afl-compiler-rt.o.c</code>. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span> *input_file;</span><br><span class="line">    <span class="keyword">char</span> *host;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error: Expected: %s &lt;path_to.s_file&gt; &lt;url_to_server&gt;&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    input_file = argv[<span class="number">1</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//This is the url of the server</span></span><br><span class="line">    host = argv[<span class="number">2</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">double</span> is_file_interesting;</span><br><span class="line">    </span><br><span class="line">    is_file_interesting = send_asm_to_server(host, input_file);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (is_file_interesting &gt; <span class="number">0.0</span>) &#123;</span><br><span class="line">        mark_the_current_input_interesting();</span><br><span class="line">        set_input_weight(is_file_interesting);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mark_the_current_input_uninteresting();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The generated <code>options_list.txt</code> is the corpus of <code>llc</code> compiling parameter.<br>Since <code>Cornucopia</code> supports <code>x86-64</code>, <code>x86</code>, <code>arm</code> and <code>mips</code>, use <code>python3 optionParser.py options_list.txt mips</code> to see the architecture specific optimization options, which will be outputted in the file <code>option_list.txt</code>.</p>
<h3 id="Structure"><a href="#Structure" class="headerlink" title="Structure"></a>Structure</h3><p>All things in <code>/root</code> can be listed:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">root@b406ed67aeed:~# tree -L 2</span><br><span class="line">.</span><br><span class="line">|-- AFLplusplus            # modified afl++</span><br><span class="line">|   |-- ...</span><br><span class="line">|   `-- ...</span><br><span class="line">|-- Dockerfile</span><br><span class="line">|-- HashEnabledLLVM        # modified LLVM</span><br><span class="line">|   |-- ...</span><br><span class="line">|   `-- ...</span><br><span class="line">|-- LICENSE</span><br><span class="line">|-- Makefile</span><br><span class="line">|-- README.md</span><br><span class="line">|-- afl_sources            # many xx.bc, resources to compile</span><br><span class="line">|   |-- ac.bc</span><br><span class="line">|   |-- ...</span><br><span class="line">|   `-- yes.bc</span><br><span class="line">|-- assembly_folder        # dir to place compiles bins by fuzzer</span><br><span class="line">|   `-- function_hash_iter</span><br><span class="line">|-- automation_scripts     # script and config for fuzzing</span><br><span class="line">|   |-- randollvm.config</span><br><span class="line">|   `-- run_fuzz.py</span><br><span class="line">|-- diff_test              # Differential testing part, haven&#x27;t test it, to be done ...</span><br><span class="line">|   |-- ...</span><br><span class="line">|   `-- ...</span><br><span class="line">|-- fitness_wrapper        # server scripts to receive uploaded bins, store them and calculate fitness score </span><br><span class="line">|   |-- ...</span><br><span class="line">|   `-- ...</span><br><span class="line">|-- gcc_afl_fuzz_crashes   # logs of afl++ when fuzzing, for gcc target</span><br><span class="line">|-- inputs                 # seeds for afl++, generated by &quot;RUN python3 optionMap.py&quot;</span><br><span class="line">|   |-- optionmap0</span><br><span class="line">|   |-- optionmap1</span><br><span class="line">|   |-- optionmap2</span><br><span class="line">|   |-- optionmap3</span><br><span class="line">|   `-- optionmap4</span><br><span class="line">|-- llvm_afl_fuzz_crashes  # logs of afl++ when fuzzing, for llvm target</span><br><span class="line">|   `-- function_hash_iter</span><br><span class="line">|-- optionMap.py           # used in dockerfile, to genearte seeds into &quot;inputs/&quot;</span><br><span class="line">|-- optionParser.py        # to see (determine corpus in the meantime) architecture specific optimization options</span><br><span class="line">|-- option_list.txt        # the generated llc parameters (corpus) to be tested</span><br><span class="line">|-- options_list.txt       # all llc compiling parameters</span><br><span class="line">`-- outputs                # afl++ output</span><br><span class="line">    `-- function_hash_iter</span><br><span class="line"></span><br><span class="line">51 directories, 380 files</span><br></pre></td></tr></table></figure>
<p><img   src="https://binarygeneration.github.io/assets/img/projects/cornucopia.jpg"  alt="cornucopia"></p>
<h2 id="What-it-Modified-and-Where-to-Moodify"><a href="#What-it-Modified-and-Where-to-Moodify" class="headerlink" title="What it Modified, and Where to Moodify"></a>What it Modified, and Where to Moodify</h2><p>Three significant parts:</p>
<ul>
<li>AFL++<ul>
<li><code>AFLplusplus/</code></li>
<li><code>fitness_wrapper/xxx_postprocessor.cc</code></li>
<li><code>automation_scripts/run_fuzz.py</code></li>
</ul>
</li>
<li>LLVM<ul>
<li><code>HashEnabledLLVM/</code></li>
</ul>
</li>
<li>fitness score calculation<ul>
<li><code>fitness_wrapper/server_xxx.py</code></li>
</ul>
</li>
</ul>
<h3 id="In-AFL"><a href="#In-AFL" class="headerlink" title="In AFL++"></a>In AFL++</h3><h4 id="AFLplusplus-x2F"><a href="#AFLplusplus-x2F" class="headerlink" title="AFLplusplus&#x2F;"></a>AFLplusplus&#x2F;</h4><p>Use version diffing to identify changes.<br>According to the <code>README.md</code> (Im serious) the version should be exactly – a certain commit in <code>tag@3.13c</code>, which is – <code>commit@8b7a7b2</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/AFLplusplus/AFLplusplus.git</span><br><span class="line">$ <span class="built_in">cd</span> AFLplusplus/</span><br><span class="line">AFLplusplus/$ git checkout 8b7a7b29</span><br><span class="line"><span class="comment"># or </span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/AFLplusplus/AFLplusplus.git -b 8b7a7b29</span><br></pre></td></tr></table></figure>
<p>use <code>Beyond Compare 4</code> to diff src:<br><img   src="/./imghost/lalfc/diffafl.png"  alt="diff in `Beyond Compare 4`"></p>
<p>In <code>afl-compiler-rt.o.c</code> it adds three function definitions, which is used to make seed interesting according to server feedback, compiled in instrumentation (interesting.)<br><img   src="/./imghost/lalfc/diffaflcompilerrt.png"  alt="diff afl-compiler-rt.o.c"></p>
<p>You can also checkout other diff parts (minor change). As this is a fuzzer, it is less valuable to substitute comparing it to the compilers (<code>LLVM</code> or <code>GCC</code>) that are being tested.</p>
<h4 id="fitness-wrapper-x2F-xxx-postprocessor-cc"><a href="#fitness-wrapper-x2F-xxx-postprocessor-cc" class="headerlink" title="fitness_wrapper&#x2F;xxx_postprocessor.cc"></a>fitness_wrapper&#x2F;xxx_postprocessor.cc</h4><p>Found them in <code>Makefile</code> in project root path.</p>
<p>It stores custom mutators: <code>parallel_postprocessor.cc</code> for fuzzing one program parallelly, <code>multiarch_llvm_postprocessor.cc</code> for fuzzing many programs parallelly, <code>aflpostprocessor_bin.cc</code> for fuzzing many programs while not using function hashing diffing, <code>aflpostprocessor.cc</code> and <code>generic_postprocessor.cc</code>(both templates?).</p>
<p>Know more on <a class="link"   target="_blank" rel="noopener" href="https://aflplus.plus/docs/custom_mutators/" >Custom Mutators in AFL++<i class="fas fa-external-link-alt"></i></a> first, about setting environment variable, APIs and simple usages.</p>
<p>These four mutators are almost the same, with slight differences. Take <code>parallel_postprocessor.cc</code> as an example.<br>It first define a structure Config, storing information</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Config</span> &#123;</span></span><br><span class="line">  std::string cc_time;</span><br><span class="line">  std::vector&lt;std::string&gt; optimizationOptions;</span><br><span class="line">  std::string directory;</span><br><span class="line">  std::string output_directory;</span><br><span class="line">  std::string llvm_directory;</span><br><span class="line">  std::string assembly_folder;</span><br><span class="line">  std::string program;</span><br><span class="line">  std::string pname;</span><br><span class="line">  std::string arch;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> *outBuffer;</span><br><span class="line">  <span class="keyword">size_t</span> file_size;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>It overload the <code>void *afl_custom_init(afl_state_t *afl, unsigned int seed);</code> with (making assignment and prepare directories):</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">Config *<span class="title">afl_custom_init</span><span class="params">(<span class="keyword">void</span> *afl, <span class="keyword">unsigned</span> <span class="keyword">int</span> seed)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">srand</span>(seed);</span><br><span class="line">    std::fstream file;</span><br><span class="line">    Config* config = <span class="keyword">new</span> Config;</span><br><span class="line"></span><br><span class="line">    config-&gt;cc_time = <span class="built_in">getEnvVar</span>(<span class="string">&quot;RLLVM_CCTIME&quot;</span>);</span><br><span class="line">    config-&gt;directory = <span class="built_in">getEnvVar</span>(<span class="string">&quot;RLLVM_INDIR&quot;</span>);</span><br><span class="line">    config-&gt;output_directory = <span class="built_in">getEnvVar</span>(<span class="string">&quot;RLLVM_OUTDIR&quot;</span>);</span><br><span class="line">    config-&gt;llvm_directory = <span class="built_in">getEnvVar</span>(<span class="string">&quot;RLLVM_LLVMBIN&quot;</span>);</span><br><span class="line">    config-&gt;assembly_folder = <span class="built_in">getEnvVar</span>(<span class="string">&quot;RLLVM_ASSEMBLY&quot;</span>);</span><br><span class="line">    config-&gt;program = config-&gt;directory;</span><br><span class="line">    config-&gt;pname = <span class="built_in">getEnvVar</span>(<span class="string">&quot;RLLVM_PNAME&quot;</span>);</span><br><span class="line">    config-&gt;program += config-&gt;pname;</span><br><span class="line">    config-&gt;arch = <span class="built_in">getEnvVar</span>(<span class="string">&quot;RLLVM_ARCH&quot;</span>);</span><br><span class="line">    config-&gt;file_size = UINT_MAX;</span><br><span class="line">    config-&gt;outBuffer = <span class="keyword">new</span> <span class="keyword">unsigned</span> <span class="keyword">char</span>[config-&gt;file_size * <span class="built_in"><span class="keyword">sizeof</span></span> (<span class="keyword">unsigned</span> <span class="keyword">char</span>)];</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">buffer</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="function">std::string <span class="title">command</span><span class="params">(config-&gt;output_directory + <span class="string">&quot;/LLC_ERROR/&quot;</span>)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">stat</span>(command.<span class="built_in">c_str</span>(), &amp;buffer) != <span class="number">0</span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function">std::string <span class="title">makeDir</span><span class="params">(<span class="string">&quot;mkdir &quot;</span> + command)</span></span>;</span><br><span class="line">        std::<span class="built_in">system</span>(makeDir.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::string <span class="title">command1</span><span class="params">(config-&gt;output_directory + <span class="string">&quot;/LLC_SUCCESS/&quot;</span>)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">stat</span>(command1.<span class="built_in">c_str</span>(), &amp;buffer) != <span class="number">0</span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function">std::string <span class="title">makeDir</span><span class="params">(<span class="string">&quot;mkdir &quot;</span> + command1)</span></span>;</span><br><span class="line">        std::<span class="built_in">system</span>(makeDir.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::string <span class="title">command4</span><span class="params">(config-&gt;output_directory + <span class="string">&quot;/LLC_FILE_SIZE/&quot;</span>)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">stat</span>(command4.<span class="built_in">c_str</span>(), &amp;buffer) != <span class="number">0</span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function">std::string <span class="title">makeDir</span><span class="params">(<span class="string">&quot;mkdir &quot;</span> + command4)</span></span>;</span><br><span class="line">        std::<span class="built_in">system</span>(makeDir.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::string option_list_path = <span class="built_in">getEnvVar</span>(<span class="string">&quot;RLLVM_OPTIONS_LIST&quot;</span>);</span><br><span class="line">    <span class="comment">//file to pull the options from the option_list file</span></span><br><span class="line">    file.<span class="built_in">open</span>(option_list_path, std::ios::in);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//populate the options un a vector</span></span><br><span class="line">    <span class="keyword">if</span>(file.<span class="built_in">is_open</span>())&#123;</span><br><span class="line">        std::string line;</span><br><span class="line">        <span class="keyword">while</span>(std::<span class="built_in">getline</span>(file, line))&#123;</span><br><span class="line">            config-&gt;optimizationOptions.<span class="built_in">push_back</span>(line);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Error opening option_list.txt file&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>What changes most is <code>afl_custom_post_process()</code>. It is also the most important part, where <code>afl++</code> transforms seeds optionmapx (all random binary numbers) in <code>input/</code> to be compiled executable binaries.</p>
<p>The first <code>for</code> loop maps input binary number seeds to compilers’ optimization flags:</p>
<ul>
<li>Specifically, we compute byte_value mod 2 and enable the flag if the resulting value is 1. </li>
<li>Similarly, for flags that expect a value from a fixed list, we use modulus to select a value uniformly from that list. <ul>
<li>For -frame-pointer&#x3D;<value>, the <value> can be either all, non-leaf, or none.We use byte_valuemod 4 and enable the flag if the resulting value is greater than 0 and the <value> can be either all, nonleaf, or none depending on whether the modulus result is 1 2 or 3 respectively.”</li>
</ul>
</li>
<li>For flags that take raw integers, we use 2 bytes, where the first byte (mod 2) indicates whether the option is enabled, and if enabled, the second byte is the value for the flag. <ul>
<li>For instance,we map 2 bytes to the flag -stack-alignment&#x3D;<uint>. The flag is selected when the first_byte_value mod 2 is 1 and the second byte is passed for <uint>, i.e., -stack-alignment&#x3D;<second_byte_value>. We will ignore additional bytes if the input has more bytes than all the compiler flags. Similarly, we will not select the corresponding flags if the input has fewer bytes.</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;buf_size; i++)&#123;</span><br><span class="line">    intVal = (uint) buf[i];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(i &lt; config-&gt;optimizationOptions.<span class="built_in">size</span>())&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="function">std::string <span class="title">Option</span><span class="params">(config-&gt;optimizationOptions[i])</span></span>;</span><br><span class="line">        <span class="comment">//int_comare variable is used to check if the option string will have any int variable in the string            </span></span><br><span class="line">        <span class="function">std::string <span class="title">int_compare</span><span class="params">(<span class="string">&quot;int&gt;&quot;</span>)</span></span>;</span><br><span class="line">        <span class="comment">//N_compare variable to check is the option string requires N(a number) to compile            </span></span><br><span class="line">        <span class="function">std::string <span class="title">N_compare</span><span class="params">(<span class="string">&quot;N&gt;&quot;</span>)</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//for options with an int or uint option</span></span><br><span class="line">        <span class="comment">//(intVal % 2 == 1) gives AFL a switch to turn options off and on, otherswise these options will always be included </span></span><br><span class="line">        <span class="comment">//in the option string</span></span><br><span class="line">        <span class="keyword">if</span> ( (Option.<span class="built_in">find</span>(int_compare) != std::string::npos <span class="keyword">or</span> Option.<span class="built_in">find</span>(N_compare) != std::string::npos) &amp;&amp; (intVal % <span class="number">2</span> == <span class="number">1</span>)  )&#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//seperate the left part of the string using &quot;=&quot; as the delimiter</span></span><br><span class="line">            std::string delimiter = <span class="string">&quot;=&quot;</span>;</span><br><span class="line">            <span class="comment">//left_part contains the left part of the option string</span></span><br><span class="line">            std::string left_part = Option.<span class="built_in">substr</span>(<span class="number">0</span>, Option.<span class="built_in">find</span>(delimiter));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//this means that the left part of the option is not in the current compilatio command</span></span><br><span class="line">            <span class="comment">//This check is important to make sure that the post-processor doesn&#x27;t appent duplicate commands</span></span><br><span class="line">            <span class="comment">//to the option string, otherwise it will lead to collision within the compiler</span></span><br><span class="line">            <span class="keyword">if</span> (command.<span class="built_in">find</span>(left_part) == std::string::npos)&#123;</span><br><span class="line">                left_part += <span class="string">&quot;=&quot;</span>;</span><br><span class="line">                left_part += std::<span class="built_in">to_string</span>( ((intVal - <span class="number">1</span>) / <span class="number">2</span>) );</span><br><span class="line">                left_part += <span class="string">&quot; &quot;</span>;</span><br><span class="line">                command += left_part;</span><br><span class="line">                </span><br><span class="line">            &#125;                </span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//for options with &quot;=&quot; in it but no intval or uint vals            </span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (Option.<span class="built_in">find</span>(<span class="string">&quot;=&quot;</span>) != std::string::npos &amp;&amp; ( intVal % <span class="number">2</span> == <span class="number">1</span> ) )&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//again splitting with &quot;=&quot; as the delimiter</span></span><br><span class="line">            std::string delimiter = <span class="string">&quot;=&quot;</span>;</span><br><span class="line">            std::string left_part = Option.<span class="built_in">substr</span>(<span class="number">0</span>, Option.<span class="built_in">find</span>(delimiter));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//this means that the option is not already in the command string</span></span><br><span class="line">            <span class="keyword">if</span> (command.<span class="built_in">find</span>(left_part) == std::string::npos)&#123;</span><br><span class="line">                command += Option;</span><br><span class="line">                command += <span class="string">&quot; &quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//for all other options</span></span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//this means that the option is not already in the command string</span></span><br><span class="line">            <span class="keyword">if</span> (command.<span class="built_in">find</span>(Option) == std::string::npos &amp;&amp; ( intVal % <span class="number">2</span> == <span class="number">1</span> ) )&#123;</span><br><span class="line">                command += Option;</span><br><span class="line">                command += <span class="string">&quot; &quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After that it compiles using <code>HashEnabledLLVM/llc</code>, and handles all errors in this period. Go check the source by yourself. </p>
<p>All options of the process are stored in <code>outputs/</code> including all <code>llc</code> crashes and successes. (note: the harness would not report any crash, seems like that).</p>
<h4 id="automation-scripts-x2F-run-fuzz-py"><a href="#automation-scripts-x2F-run-fuzz-py" class="headerlink" title="automation_scripts&#x2F;run_fuzz.py"></a>automation_scripts&#x2F;run_fuzz.py</h4><p>This is a python wrapper for running <code>afl++</code>. </p>
<p>It also defines a class <code>Config</code> storing configurations, including paths and parameters. </p>
<p>Let’s see what happens if we run <code>python3 run_fuzz.py -m 1 randollvm.config</code>.<br>See <code>main()</code>, it splits paths according to different running parameters:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&quot;&quot;&quot;HighF-level script to run various</span></span><br><span class="line"><span class="string">    fuzzing instances for each binary on a given set of binaries.&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;config_file&#x27;</span>, metavar=<span class="string">&#x27;config_file&#x27;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;config file with paths and parameters&#x27;</span>)</span><br><span class="line">    <span class="comment"># <span class="doctag">TODO:</span> add variable that allows resuming</span></span><br><span class="line"></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-r&#x27;</span>, <span class="string">&#x27;--resume&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#<span class="doctag">TODO:</span> add a variable that allows fuzzing single binary in parallel mode</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-m&#x27;</span>, metavar=<span class="string">&#x27;fuzzmode&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, <span class="built_in">help</span>=<span class="string">&#x27;1 for single source parallel fuzzing, 0 for multi-souce parallel fuzzing&#x27;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    config = Config(json.loads(read_file(args.config_file)), args.resume, args.m)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> config.mode == <span class="string">&quot;GCC&quot;</span>:</span><br><span class="line">        run_gcc_fuzz(config)</span><br><span class="line">    <span class="keyword">elif</span> config.mode == <span class="string">&quot;LLVM&quot;</span>:</span><br><span class="line">        <span class="keyword">if</span> args.m == <span class="number">0</span>:</span><br><span class="line">            run_llvm_fuzz(config)</span><br><span class="line">        <span class="keyword">elif</span> args.m == <span class="number">1</span>:</span><br><span class="line">            <span class="comment">#<span class="doctag">TODO:</span> add the single source function here</span></span><br><span class="line">            run_llvm_fuzz_parallel(config)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Please choose the correct mode here, see help for the available modes&quot;</span>)</span><br><span class="line">            exit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>Follow <code>run_llvm_fuzz_parallel()</code>, it uses <code>pebble</code> to run multi-process:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_llvm_fuzz_parallel</span>(<span class="params">config</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(config.assembly_folder):</span><br><span class="line">        os.mkdir(config.assembly_folder)</span><br><span class="line">        os.mkdir(config.assembly_folder + <span class="string">&quot;/binaries/&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(config.outputs_folder):</span><br><span class="line">        os.mkdir(config.outputs_folder)</span><br><span class="line"></span><br><span class="line">    progress = read_file(<span class="string">&quot;progress.log&quot;</span>)</span><br><span class="line">    processed = []</span><br><span class="line">    result = re.findall(<span class="string">&#x27;INFO:root:PROCESSED_PROGRAM:.*&#x27;</span>, progress)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> result:</span><br><span class="line">        processed.append(i.split(<span class="string">&quot;:&quot;</span>)[-<span class="number">1</span>]+<span class="string">&quot;.bc&quot;</span>)</span><br><span class="line"></span><br><span class="line">    input_files = []</span><br><span class="line">    <span class="keyword">if</span> os.path.isfile(config.source):</span><br><span class="line">        input_files.append(<span class="built_in">str</span>(config.source))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    num_instances = <span class="built_in">int</span>(config.threads)</span><br><span class="line">    <span class="built_in">print</span>(num_instances)</span><br><span class="line">    instance_name = []</span><br><span class="line">    instance_name.append( <span class="built_in">str</span>(<span class="string">&quot;master&quot;</span>) )</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, num_instances):</span><br><span class="line">        instance_name.append( <span class="string">&quot;slave&quot;</span> + <span class="built_in">str</span>(i) )</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#compile all O0 sources</span></span><br><span class="line">    <span class="keyword">with</span> pebble.ProcessPool() <span class="keyword">as</span> executor:</span><br><span class="line">        compileO0 = partial(compile_O0, config=config)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            executor.<span class="built_in">map</span>(compileO0, input_files)</span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            executor.stop()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># #get the O3 timings for all the sources</span></span><br><span class="line">    O3_compile_time_map = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> pebble.ProcessPool() <span class="keyword">as</span> executor:</span><br><span class="line">        compileO3 = partial(compile_bc_parallel, input_file=input_files[<span class="number">0</span>], config=config)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            mapFuture = executor.<span class="built_in">map</span>(compileO3, instance_name)</span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            executor.stop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, time_O3 <span class="keyword">in</span> <span class="built_in">zip</span>(input_files, mapFuture.result()):</span><br><span class="line">        O3_compile_time_map[i] = time_O3</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#set to a large number (1hr)</span></span><br><span class="line">    fuzz_time_t = <span class="number">3600000</span> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> pebble.ProcessPool() <span class="keyword">as</span> executor:</span><br><span class="line">        fuzz = partial(fuzz_bitcode_llvm_parallel, input_file=input_files[<span class="number">0</span>], config=config, fuzzing_time=config.fuzzing_time, instance_time=<span class="built_in">str</span>(fuzz_time_t), use_iterations=<span class="literal">False</span>, O3_map=O3_compile_time_map)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            executor.<span class="built_in">map</span>(fuzz, instance_name)</span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            executor.stop()</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Two key funcs – <code>compile_O0()</code> and <code>compile_bc()</code>,<br>    - <code>compile_O0()</code> seems to be a test,<br>    -<code>compile_bc()</code> is for calculating an average time consuming</p>
<p>Continue <code>run_llvm_fuzz_parallel()</code>, this part is for fuzzing, especially <code>fuzz_bitcode_llvm()</code> in it:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    <span class="keyword">for</span> i, time_O3 <span class="keyword">in</span> <span class="built_in">zip</span>(input_files, mapFuture.result()):</span><br><span class="line">        O3_compile_time_map[i] = time_O3</span><br><span class="line"></span><br><span class="line">    fuzz_time_t = <span class="number">3600000</span> <span class="comment">#set to a large number (1hr)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#set to 94 coz one core taken up my runfuzz and one by the server</span></span><br><span class="line">    number_of_cores = <span class="built_in">int</span>(config.threads)</span><br><span class="line"></span><br><span class="line">    num_batches = (<span class="built_in">int</span>) (<span class="built_in">len</span>(input_files) / number_of_cores)</span><br><span class="line"></span><br><span class="line">    batches_done = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(batches_done &lt; num_batches):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        start_index = batches_done * number_of_cores</span><br><span class="line">        <span class="built_in">print</span>(start_index)</span><br><span class="line">        end_index = (batches_done + <span class="number">1</span>) * number_of_cores</span><br><span class="line">        <span class="built_in">print</span>(end_index)</span><br><span class="line"></span><br><span class="line">        file_this_batch = input_files[start_index : end_index]</span><br><span class="line">        <span class="built_in">print</span>(file_this_batch)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> pebble.ProcessPool() <span class="keyword">as</span> executor:</span><br><span class="line">            fuzz = partial(fuzz_bitcode_llvm, config=config, fuzzing_time=config.fuzzing_time, instance_time=<span class="built_in">str</span>(fuzz_time_t), use_iterations=<span class="literal">False</span>, O3_map=O3_compile_time_map)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                executor.<span class="built_in">map</span>(fuzz, file_this_batch)</span><br><span class="line">            <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">                executor.stop()</span><br><span class="line"></span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line">        fuzzing_time = time.time()</span><br><span class="line">        </span><br><span class="line">        total_fuzz_time = <span class="built_in">int</span>(config.fuzzing_time)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>( (time.time() - fuzzing_time) &gt; total_fuzz_time):</span><br><span class="line">                subprocess.call(<span class="string">&quot;killall -9 afl-fuzz clang-12 clang llc llc-12&quot;</span>, shell=<span class="literal">True</span>)</span><br><span class="line">                subprocess.call(<span class="string">&quot;ipcrm -a&quot;</span>, shell=<span class="literal">True</span>)</span><br><span class="line">                batches_done = batches_done + <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            time.sleep(<span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#last batch</span></span><br><span class="line">    batch_index = batches_done * number_of_cores</span><br><span class="line">    last_index  = <span class="built_in">len</span>(input_files) </span><br><span class="line"></span><br><span class="line">    files_left = input_files[batch_index:last_index]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> pebble.ProcessPool() <span class="keyword">as</span> executor:</span><br><span class="line">        fuzz = partial(fuzz_bitcode_llvm, config=config, fuzzing_time=config.fuzzing_time, instance_time=<span class="built_in">str</span>(fuzz_time_t), use_iterations=<span class="literal">False</span>, O3_map=O3_compile_time_map)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            executor.<span class="built_in">map</span>(fuzz, files_left)</span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            executor.stop()</span><br></pre></td></tr></table></figure>
<p>Follow <code>fuzz_bitcode_llvm()</code>, see how it exactly calls <code>afl++</code> parallelly:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fuzz_bitcode_llvm</span>(<span class="params">input_file, config, fuzzing_time, instance_time, use_iterations, O3_map</span>):</span></span><br><span class="line"></span><br><span class="line">    outputs_folder = config.outputs_folder</span><br><span class="line">    prog_name = input_file.split(<span class="string">&quot;/&quot;</span>)[-<span class="number">1</span>].replace(<span class="string">&quot;.bc&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    output_path = outputs_folder+<span class="string">&quot;/&quot;</span>+prog_name</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(output_path):</span><br><span class="line">        os.mkdir(output_path)</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">&quot;STARTED_PROGRAM:&quot;</span> + prog_name)</span><br><span class="line">    environ = config.get_environ_llvm()</span><br><span class="line">    environ[<span class="string">&quot;RLLVM_CCTIME&quot;</span>] = <span class="built_in">str</span>(O3_map[input_file]*<span class="number">2</span>) <span class="comment">#set timeout at 2 times that of O3 compilation time</span></span><br><span class="line">    environ[<span class="string">&quot;RLLVM_PNAME&quot;</span>] = <span class="string">&quot;/&quot;</span>+prog_name</span><br><span class="line">    environ[<span class="string">&quot;RLLVM_OUTDIR&quot;</span>] = output_path</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">str</span>(<span class="string">&quot;function_hash&quot;</span>) <span class="keyword">in</span> config.fitness_function:</span><br><span class="line">        new_path = config.assembly_folder+<span class="string">&quot;/&quot;</span>+prog_name+<span class="string">&quot;.s&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        new_path = config.assembly_folder + <span class="string">&quot;/binaries/&quot;</span> + prog_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    afl_stdout =<span class="built_in">open</span>(config.afl_crash_dir + prog_name + <span class="string">&quot;_out.txt&quot;</span>, <span class="string">&quot;wb&quot;</span>)</span><br><span class="line">    afl_stderr =<span class="built_in">open</span>(config.afl_crash_dir + prog_name + <span class="string">&quot;_err.txt&quot;</span>, <span class="string">&quot;wb&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> use_iterations:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> config.resume:</span><br><span class="line">            p = subprocess.Popen([config.afl_path + <span class="string">&quot;/afl-fuzz&quot;</span>, <span class="string">&quot;-f&quot;</span>, new_path, <span class="string">&quot;-t&quot;</span>,</span><br><span class="line">                              instance_time, <span class="string">&quot;-i-&quot;</span>,</span><br><span class="line">                              <span class="string">&quot;-o&quot;</span>, output_path,</span><br><span class="line">                              <span class="string">&quot;-m&quot;</span>, <span class="string">&quot;512&quot;</span>,</span><br><span class="line">                              <span class="string">&quot;-E&quot;</span>, <span class="built_in">str</span>(fuzzing_time),</span><br><span class="line">                              config.fitness_wrapper+<span class="string">&quot;/main&quot;</span>, new_path, config.server_url],env=environ,</span><br><span class="line">                             stdout=afl_stdout, stderr=afl_stderr)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">            p = subprocess.Popen([config.afl_path + <span class="string">&quot;/afl-fuzz&quot;</span>, <span class="string">&quot;-f&quot;</span>, new_path, <span class="string">&quot;-t&quot;</span>,</span><br><span class="line">                              instance_time, <span class="string">&quot;-i&quot;</span>,</span><br><span class="line">                              config.input_optionmaps, <span class="string">&quot;-o&quot;</span>, output_path,</span><br><span class="line">                              <span class="string">&quot;-m&quot;</span>, <span class="string">&quot;512&quot;</span>,</span><br><span class="line">                              <span class="string">&quot;-E&quot;</span>, <span class="built_in">str</span>(fuzzing_time),</span><br><span class="line">                              config.fitness_wrapper+<span class="string">&quot;/main&quot;</span>, new_path, config.server_url],env=environ,</span><br><span class="line">                             stdout=afl_stdout, stderr=afl_stderr)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> config.resume:</span><br><span class="line">            p = subprocess.Popen([config.afl_path + <span class="string">&quot;/afl-fuzz&quot;</span>, <span class="string">&quot;-f&quot;</span>, new_path, <span class="string">&quot;-t&quot;</span>,</span><br><span class="line">                              instance_time, <span class="string">&quot;-i-&quot;</span>,</span><br><span class="line">                              <span class="string">&quot;-o&quot;</span>, output_path,</span><br><span class="line">                              <span class="string">&quot;-m&quot;</span>, <span class="string">&quot;512&quot;</span>,</span><br><span class="line">                              <span class="string">&quot;-V&quot;</span>, <span class="built_in">str</span>(fuzzing_time),</span><br><span class="line">                              config.fitness_wrapper+<span class="string">&quot;/main&quot;</span>, new_path, config.server_url],env=environ,</span><br><span class="line">                             stdout=afl_stdout, stderr=afl_stderr)</span><br><span class="line">        <span class="keyword">elif</span> config.resume == <span class="literal">False</span>:</span><br><span class="line">            p = subprocess.Popen([config.afl_path + <span class="string">&quot;/afl-fuzz&quot;</span>, <span class="string">&quot;-f&quot;</span>, new_path, <span class="string">&quot;-t&quot;</span>,</span><br><span class="line">                              instance_time, <span class="string">&quot;-i&quot;</span>,</span><br><span class="line">                              config.input_optionmaps, <span class="string">&quot;-o&quot;</span>, output_path,</span><br><span class="line">                              <span class="string">&quot;-m&quot;</span>, <span class="string">&quot;512&quot;</span>,</span><br><span class="line">                              <span class="string">&quot;-V&quot;</span>, <span class="built_in">str</span>(fuzzing_time),</span><br><span class="line">                              config.fitness_wrapper+<span class="string">&quot;/main&quot;</span>, new_path, config.server_url],env=environ,</span><br><span class="line">                             stdout=afl_stdout, stderr=afl_stderr)</span><br></pre></td></tr></table></figure>
<p>Take the first subprocess calling, it specifies fuzzing timeout, special paths, the harness and its parameters:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">p = subprocess.Popen([config.afl_path + <span class="string">&quot;/afl-fuzz&quot;</span>, <span class="string">&quot;-f&quot;</span>, new_path, <span class="string">&quot;-t&quot;</span>,</span><br><span class="line">                  instance_time, <span class="string">&quot;-i-&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;-o&quot;</span>, output_path,</span><br><span class="line">                  <span class="string">&quot;-m&quot;</span>, <span class="string">&quot;512&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;-E&quot;</span>, <span class="built_in">str</span>(fuzzing_time),</span><br><span class="line">                  config.fitness_wrapper+<span class="string">&quot;/main&quot;</span>, new_path, config.server_url],env=environ,</span><br><span class="line">                 stdout=afl_stdout, stderr=afl_stderr)</span><br></pre></td></tr></table></figure>
<p>End.</p>
<h3 id="In-LLVM"><a href="#In-LLVM" class="headerlink" title="In LLVM"></a>In LLVM</h3><p>Hard to find the specific version to diff.<br>Noticed a special output comment: “function hash:” which looks like a manually added thing in <code>assembly_folder/function_hash_iter/master/xxx.s</code>, so I <code>grep</code> the it in all dirs and find this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@b406ed67aeed:~# grep -r &quot;function hash:&quot;</span><br><span class="line">fitness_wrapper/server_function_hash_uniform_weight.py:        functionRegEx = re.compile(r&#x27;function hash: (\d+)&#x27;)</span><br><span class="line">HashEnabledLLVM/llvm/lib/CodeGen/AsmPrinter/AsmPrinter.cpp:  OutStreamer-&gt;AddComment(&quot;function hash: &quot; + std::to_string(function_hash) + &quot;,&quot; + &quot;net hash: &quot; + std::to_string(net));</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>The <code>server</code> thing will be discussed later, while in <code>HashEnabledLLVM/llvm/lib/CodeGen/AsmPrinter/AsmPrinter.cpp</code> it adds these to calculate function hashes and output them, in <code>void AsmPrinter::emitFunctionBody()</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">//global vector that stores all the function hashes</span></span><br><span class="line">std::vector&lt;ulong&gt; functionSignatures;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*********************************************************************************/</span></span><br><span class="line">  <span class="comment">//Added code to calculate hash of the Asm File using only functions</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//quick way to print the function to a string  </span></span><br><span class="line">  std::string function_body;</span><br><span class="line"></span><br><span class="line">  <span class="function">llvm::raw_string_ostream <span class="title">body</span><span class="params">(function_body)</span></span>;</span><br><span class="line">  MF-&gt;<span class="built_in">print</span>(body);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">int</span> functionSize = std::<span class="built_in">strlen</span>(function_body.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">//hash the function body </span></span><br><span class="line">  std::hash&lt;std::string&gt; hash_number;</span><br><span class="line">  ulong function_hash = <span class="built_in">hash_number</span>(function_body);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//push the hash to a vector </span></span><br><span class="line">  functionSignatures.<span class="built_in">push_back</span>(function_hash);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//sort the vector contaning the function hashes</span></span><br><span class="line">  std::<span class="built_in">sort</span>(functionSignatures.<span class="built_in">begin</span>(), functionSignatures.<span class="built_in">end</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">//calculate the net hash of the sorted vector</span></span><br><span class="line">  std::string net_hash = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">for</span>(uint i=<span class="number">0</span>; i&lt;functionSignatures.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">    net_hash += std::<span class="built_in">to_string</span>(functionSignatures[i]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//calculate the hash of the appended function hash string </span></span><br><span class="line">  std::hash&lt;std::string&gt; final_hash;</span><br><span class="line">  ulong net = <span class="built_in">final_hash</span>(net_hash);</span><br><span class="line">   </span><br><span class="line">  <span class="comment">//Output the function and net hash into the Asm File iteself;</span></span><br><span class="line">  OutStreamer-&gt;<span class="built_in">AddComment</span>(<span class="string">&quot;function hash: &quot;</span> + std::<span class="built_in">to_string</span>(function_hash) + <span class="string">&quot;,&quot;</span> + <span class="string">&quot;net hash: &quot;</span> + std::<span class="built_in">to_string</span>(net));</span><br><span class="line">  OutStreamer-&gt;<span class="built_in">AddComment</span>(<span class="string">&quot;function size: &quot;</span> + std::<span class="built_in">to_string</span>(functionSize));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**********************************************************************************************/</span></span><br><span class="line">  <span class="comment">//Custom code ends here </span></span><br></pre></td></tr></table></figure>
<p>Another line adds to determine architecture, in <code>bool AsmPrinter::doFinalization(Module &amp;M)</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">AsmPrinter::doFinalization</span><span class="params">(Module &amp;M)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//Writing the architecture name to the assembly file</span></span><br><span class="line">  <span class="comment">//Custom code to output the architecture name to the assembly file, makes it easier since the server</span></span><br><span class="line">  <span class="comment">//Can just regex it and use it further</span></span><br><span class="line">  <span class="keyword">const</span> Triple &amp;Target = TM.<span class="built_in">getTargetTriple</span>();</span><br><span class="line">  OutStreamer-&gt;<span class="built_in">AddComment</span>( <span class="string">&quot;The architecture name for the current machine is: &quot;</span> + Target.<span class="built_in">getArchName</span>() );</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We can also add output that we need as the comment in <code>xxx.s</code> (assembly source file) to assist server side calculating fitness score.</p>
<p>A different version of <code>LLVM</code> may be preferred by other bug hunters :D<br>Remember to modify <code>AsmPrinter.cpp</code> and generate new <code>option_list.txt</code>&#x2F;<code>options_list.txt</code>.</p>
<p>If use LLVM-16 to test, steps like:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">## Build LLVM-16</span><br><span class="line">$ cmake -S llvm -B build -G &quot;Unix Makefiles&quot; -DCMAKE_BUILD_TYPE=Debug -DLLVM_ENABLE_PROJECTS=&quot;clang;lld&quot;  # -DLLVM_OBFUSCATION_LINK_INTO_TOOLS=ON (for ollvm)</span><br><span class="line">$ cd build/</span><br><span class="line">$ make -j55</span><br><span class="line">## Prepare option list:</span><br><span class="line">$ HashEnabledLLVM/build/bin/llc --help-list-hidden &gt; options_list.txt</span><br><span class="line">$ python3 optionParser.py options_list.txt x86</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## Clean PostgreSQL database &quot;db&quot;:</span><br><span class="line">root@b406ed67aeed:~# su postgres</span><br><span class="line">postgres@b406ed67aeed:/root$ psql</span><br><span class="line">could not change directory to &quot;/root&quot;: Permission denied</span><br><span class="line">psql (12.17 (Ubuntu 12.17-0ubuntu0.20.04.1))</span><br><span class="line">Type &quot;help&quot; for help.</span><br><span class="line"></span><br><span class="line">postgres=# \l</span><br><span class="line">                              List of databases</span><br><span class="line">   Name    |  Owner   | Encoding | Collate |  Ctype  |   Access privileges</span><br><span class="line">-----------+----------+----------+---------+---------+-----------------------</span><br><span class="line"> db        | postgres | UTF8     | C.UTF-8 | C.UTF-8 | =Tc/postgres         +</span><br><span class="line">           |          |          |         |         | postgres=CTc/postgres+</span><br><span class="line">           |          |          |         |         | anon=CTc/postgres</span><br><span class="line"> postgres  | postgres | UTF8     | C.UTF-8 | C.UTF-8 |</span><br><span class="line"> template0 | postgres | UTF8     | C.UTF-8 | C.UTF-8 | =c/postgres          +</span><br><span class="line">           |          |          |         |         | postgres=CTc/postgres</span><br><span class="line"> template1 | postgres | UTF8     | C.UTF-8 | C.UTF-8 | =c/postgres          +</span><br><span class="line">           |          |          |         |         | postgres=CTc/postgres</span><br><span class="line">(4 rows)</span><br><span class="line"></span><br><span class="line">postgres=# \l+</span><br><span class="line">postgres=# drop database db;</span><br><span class="line">DROP DATABASE</span><br><span class="line">postgres=# \l</span><br><span class="line">                              List of databases</span><br><span class="line">   Name    |  Owner   | Encoding | Collate |  Ctype  |   Access privileges</span><br><span class="line">-----------+----------+----------+---------+---------+-----------------------</span><br><span class="line"> postgres  | postgres | UTF8     | C.UTF-8 | C.UTF-8 |</span><br><span class="line"> template0 | postgres | UTF8     | C.UTF-8 | C.UTF-8 | =c/postgres          +</span><br><span class="line">           |          |          |         |         | postgres=CTc/postgres</span><br><span class="line"> template1 | postgres | UTF8     | C.UTF-8 | C.UTF-8 | =c/postgres          +</span><br><span class="line">           |          |          |         |         | postgres=CTc/postgres</span><br><span class="line">(3 rows)</span><br><span class="line"></span><br><span class="line">postgres=# create database db;</span><br><span class="line">CREATE DATABASE</span><br><span class="line">postgres=# grant all privileges on database db to anon;</span><br><span class="line">GRANT</span><br><span class="line">postgres=#</span><br></pre></td></tr></table></figure>

<h3 id="Fitness-Calculation"><a href="#Fitness-Calculation" class="headerlink" title="Fitness Calculation"></a>Fitness Calculation</h3><p>The <em>core</em> of feedback guided binary generation, is the <em>fitness function</em> indicates how to evolve.</p>
<p>Check <code>fitness_wrapper/server_function_hash_uniform_weight.py</code>, to <a href="#Run-It">Run It</a> we have fixed the application context stuff.</p>
<p>It connects local <code>PostgreSQL</code> database using class <code>AsmFiles</code>, and the main logic in dealing with <code>post_file()</code>:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post_file</span>(<span class="params">filename</span>):</span></span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (AsmFiles.query.filter_by(architecture=architectureName, binary_name=filename, binary_hash=hashNumber).<span class="built_in">all</span>() == []):</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;--------------------------------------&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;--------------------------------------&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;-----------found new file-------------&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;--------------------------------------&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;--------------------------------------&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;--------------------------------------&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#architectureName is obtained from the ASM File, the LLVM version we are using is modified to </span></span><br><span class="line">            <span class="comment">#output the architecture name which is found using a regex in the sever</span></span><br><span class="line"></span><br><span class="line">            function_hash_string = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">for</span> hashes <span class="keyword">in</span> fuctionHashes:</span><br><span class="line">                function_hash_string = function_hash_string + hashes + <span class="string">&quot;,&quot;</span> </span><br><span class="line">            </span><br><span class="line">            <span class="comment">#This nested for loop checks to see if any function that is seen is different or not</span></span><br><span class="line">            <span class="comment">#If it is different, we need to use it to compute the weight of the binary</span></span><br><span class="line">            </span><br><span class="line">            isFunctionDifferent = [<span class="number">1.0</span>]*<span class="built_in">len</span>(fuctionHashes)</span><br><span class="line"></span><br><span class="line">            <span class="comment">#go through the complete database to see if there are any different function hashes </span></span><br><span class="line">            Database = AsmFiles.query.filter_by(architecture=architectureName, binary_name=filename).<span class="built_in">all</span>()             </span><br><span class="line">            <span class="keyword">for</span> items <span class="keyword">in</span> Database:</span><br><span class="line">                items_dict = items.__dict__</span><br><span class="line">                function_hashes = <span class="built_in">str</span>(items_dict[<span class="string">&#x27;functionHashes&#x27;</span>])</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(fuctionHashes)):</span><br><span class="line">                    <span class="keyword">if</span> fuctionHashes[i] <span class="keyword">in</span> function_hashes:</span><br><span class="line">                        isFunctionDifferent[i] = <span class="number">0.0</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">#once we check if any function is different or not we can just add the new asm file to the database</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;.s&quot;</span> <span class="keyword">in</span> filename:</span><br><span class="line">                filename = filename.replace(<span class="string">&#x27;.s&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#if the architecture sub folder is not created then create this subfolder </span></span><br><span class="line">            <span class="keyword">if</span> ( (os.path.isdir(DOWNLOADS + <span class="string">&quot;/&quot;</span> + <span class="built_in">str</span>(architectureName) )) == <span class="literal">False</span> ):</span><br><span class="line">                os.mkdir( DOWNLOADS + <span class="string">&quot;/&quot;</span> + <span class="built_in">str</span>(architectureName) )</span><br><span class="line"></span><br><span class="line">            <span class="comment">#if the hash of this particular source asm is not seen, then it will create the new folder for the source</span></span><br><span class="line">            <span class="comment">#and then write the data as well</span></span><br><span class="line">            <span class="keyword">if</span> ( (os.path.isdir(DOWNLOADS + <span class="string">&quot;/&quot;</span> + <span class="built_in">str</span>(architectureName) + <span class="string">&quot;/&quot;</span> + <span class="built_in">str</span>(filename) )) == <span class="literal">False</span> ):</span><br><span class="line">                os.mkdir( DOWNLOADS + <span class="string">&quot;/&quot;</span> + <span class="built_in">str</span>(architectureName) + <span class="string">&quot;/&quot;</span> + <span class="built_in">str</span>(filename) )</span><br><span class="line">            </span><br><span class="line">            filename_saved = hashlib.sha256(request.get_data(as_text=<span class="literal">True</span>).encode(<span class="string">&quot;utf-8&quot;</span>)).hexdigest() </span><br><span class="line">            file_path = DOWNLOADS + <span class="string">&quot;/&quot;</span> + <span class="built_in">str</span>(architectureName) + <span class="string">&quot;/&quot;</span> + <span class="built_in">str</span>(filename) + <span class="string">&quot;/&quot;</span> + <span class="built_in">str</span>(filename_saved) + <span class="string">&quot;.s&quot;</span> </span><br><span class="line">            <span class="keyword">if</span> (  os.path.isfile(file_path) == <span class="literal">False</span> ):</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(file_path), <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">                    fp.write(request.get_data())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            dateTimeObj = datetime.now()</span><br><span class="line">            timestampStr = dateTimeObj.strftime(<span class="string">&quot;%d-%b-%Y (%H:%M:%S.%f)&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            asm_file = AsmFiles(architectureName, filename, hashNumber, file_path, function_hash_string, timestampStr)</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            lock.acquire()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (AsmFiles.query.filter_by(architecture=architectureName, binary_name=filename, binary_hash=hashNumber).<span class="built_in">all</span>() == []):</span><br><span class="line">                db.session.add(asm_file)</span><br><span class="line">                db.session.commit()</span><br><span class="line"></span><br><span class="line">            lock.release()           </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            flash(<span class="string">&#x27;Asm file successfully added&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Added a new Asm File to the database&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment">#calculate the final weight using the individual function weights and if the function is different or not</span></span><br><span class="line">            final_calculated_weight = <span class="number">0.0</span></span><br><span class="line">            <span class="keyword">for</span> function_index <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(isFunctionDifferent)):</span><br><span class="line">                final_calculated_weight = final_calculated_weight + isFunctionDifferent[function_index]   </span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">len</span>(isFunctionDifferent) &gt; <span class="number">0</span>):</span><br><span class="line">                return_value = final_calculated_weight / <span class="built_in">len</span>(isFunctionDifferent)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;The weight that was returned the server is: &quot;</span> + <span class="built_in">str</span>(return_value))</span><br><span class="line">        </span><br><span class="line">    <span class="comment">#return the calculated weight, is weight is 0 then the binary is not interesting, otherwise an integer weight is returned</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(return_value)</span><br></pre></td></tr></table></figure>
<p>The server receives <code>xxx.s</code> files instead of binaries, which makes the post analysis easier (to process text).</p>
<p>Everytime a <em>binary</em> with new hash occurs, server reports and stores it into database.<br>After that server calculates the fitness function according to the number of new <em>function</em> hashes. The fitness is a demonstration of how <em>binary</em> differs, and the server returns the score as fuzzer’s interesting score – representing new&#x2F;unique paths.</p>
<p>To modify for suiting your own needs, change the calculation part, and remember to return the score.</p>
<h2 id="Sum-Up"><a href="#Sum-Up" class="headerlink" title="Sum Up"></a>Sum Up</h2><p>What a lot.</p>
<p>Differential testing for binary analysis tools needs to be done…Later…</p>

                </div>
                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/note/">note</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/fuzzing/">fuzzing</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/paper/">paper</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/compiler/">compiler</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2025/06/17/2025-06-17-Go-Around-and-Back-to-Learn-Directed-Fuzzing-on-My-PoC-Transformation-Journey/"
                                   title="Go Around and Back to Learn Directed Fuzzing on My PoC Transformation Journey"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Go Around and Back to Learn Directed Fuzzing on My PoC Transformation Journey</span>
                                        <span class="post-nav-item">Prev posts</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2024/02/20/2024-02-20-Docker-Tips/"
                                   title="Docker Tips"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Docker Tips</span>
                                        <span class="post-nav-item">Next posts</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    






                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduce-Cornucopia"><span class="nav-number">1.</span> <span class="nav-text">Introduce Cornucopia</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Run-It"><span class="nav-number">2.</span> <span class="nav-text">Run It</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#when-running-fitness-wrapper-server-function-hash-uniform-weight-py"><span class="nav-number">2.1.</span> <span class="nav-text">when running fitness_wrapper&#x2F;server_function_hash_uniform_weight.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#when-running-automation-scripts-run-fuzz-py"><span class="nav-number">2.2.</span> <span class="nav-text">when running automation_scripts&#x2F;run_fuzz.py</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Project-Structure"><span class="nav-number">3.</span> <span class="nav-text">Project Structure</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#from-Dockerfile"><span class="nav-number">3.1.</span> <span class="nav-text">from Dockerfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Structure"><span class="nav-number">3.2.</span> <span class="nav-text">Structure</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#What-it-Modified-and-Where-to-Moodify"><span class="nav-number">4.</span> <span class="nav-text">What it Modified, and Where to Moodify</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#In-AFL"><span class="nav-number">4.1.</span> <span class="nav-text">In AFL++</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AFLplusplus-x2F"><span class="nav-number">4.1.1.</span> <span class="nav-text">AFLplusplus&#x2F;</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fitness-wrapper-x2F-xxx-postprocessor-cc"><span class="nav-number">4.1.2.</span> <span class="nav-text">fitness_wrapper&#x2F;xxx_postprocessor.cc</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#automation-scripts-x2F-run-fuzz-py"><span class="nav-number">4.1.3.</span> <span class="nav-text">automation_scripts&#x2F;run_fuzz.py</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#In-LLVM"><span class="nav-number">4.2.</span> <span class="nav-text">In LLVM</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fitness-Calculation"><span class="nav-number">4.3.</span> <span class="nav-text">Fitness Calculation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sum-Up"><span class="nav-number">5.</span> <span class="nav-text">Sum Up</span></a></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="border-box website-info-box default">
        
            <div class="copyright-info info-item default">
                &copy;&nbsp;<span>2018</span>&nbsp;-&nbsp;2025
                
                    &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">TyeYeah</a>
                
            </div>

            <div class="theme-info info-item default">
                Powered by&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;&&nbsp;Theme&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
            </div>

            

            
        

        <div class="count-item info-item default">
            
                <span class="count-box border-box word">
                    <span class="item-type border-box">Total words</span>
                    <span class="item-value border-box word">137k</span>
                </span>
            

            

            
        </div>
    </div>
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            $li-margin-bottom = 0.8rem
$post-tool-button-width = 2.5rem

.post-tools-container {
  padding-top var(--component-gap)

  .tools-list {

    li {
      position relative
      box-sizing border-box
      width $post-tool-button-width
      height $post-tool-button-width
      margin-bottom $li-margin-bottom
      color var(--text-color-3)
      font-size 1.2rem
      background var(--background-color-1)
      border-radius 50%
      box-shadow 2px 2px 5px var(--shadow-color)
      cursor pointer

      &:hover {
        box-shadow 2px 2px 8px var(--shadow-hover-color)
      }

      i {
        color var(--text-color-3)
      }


      &:hover {
        color var(--background-color-1)
        background var(--primary-color)

        i {
          color var(--background-color-1)
        }
      }


      &:last-child {
        margin-bottom 0
      }


      &.toggle-show-toc {
        display none
      }


      &.go-to-comments {
        .post-comments-count {
          position absolute
          top 0
          right -1rem
          display none
          align-items center
          justify-content center
          box-sizing border-box
          min-width 1.1rem
          height 1.1rem
          padding 0 0.2rem
          color var(--badge-color)
          font-size 12px
          background var(--badge-background-color)
          border-radius 0.4rem

          +keep-tablet() {
            display none !important
          }
        }
      }
    }
  }
}

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-toggle-theme-mode flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduce-Cornucopia"><span class="nav-number">1.</span> <span class="nav-text">Introduce Cornucopia</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Run-It"><span class="nav-number">2.</span> <span class="nav-text">Run It</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#when-running-fitness-wrapper-server-function-hash-uniform-weight-py"><span class="nav-number">2.1.</span> <span class="nav-text">when running fitness_wrapper&#x2F;server_function_hash_uniform_weight.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#when-running-automation-scripts-run-fuzz-py"><span class="nav-number">2.2.</span> <span class="nav-text">when running automation_scripts&#x2F;run_fuzz.py</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Project-Structure"><span class="nav-number">3.</span> <span class="nav-text">Project Structure</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#from-Dockerfile"><span class="nav-number">3.1.</span> <span class="nav-text">from Dockerfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Structure"><span class="nav-number">3.2.</span> <span class="nav-text">Structure</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#What-it-Modified-and-Where-to-Moodify"><span class="nav-number">4.</span> <span class="nav-text">What it Modified, and Where to Moodify</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#In-AFL"><span class="nav-number">4.1.</span> <span class="nav-text">In AFL++</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AFLplusplus-x2F"><span class="nav-number">4.1.1.</span> <span class="nav-text">AFLplusplus&#x2F;</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fitness-wrapper-x2F-xxx-postprocessor-cc"><span class="nav-number">4.1.2.</span> <span class="nav-text">fitness_wrapper&#x2F;xxx_postprocessor.cc</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#automation-scripts-x2F-run-fuzz-py"><span class="nav-number">4.1.3.</span> <span class="nav-text">automation_scripts&#x2F;run_fuzz.py</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#In-LLVM"><span class="nav-number">4.2.</span> <span class="nav-text">In LLVM</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fitness-Calculation"><span class="nav-number">4.3.</span> <span class="nav-text">Fitness Calculation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sum-Up"><span class="nav-number">5.</span> <span class="nav-text">Sum Up</span></a></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>



<!-- common -->

<script src="/js/utils.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/toggle-theme.js"></script>

<script src="/js/code-block.js"></script>

<script src="/js/main.js"></script>

<script src="/js/libs/anime.min.js"></script>


<!-- local-search -->

    
<script src="/js/local-search.js"></script>



<!-- lazyload -->


<div class="">
    
        <!-- post-helper -->
        
<script src="/js/post/post-helper.js"></script>


        <!-- toc -->
        
            
<script src="/js/post/toc.js"></script>

        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
