<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Computer, Network, Security">
    <meta name="description" content="a blog on Hexo">
    <meta name="author" content="TyeYeah">
    
    <title>
        
            Linux Kernel Build &amp; Exploit Preparation |
        
        Relish the Moment
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/img/wang.svg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en","path":"search.xml"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/img/aliwangwang.svg","favicon":"/img/wang.svg","article_img_align":"center","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":true}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.3"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                Relish the Moment
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                CATEGORIES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                TAGS
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                ABOUT
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">CATEGORIES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">TAGS</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">Linux Kernel Build &amp; Exploit Preparation</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/img/aliwangwang.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">TyeYeah</span>
                        
                            <span class="author-label">Lv4</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;2021-04-20 22:16:23
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/PWN/">PWN</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/pwn/">pwn</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/linux/">linux</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/qemu/">qemu</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/kernel/">kernel</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>1.9k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>11 Mins</span>
        </span>
    
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h2 id="Linux-Kernel-Build"><a href="#Linux-Kernel-Build" class="headerlink" title="Linux Kernel Build"></a>Linux Kernel Build</h2><p>To learn kernel, we should know how to compile it and how it works.</p>
<p>Source code can be found <a class="link"   target="_blank" rel="noopener" href="https://www.kernel.org/" >online<i class="fas fa-external-link-alt"></i></a> and all history versions are on <a class="link"   target="_blank" rel="noopener" href="https://mirrors.edge.kernel.org/pub/linux/kernel/" >there<i class="fas fa-external-link-alt"></i></a> to be downloaded. You can also view source code online on <a class="link"   target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/latest/source" >bootlin<i class="fas fa-external-link-alt"></i></a></p>
<h3 id="Just-Compile"><a href="#Just-Compile" class="headerlink" title="Just Compile"></a>Just Compile</h3><p>First install some essential tools:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install git gcc fakeroot build-essential ncurses-dev xz-utils libssl-dev bc libncurses-dev flex bison</span><br></pre></td></tr></table></figure>
<p>Then you can build the kernel. If the kernel is too old, some dependencies will not be satisfied.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ make menuconfig   </span><br><span class="line"><span class="comment"># if you want to build one available to debug,</span></span><br><span class="line"><span class="comment"># choose &#x27;KernelHacking --&gt; Compile-time checks and compiler options  ---&gt; Compile the kernel with debug info&#x27;</span></span><br><span class="line"><span class="comment"># disbale KASLR by unselecting &#x27;Processor type and features -&gt; Randomize the address of the kernel image (KASLR)&#x27;</span></span><br><span class="line"><span class="comment"># actually different version has different path to select the items</span></span><br><span class="line"><span class="comment"># and some other config items</span></span><br><span class="line">$ make              <span class="comment"># &#x27;make -j4&#x27; to be faster</span></span><br><span class="line">$ make all          <span class="comment"># build all</span></span><br><span class="line">$ make bzImage      <span class="comment"># build bzImage</span></span><br><span class="line">$ make modules_prepare  <span class="comment"># </span></span><br></pre></td></tr></table></figure>
<p>After that we can get <code>bzImage</code> form <code>linux-x.x.x/arch/x86/boot/bzImage</code>, and get <code>vmlinux</code> from <code>linux-x.x.x</code> root directory. </p>
<p>As for differences between <code>vmLinux</code>, <code>vmlinuz</code>, <code>vmlinux.bin</code>, <code>zImage</code> &amp; <code>bzImage</code> …</p>
<ul>
<li><code>vmlinux</code><br>This is the Linux kernel in an statically linked executable file format. Generally, you don’t have to worry about this file, it’s just a intermediate step in the boot procedure.<br>The raw vmlinux file may be useful for debugging purposes.</li>
<li><code>vmlinux.bin</code><br>The same as <code>vmlinux</code>, but in a bootable raw binary file format. All symbols and relocation information is discarded. Generated from <code>vmlinux</code> by objcopy -O binary <code>vmlinux</code> <code>vmlinux.bin</code>.</li>
<li><code>vmlinuz</code><br>The <code>vmlinux</code> file usually gets compressed with <code>zlib</code>. Since 2.6.30 LZMA and <code>bzip2</code> are also available. By adding further boot and decompression capabilities to <code>vmlinuz</code>, the image can be used to boot a system with the <code>vmlinux</code> kernel. The compression of <code>vmlinux</code> can occur with <code>zImage</code> or <code>bzImage</code>.<br>The function <code>decompress_kernel()</code> handles the decompression of <code>vmlinuz</code> at bootup, a message indicates this:  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Decompressing Linux... done</span><br><span class="line">Booting the kernel.</span><br></pre></td></tr></table></figure></li>
<li><code>zImage</code> (make zImage)<br>This is the old format for small kernels (compressed, below 512KB). At boot, this image gets loaded low in memory (the first 640KB of the RAM).</li>
<li><code>bzImage</code> (make bzImage)<br>The big zImage (this has nothing to do with bzip2), was created while the kernel grew and handles bigger images (compressed, over 512KB). The image gets loaded high in memory (above 1MB RAM). As today’s kernels are way over 512KB, this is usually the preferred way.</li>
</ul>
<p>More in <a class="link"   target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/5518/what-is-the-difference-between-the-following-kernel-makefile-terms-vmlinux-vml" >Here<i class="fas fa-external-link-alt"></i></a></p>
<h3 id="Busybox-and-QEMU"><a href="#Busybox-and-QEMU" class="headerlink" title="Busybox and QEMU"></a>Busybox and QEMU</h3><p>Actually to run the customized (built) kernel, we need <code>QEMU</code>, while <code>QEMU</code> needs a filesystem image to run, so we first build one image using <code>busybox</code>.</p>
<p>Download source on <a class="link"   target="_blank" rel="noopener" href="https://busybox.net/downloads/" >the official site<i class="fas fa-external-link-alt"></i></a>, and comiple it with setting <code>Build static binary (no shared libs)</code> (also check <code>(./_install) Destination path for &#39;make install&#39;</code> for not installing to <code>/usr</code>)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make menuconfig</span><br><span class="line">$ make install -j4</span><br></pre></td></tr></table></figure>
<p>If you want to cross compile like using <code>arm-linux-gcc</code>, edit <code>Makefile</code></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ARCH ?= <span class="variable">$(SUBARCH)</span></span><br><span class="line">CROSS_COMPILE ?=</span><br><span class="line"><span class="comment"># to be</span></span><br><span class="line">ARM ?= arm</span><br><span class="line">CROSS_COMPILE ?= arm-linux-</span><br></pre></td></tr></table></figure>
<p>After that things are generated in <code>_install</code> directory, do some extra operations</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> _install</span><br><span class="line">$ mkdir proc sys dev etc etc/init.d</span><br><span class="line">$ vim etc/init.d/rcS</span><br><span class="line">$ chmod +x etc/init.d/rcS</span><br></pre></td></tr></table></figure>
<p>And in <code>etc/init.d/rcS</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">/sbin/mdev -s</span><br></pre></td></tr></table></figure>
<p>Finally we build the file system</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ find . | cpio -o --format=newc &gt; ../rootfs.img</span><br></pre></td></tr></table></figure>
<p>Then run it by <code>QEMU</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-system-x86_64 \</span><br><span class="line">-kernel /path/to/linux-x.x.x/arch/x86/boot/bzImage \</span><br><span class="line">-initrd /path/to/busybox-x.x.x/rootfs.img \</span><br><span class="line">-append <span class="string">&quot;console=ttyS0 root=/dev/ram rdinit=/sbin/init&quot;</span> \</span><br><span class="line">-cpu kvm64,+smep,+smap \</span><br><span class="line">-nographic \</span><br><span class="line">-gdb tcp::1234</span><br></pre></td></tr></table></figure>
<p>So now you run your os on your own kernel, but all scripts and commands above are just samples, there are more config modifications later.</p>
<h3 id="Add-Customized-Functions"><a href="#Add-Customized-Functions" class="headerlink" title="Add Customized Functions"></a>Add Customized Functions</h3><p>For example, if we want to implement a personal <code>syscall</code>, First we need to put things in a directory:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># in root directory of linux kernel</span></span><br><span class="line">$ <span class="built_in">cd</span> helloworld/</span><br><span class="line">$ tree </span><br><span class="line">.</span><br><span class="line">├── helloworld.c</span><br><span class="line">└── Makefile</span><br><span class="line"></span><br><span class="line">0 directories, 2 files</span><br><span class="line"></span><br><span class="line">$ cat helloworld.c </span><br><span class="line"><span class="comment">#include &lt;linux/kernel.h&gt;</span></span><br><span class="line">asmlinkage long sys_helloworld(void)&#123;</span><br><span class="line">    printk(<span class="string">&quot;hello world\n&quot;</span>);</span><br><span class="line">    <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ cat Makefile </span><br><span class="line">obj-y=helloworld.o</span><br></pre></td></tr></table></figure>
<p>Then edit the <code>Makefile</code> (1 line) to include target directory</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">core-y      += x/ xx/ xxx/ ... helloworld/</span><br></pre></td></tr></table></figure>
<p>Edit <code>include/linux/syscalls.h</code> to add function prototype to the tail</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">asmlinkage <span class="keyword">long</span> <span class="title">sys_helloworld</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>Add customized <code>syscall</code> number</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// arch/x86/entry/syscalls/syscall_32.tbl, for i386</span></span><br><span class="line"><span class="number">1000</span>    i386    helloworld  sys_helloworld</span><br><span class="line"><span class="comment">// arch/x86/entry/syscalls/syscall_64.tbl, for amd64</span></span><br><span class="line"><span class="number">1000</span>    common helloworld sys_helloworld</span><br></pre></td></tr></table></figure>

<p>Then re-compile the kernel, and write a demo to test:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// compiled: gcc helloworld.c -o helloworld</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">    <span class="built_in">syscall</span>(<span class="number">1000</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;end&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Test:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ id</span><br><span class="line">uid=0 gid=0</span><br><span class="line">$ ./helloworld </span><br><span class="line">start</span><br><span class="line">[   12.345678] hello world</span><br><span class="line">end</span><br><span class="line">$</span><br></pre></td></tr></table></figure>

<h3 id="Compile-Driver"><a href="#Compile-Driver" class="headerlink" title="Compile Driver"></a>Compile Driver</h3><p>As for driver module, it is apart from linux kernel compilation.<br>First we also need a driver program written in <code>C</code> like <code>hello_lkm.c</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;linux/cred.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> <span class="title">c</span>;</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_lkm_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printk</span>(<span class="string">&quot;hello lkm!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printk</span>(<span class="string">&quot;size of cred : %d \n&quot;</span>,<span class="built_in"><span class="keyword">sizeof</span></span>(c));</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hello_lkm_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printk</span>(<span class="string">&quot;Bye, lkm\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module_init</span>(hello_lkm_init);</span><br><span class="line"><span class="built_in">module_exit</span>(hello_lkm_exit);</span><br></pre></td></tr></table></figure>
<p>And its Makefile specifies module name, linux kernel path, and intermediate object name:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">obj-m := hello_lkm.o</span><br><span class="line"></span><br><span class="line">KERNELDR := ../</span><br><span class="line"></span><br><span class="line">PWD := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line"></span><br><span class="line"><span class="section">modules:</span></span><br><span class="line">        <span class="variable">$(MAKE)</span> -C <span class="variable">$(KERNELDR)</span> M=<span class="variable">$(PWD)</span> modules</span><br><span class="line"></span><br><span class="line"><span class="section">moduels_install:</span></span><br><span class="line">        <span class="variable">$(MAKE)</span> -C <span class="variable">$(KERNELDR)</span> M=<span class="variable">$(PWD)</span> modules_install</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">        rm -rf *.o *~ core .depend .*.cmd *.ko *.mod.c .tmp_versions</span><br></pre></td></tr></table></figure>
<p>We put them in one directory, and <code>make</code> to get one <code>hello_lkm.ko</code> under the current dir.</p>
<p>To install this module, we can pack it into filesystem image, and add commands in <code>init</code> to install it:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">insmod ./hello_lkm.ko</span><br><span class="line"><span class="comment"># if the driver is for &#x27;character device&#x27; or sth, also add</span></span><br><span class="line"><span class="comment"># `mknod /dev/kmod c 100 0`</span></span><br><span class="line"><span class="comment"># 100 is the primary device number</span></span><br></pre></td></tr></table></figure>
<p>Actually this driver reacts when you just when you initialize and exit it, so we can see the results when:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ insmod hello_lkm.ko</span><br><span class="line">[   20.247241] hello_lkm: loading out-of-tree module taints kernel.</span><br><span class="line">[   20.247512] hello_lkm: module license &#x27;unspecified&#x27; taints kernel.</span><br><span class="line">[   20.247894] Disabling lock debugging due to kernel taint</span><br><span class="line">[   20.252195] hello lkm!</span><br><span class="line">[   20.252373] size of cred : 168</span><br><span class="line">$ lsmod</span><br><span class="line">hello_lkm 16384 0 - Live 0xffffffffc030b000 (PO)</span><br><span class="line">$ rmmod hello_lkm.ko</span><br><span class="line">[   59.195751] Bye, lkm</span><br></pre></td></tr></table></figure>
<p>In <code>gdb</code> we can load it and set breakpoints to debug step by step:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; add-symbol-file /path/to/linux.x.x.x/hello_lkm/hello_lkm.ko 0xffffffffc030b000</span><br><span class="line">add symbol table from file &quot;/path/to/linux.x.x.x/hello_lkm/hello_lkm.ko&quot; at</span><br><span class="line">.text_addr = 0xffffffffc030b000</span><br><span class="line">Reading symbols from /path/to/linux.x.x.x/hello_lkm/hello_lkm.ko...done.</span><br><span class="line"></span><br><span class="line">pwndbg&gt; b hello_lkm_exit</span><br><span class="line">Breakpoint1 at 0xffffffffc030b020: file /path/to/linux.x.x.x/hello_lkm/hello_lkm.c, line 25.</span><br></pre></td></tr></table></figure>

<h2 id="Linux-Kernel-Exploit"><a href="#Linux-Kernel-Exploit" class="headerlink" title="Linux Kernel Exploit"></a>Linux Kernel Exploit</h2><p>Normally the pwn challenges give us <code>xxx.ko</code>, <code>bzImage</code>, <code>initramfs.img</code>, and <code>start.sh</code></p>
<ul>
<li><code>xxx.ko</code> is the module with bugs, can be analyzed by IDA</li>
<li><code>bzImage</code> is the packed kernel, and we can use <a class="link"   target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux" >extract-vmlinux<i class="fas fa-external-link-alt"></i></a> to extract <code>vmlinux</code> from it. <code>vmlinux</code> can be loaded into <code>gdb</code> to debug.<br>After that we use <code>objdump -d vmlinux &gt; gadget</code> to save gadgets and <code>Ctrl+f</code> to search, or we can use <code>ropper</code> and <code>ROPgadget</code>.</li>
<li><code>initramfs.img</code> is the filesystem image.<br>When building image using <code>busybox</code>, we <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># produce `rootfs.img` </span></span><br><span class="line">$ find . | cpio -o --format=newc &gt; ../rootfs.img </span><br><span class="line"><span class="comment"># extract image</span></span><br><span class="line">$ cpio -idmv &lt;rootfs.img </span><br></pre></td></tr></table></figure>
  however <code>initramfs.img</code> is always compressed, so we <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># make initramfs.img </span></span><br><span class="line">$ find . | cpio -o -H newc | gzip &gt; /boot/initramfs.img.gz</span><br><span class="line">$ mv initramfs.img.gz initramfs.img </span><br><span class="line"><span class="comment"># and extract</span></span><br><span class="line">$ file initramfs.img</span><br><span class="line">$ mv initramfs.img initramfs.img.gz <span class="comment"># or &#x27;initramfs.img.xz&#x27; according to file type</span></span><br><span class="line">$ gunzip initramfs.img.gz <span class="comment"># or &#x27;xz -d initramfs.img.xz&#x27;</span></span><br><span class="line">$ cpio -idmv &lt; ./initramfs.img </span><br></pre></td></tr></table></figure></li>
<li><code>start.sh</code> is the script to run <code>QEMU</code> system mode. </li>
</ul>
<h3 id="Security-Mechanism"><a href="#Security-Mechanism" class="headerlink" title="Security Mechanism"></a>Security Mechanism</h3><p>Some challenges run on environment with security mechanism (<a class="link"   target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/sysctl/kernel.txt" >reference<i class="fas fa-external-link-alt"></i></a>), so we normally disable them to obtain more debug info.</p>
<p>Like in <code>init</code> in extracted <code>initramfs.img</code>, we can add commands to remove <code>kptr_restrict</code>, <code>dmesg_restrict</code> and <code>MMAP_MIN_ADDR</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"># 0: no restrictions</span><br><span class="line"># 1: users must have CAP_SYSLOG to use dmesg and see &#x27;printk()&#x27; results</span><br><span class="line">echo 0 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"># 0: print using &#x27;%p&#x27; in &#x27;seq_printf()&#x27; of &#x27;kallsyms.c&#x27;</span><br><span class="line"># 1: print 0 unless having CAP_SYSLOG</span><br><span class="line"># 2: kernel pointers printed using &#x27;%pK&#x27; will be replaced with 0&#x27;s regardless of privileges</span><br><span class="line">setsid /bin/cttyhack setuidgid 0000 /bin/sh </span><br><span class="line"># give root privilege to normal user</span><br></pre></td></tr></table></figure>
<p>And when stopping <code>KASLR</code>, <code>SMEP</code> and <code>SMAP</code>, we modify <code>QEMU</code> running parameters (add <code>nokaslr</code>)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-append &quot;console=ttyS0 nokaslr ...&quot; # replace kaslr with nokaslr</span><br><span class="line">-cpu kvm64,... # remove &#x27;+smep,+smap&#x27;</span><br></pre></td></tr></table></figure>
<p>As for <code>NX</code> and <code>Canary</code>(stack protector), these can be done in compilation.</p>
<h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><p>Using <code>GDBStub</code> (start <code>gdbserver</code> port locally) of <code>QEMU</code> to debug, we add parameter</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-s: open port 1234</span><br><span class="line">-S: waiting for debugger attachment</span><br><span class="line">-gdb tcp::2345</span><br></pre></td></tr></table></figure>

<p>And a script to quickly connect</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">gdb \</span><br><span class="line">-ex <span class="string">&quot;target remote localhost:1234&quot;</span> \</span><br><span class="line">-ex <span class="string">&quot;add-symbol-file ./xxx.ko 0xdeadbeef&quot;</span> \</span><br></pre></td></tr></table></figure>

<p>And some key files &amp; commands to get info:</p>
<ul>
<li><code>cat /proc/modules</code>: see loaded kernel modules</li>
<li><code>cat /proc/kallsyms</code>: see all kernel symbols</li>
<li><code>cat /sys/module/xxx/sections</code>: list sections of module <code>xxx</code> </li>
<li><code>dmesg</code>: see kernel logs, where <code>printk()</code> prints</li>
<li><code>cat /proc/kallsyms |grep commit_creds</code> &amp; <code>cat /proc/kallsyms |grep prepare_kernel_cred</code>: get the two funcs addrs</li>
</ul>
<h3 id="Script"><a href="#Script" class="headerlink" title="Script"></a>Script</h3><p>Here are scripts for packing and unpacking:<br><code>unpack.py</code></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line">mkdir unzip</span><br><span class="line">cp rootfs.cpio.gz ./unzip/</span><br><span class="line">cd unzip</span><br><span class="line">gunzip rootfs.cpio.gz</span><br><span class="line">cpio -idmv &lt;rootfs.cpio</span><br><span class="line">rm -rf rootfs.cpio</span><br></pre></td></tr></table></figure>
<p><code>repack.py</code></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line">cd unzip</span><br><span class="line">find . | cpio -ov -H newc | gzip -<span class="number">9</span> &gt; ../rootfs2.cpio.gz</span><br></pre></td></tr></table></figure>

<p>If we do experiments locally, we can pack the exploit binary into filesystem image, and see it in the system when booting, while when interacting with remote, we cannot alternate remote filesystem.</p>
<p>Therefore we copy exploit binary to remote via interaction shell, and here is a script to facilitate it:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">cmd = <span class="string">&#x27;$ &#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>(<span class="params">r</span>):</span></span><br><span class="line">    r.sendlineafter(cmd, <span class="string">&#x27;stty -echo&#x27;</span>)</span><br><span class="line">    os.system(<span class="string">&#x27;musl-gcc  -static -O2 ./poc/exp.c -o ./poc/exp&#x27;</span>)</span><br><span class="line">    os.system(<span class="string">&#x27;gzip -c ./poc/exp &gt; ./poc/exp.gz&#x27;</span>)</span><br><span class="line">    r.sendlineafter(cmd, <span class="string">&#x27;cat &lt;&lt;EOF &gt; exp.gz.b64&#x27;</span>)</span><br><span class="line">    r.sendline((read(<span class="string">&#x27;./poc/exp.gz&#x27;</span>)).encode(<span class="string">&#x27;base64&#x27;</span>))</span><br><span class="line">    r.sendline(<span class="string">&#x27;EOF&#x27;</span>)</span><br><span class="line">    r.sendlineafter(cmd, <span class="string">&#x27;base64 -d exp.gz.b64 &gt; exp.gz&#x27;</span>)</span><br><span class="line">    r.sendlineafter(cmd, <span class="string">&#x27;gunzip ./exp.gz&#x27;</span>)</span><br><span class="line">    r.sendlineafter(cmd, <span class="string">&#x27;chmod +x ./exp&#x27;</span>)</span><br><span class="line">    <span class="comment">#r.sendlineafter(cmd, &#x27;./exp&#x27;)</span></span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./run.sh&#x27;</span>, shell=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># p = remote(&#x27;&#x27;, )</span></span><br><span class="line"></span><br><span class="line">exploit(p)</span><br></pre></td></tr></table></figure>

        </div>

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2021/05/12/2021-05-12-Heap-Exploit-Intro/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Heap Exploit Intro</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2021/02/19/2021-02-19-About-Privilege-Escalation/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">About Privilege Escalation</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>&nbsp;-&nbsp;
            
            2021&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">TyeYeah</a>
        </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.3</a>
        </div>
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux-Kernel-Build"><span class="nav-number">1.</span> <span class="nav-text">Linux Kernel Build</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Just-Compile"><span class="nav-number">1.1.</span> <span class="nav-text">Just Compile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Busybox-and-QEMU"><span class="nav-number">1.2.</span> <span class="nav-text">Busybox and QEMU</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Add-Customized-Functions"><span class="nav-number">1.3.</span> <span class="nav-text">Add Customized Functions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Compile-Driver"><span class="nav-number">1.4.</span> <span class="nav-text">Compile Driver</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux-Kernel-Exploit"><span class="nav-number">2.</span> <span class="nav-text">Linux Kernel Exploit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Security-Mechanism"><span class="nav-number">2.1.</span> <span class="nav-text">Security Mechanism</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Debug"><span class="nav-number">2.2.</span> <span class="nav-text">Debug</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Script"><span class="nav-number">2.3.</span> <span class="nav-text">Script</span></a></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>





<div class="post-scripts">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>



</body>
</html>
