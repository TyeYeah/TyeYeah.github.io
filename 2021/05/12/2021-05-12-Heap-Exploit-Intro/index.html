<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Computer, Network, Security">
    <meta name="description" content="a blog on Hexo">
    <meta name="author" content="TyeYeah">
    
    <title>
        
            Heap Exploit Intro |
        
        Relish the Moment
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/img/wang.svg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en","path":"search.xml"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/img/aliwangwang.svg","favicon":"/img/wang.svg","article_img_align":"center","left_side_width":"300px","content_max_width":"1200px","hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":true}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.3"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                Relish the Moment
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                CATEGORIES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                TAGS
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                ABOUT
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">CATEGORIES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">TAGS</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">Heap Exploit Intro</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/img/aliwangwang.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">TyeYeah</span>
                        
                            <span class="author-label">Lv4</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;2021-05-12 08:21:19
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Pwn/">Pwn</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/pwn/">pwn</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/linux/">linux</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/heap/">heap</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/uaf/">uaf</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/unlink/">unlink</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>2.7k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>17 Mins</span>
        </span>
    
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p>Succinct Challenge-Oriented <code>heap</code> exploit introduction. Here we talk about the <code>heap</code> on <code>Linux</code>.</p>
<h2 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h2><p>You can visit <a class="link"   target="_blank" rel="noopener" href="http://ftp.gnu.org/gnu/glibc" >GNU ftp<i class="fas fa-external-link-alt"></i></a> to check Linux glibc source code. This tells how <code>heap</code> works in details, but truly hard to read.</p>
<p>To understand Linux heap mechanism better, the following image gives us a general look, but it is an older version of glibc <code>heap</code> implementation.<br><img src="/imghost/hei/heap.png" alt="heap"></p>
<p>you can also visit <a class="link"   target="_blank" rel="noopener" href="https://github.com/wapiflapi/villoc" >villoc<i class="fas fa-external-link-alt"></i></a> to visualize the process of a program assigning memory when running (click <a class="link"   target="_blank" rel="noopener" href="http://wapiflapi.github.io/villoc/" >here<i class="fas fa-external-link-alt"></i></a> to see an example).</p>
<p>It’s better to visit other researchers’ update-to-date blog and read their analysis essays to learn <code>heap</code>.</p>
<h2 id="Heap-Overflow"><a href="#Heap-Overflow" class="headerlink" title="Heap Overflow"></a>Heap Overflow</h2><p>It is similar to <code>stack</code> overflow since they both write too much things to mess up <code>stack</code>/<code>heap</code>.<br><code>stack</code> overflow usually overwrite <code>ret addr</code> of a function on the stack to control program flow; <code>heap</code> overflow can break/change next chunk structure, fake chunk for <code>unlink</code>, even overwrite things on stack (if chunk is alloced on stack).</p>
<h2 id="Unlink"><a href="#Unlink" class="headerlink" title="Unlink"></a>Unlink</h2><p><code>unlink</code> is always used for changing where pointer points.</p>
<p>The <code>unlink</code> occurs only when you free a chunk, and another freed chunk (not in fastbin) is next to it. Then that freed chunk will be unlinked (that’s where <code>unlink</code> happens) from its original bin list, and merged with your newly freed chunk. Or when a <code>largebin</code> chunk is allocated the <code>unlink</code> also happens, but except checking <code>fd</code> and <code>bk</code>, the check of <code>fd_nextsize</code> and <code>bk_nextsize</code> is added</p>
<p>***Ancient <code>unlink</code>: ***<br>It just operates as the following image does.<br><img src="/imghost/hei/unlink_smallbin_intro.png" alt="unlink_smallbin_intro"><br>Here we take <code>32-bit</code> chunk as an example (every part in <code>32-bit</code> takes <code>0x4</code> bytes):<br><img src="/imghost/hei/old_unlink_vul.png" alt="old_unlink_vul"><br>The whole process of <code>free</code> chunk <code>Q</code> is:</p>
<ul>
<li><code>glibc</code> judges this chunk to be small chunk</li>
<li>merge forward, find previous in use, so skip</li>
<li>merge backward, find chunk <code>Nextchunk</code> is freed</li>
<li>perform <code>unlink</code> for <code>Nextchunk</code></li>
</ul>
<p>Without check for <code>fd</code> and <code>bk</code>, so we can set them any value. The process of <code>unlink</code>:</p>
<ul>
<li>FD = <code>Nextchunk</code>-&gt;<code>fd</code> = <code>target addr-12</code> </li>
<li>BK = <code>Nextchunk</code>-&gt;<code>bk</code> = <code>expect value</code></li>
<li>FD-&gt;<code>bk</code> = BK, that is <code>*(target addr-12+12) = BK = expect value</code></li>
<li>BK-&gt;<code>fd</code> = FD, that is <code>*(expect value +8) = FD = target addr-12</code></li>
</ul>
<p>Finally we get <code>*(target addr) = expect value</code> (write anywhere anything), but also set <code>*(expect value +8) = target addr-12</code> (sometimes needs to be bypassed).</p>
<p>However more checks were added to <code>unlink</code> nowadays.</p>
<p>***Current <code>unlink</code>: ***<br>New checks here:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// check size</span></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (<span class="built_in">chunksize</span>(P) != <span class="built_in">prev_size</span> (<span class="built_in">next_chunk</span>(P)), <span class="number">0</span>))      \</span><br><span class="line">      <span class="built_in">malloc_printerr</span> (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);               \</span><br><span class="line"><span class="comment">// check &#x27;fd&#x27; and &#x27;bk&#x27; (linked list integrity check)</span></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))                      \</span><br><span class="line">  <span class="built_in">malloc_printerr</span> (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);  \</span><br><span class="line"></span><br><span class="line">  <span class="comment">// check &#x27;next_size&#x27; of largebin (linked list integrity check) </span></span><br><span class="line">              <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, <span class="number">0</span>)              \</span><br><span class="line">                || __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="number">0</span>))    \</span><br><span class="line">              <span class="built_in">malloc_printerr</span> (check_action,                                      \</span><br><span class="line">                               <span class="string">&quot;corrupted double-linked list (not small)&quot;</span>,    \</span><br><span class="line">                               P, AV);</span><br></pre></td></tr></table></figure>
<p>As we can see, <code>FD-&gt;bk == P &amp;&amp; BK-&gt;fd == P</code> should be satisfied, so <code>fd</code> and <code>bk</code> cannot be set as above did.</p>
<p>To pass this check, we need:</p>
<ul>
<li>fakeFD -&gt; <code>bk</code> == P &lt;=&gt; *(fakeFD + 12) == P</li>
<li>fakeBK -&gt; <code>fd</code> == P &lt;=&gt; *(fakeBK + 8) == P</li>
</ul>
<p>Then in <code>unlink</code>:</p>
<ul>
<li>fakeFD -&gt; <code>bk</code> = fakeBK &lt;=&gt; *(fakeFD + 12) = fakeBK</li>
<li>fakeBK -&gt; <code>fd</code> = fakeFD &lt;=&gt; *(fakeBK + 8) = fakeFD</li>
</ul>
<p>That is:</p>
<ul>
<li>*P = P - 8</li>
<li>*P = P - 12</li>
</ul>
<p>So the result is <code>*P = P - 12</code>. Well, if we set <code>fd</code>(fakeFD) as <code>nextchunk addr-12</code>, and <code>bk</code>(fakeBK) as <code>nextchunk addr-8</code>, we will get: <code>*nextchunk = nextchunk - 12</code>.<br><img src="/imghost/hei/new_unlink_vul.png" alt="new_unlink_vul"><br>This let <code>nextchunk</code> point to the place close to it. If we can write to it, we may even change <code>nextchunk</code> value to be <code>GOT</code> address and hijack <code>GOT</code> item.</p>
<p>Visit <a href="/2020/09/20/2020-09-20-ADWorld-PWN-Challenge-Area-Write-ups-Unlink/">ADWorld PWN Challenge Area Write-ups (Unlink)</a> for more challenges.</p>
<h2 id="Chunk-Extend-Overlapping"><a href="#Chunk-Extend-Overlapping" class="headerlink" title="Chunk Extend/Overlapping"></a>Chunk Extend/Overlapping</h2><p>The <code>ptmalloc</code> uses chunk header to determine whether chunk is inuse, or locate the post/next chunk. </p>
<p>if we adjust (extend/shrink) a chunk’s <code>size</code> part, next we <code>malloc</code>/<code>free</code> it, the eighboring chunks will be effected (be included into the chunk we operates or sth).</p>
<h2 id="Use-After-Free"><a href="#Use-After-Free" class="headerlink" title="Use After Free"></a>Use After Free</h2><p>The <code>UAF</code> vulnerability exist when you free something but not set that pointer as <code>NULL</code>, while when editing you dont check whether it is freed.</p>
<p>For example: if program prevents you from writing shellcode to <code>A</code> item, but you can write it to <code>B</code> item directly. So you can free <code>A</code> item first and re-assign it as <code>B</code> item, write shellcode to it, and still use it as <code>A</code> item for evil things.</p>
<p>Visit <a href="/2020/08/14/2020-08-14-ADWorld-PWN-Challenge-Area-Write-ups-UAF-Part/">ADWorld PWN Challenge Area Write-ups (UAF Part)</a> to see more challenges.</p>
<h2 id="Fastbin-Attack"><a href="#Fastbin-Attack" class="headerlink" title="Fastbin Attack"></a>Fastbin Attack</h2><p>Attacks around <code>fastbin</code>, includes:</p>
<ol>
<li><code>fastbin</code> double free</li>
</ol>
<p>First free <code>chunk1</code><br><img src="/imghost/hei/fastbin_free_chunk1.png" alt="fastbin_free_chunk1"><br>Second free <code>chunk2</code><br><img src="/imghost/hei/fastbin_free_chunk2.png" alt="fastbin_free_chunk2"><br>Thirdly, free <code>chunk1</code><br><img src="/imghost/hei/fastbin_free_chunk3.png" alt="fastbin_free_chunk3"><br>Then we can make multiple pointers control the same <code>chunk</code>.</p>
<ol start="2">
<li><a href="#House-of-Spirit">House Of Spirit</a></li>
</ol>
<p>a technique in <code>the Malloc Maleficarum</code>. It is to fake one <code>fastbin chunk</code> at some place, which should also bypass some limits in <code>free</code>, to successfully allocate it.<br>Fake a chunk in <code>fastbin</code> size, find a way to <code>free</code> it into <code>fastbin list</code>, and take over the palce through allocating <code>fastbin</code> of that size. </p>
<ol start="3">
<li><p>Alloc to Stack<br>Change <code>fd</code> to points to our carefully constructed fake <code>chunk</code> on <code>stack</code>, then we fetch it to edit the <code>ret addr</code>.</p>
</li>
<li><p>Arbitrary Alloc<br>The target changes from <code>stack</code> to anywhere.</p>
</li>
</ol>
<h2 id="Unsorted-Bin-Attack"><a href="#Unsorted-Bin-Attack" class="headerlink" title="Unsorted Bin Attack"></a>Unsorted Bin Attack</h2><p>Since it works differently from <code>fastbin</code>, it can only assign some big number (you will know later) to target address.<br>It fakes an unsorted bin chunk at the end of the bin list, and then allocate all the other real bins in the same list.</p>
<p>When there is only the fake bin in list, its <code>fd</code> points to the <code>fd</code> of <code>unsortedbin</code> in <code>malloc_state</code> struct, might be <code>main_arena + 0x88</code>. In <code>glibc</code> it must starts with <code>0x7f</code> (can be regarded as the <code>size</code> of a <code>fastbin</code>). So it works for <code>fastbin attack</code> to find/make the target.</p>
<h2 id="Large-Bin-Attack"><a href="#Large-Bin-Attack" class="headerlink" title="Large Bin Attack"></a>Large Bin Attack</h2><p>It happens when the <code>largebin</code> double linked list inserting or removing chunks, and it leads to:</p>
<ul>
<li>Unexpected memory allocating: when requesting for a <code>largebin</code> (<code>malloc</code>), fake the <code>bk_nextsize</code> of the <code>largebin</code> chunk first.<ul>
<li>set <code>bk_nextsize</code> as the target address</li>
<li>set target’s fake <code>fd</code> and <code>bk</code> as what we did in <a href="/#Unlink"><code>unlink</code></a> to bypass <code>unsorted bin unlink</code>.</li>
<li>set target’s fake <code>bk_nextsize</code> and <code>fd_nextsize</code> as <code>0</code> to skip <code>large bin unlink</code> operation (it will do <code>unsorted bin unlink</code> instead).</li>
<li>the fake chunk starting at target address will be allocated. </li>
</ul>
</li>
<li>Write <code>heap</code> address anywhere: when inserting a <code>largebin</code> chunk (<code>free</code>), fake the <code>bk_nextsize</code> and <code>bk</code>.<ul>
<li>set <code>fwd-&gt;bk_nextsize</code> as <code>evil_addr-0x20</code>. After executing <code>victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize</code> the <code>victim-&gt;bk_nextsize</code> is also set as <code>evil_addr-0x20</code>. Then <code>victim-&gt;bk_nextsize-&gt;fd_nextsize = victim</code> writes <code>victim addr</code> to <code>evil_addr-0x20-&gt;fd_nextsize</code>, that is writing <code>victim addr</code> to <code>evil_addr</code>. </li>
</ul>
<ul>
<li>Related codes:<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize; </span><br><span class="line">...</span><br><span class="line">victim-&gt;bk_nextsize-&gt;fd_nextsize = victim; </span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li>set <code>fwd-&gt;bk</code> as <code>evil_addr-0x10</code>. After <code>bck = fwd-&gt;bk</code> it sets <code>bck</code> as <code>evil_addr-0x10</code>. Then the <code>bck-&gt;fd = victim</code> writes <code>victim addr</code> to <code>evil_addr-0x10-&gt;fd</code>, that is writing <code>victim addr</code> to <code>evil_addr</code>. </li>
</ul>
<ul>
<li>Related codes:<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bck = fwd-&gt;bk; </span><br><span class="line">...</span><br><span class="line">bck-&gt;fd = victim; </span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li>As for where to write,  the <code>global_max_fast</code> might be a good place to write a big number to.</li>
</ul>
</li>
</ul>
<h2 id="House-of-Storm"><a href="#House-of-Storm" class="headerlink" title="House of Storm"></a>House of Storm</h2><p>We get two chances of writing <code>heap</code> address anywhere by faking <code>bk_nextsize</code> and <code>bk</code> of <code>largebin</code> chunk. Except <code>global_max_fast</code> another exploit is <code>House of Storm</code>. Combining with <code>unsorted bin attack</code> we can make it to be allocating any memory.</p>
<p>We have to meet some conditions:</p>
<ol>
<li>There is a chunk <code>A</code> in <code>largebin</code></li>
<li>And a chunk <code>B</code> in <code>unsorted bin</code></li>
<li>The size of <code>B</code> is greater than size of <code>A</code> </li>
</ol>
<p>When <code>malloc</code> a <code>0x48-0x58</code> chunk:</p>
<ul>
<li>If we set <code>A-&gt;bk_nextsize</code> as <code>evil_addr-0x20+8-5</code>, set <code>A-&gt;bk</code> as <code>evil_addr-0x10+0x18</code> and set <code>B-&gt;bk</code> as <code>evil_addr</code></li>
<li>It first searches <code>unsorted bin</code> and sorts them <code>small/large bin</code></li>
<li>Then triggers <code>unsorted bin attack</code>, <code>unsorted bin-&gt;bk</code> points to <code>evil_addr</code></li>
<li>Next, chunk <code>B</code> is inserted into <code>largebin</code>. When <code>PIE</code> is enabled, the <code>heap</code> address always starts with <code>0x56</code> or <code>0x55</code> (<code>fastbin</code> chunk size), that size is suitable for our <code>malloc</code> request.</li>
<li>As we write <code>heap</code> address into <code>evil_addr+0x8-5</code> (fake size) and <code>evil_addr+0x18</code> (fake <code>bk</code>), the fake chunk will be like (if we set <code>evil_addr</code> as <code>__free_hook</code>):<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">heap &amp;__free_hook</span><br><span class="line">$1=&#123;</span><br><span class="line">  prev_size = xxxxxxxxxx,</span><br><span class="line">  size = 0x56,</span><br><span class="line">  fd = 0x0,</span><br><span class="line">  bk = 0x56xxxxxxxxxxxx,</span><br><span class="line">  fd_nextsize = 0,</span><br><span class="line">  bk_nextsize = 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
Since the size fits our <code>malloc</code> request well, we <code>malloc</code> the faked chunk starting at <code>evil_addr</code>.</li>
</ul>
<p>So in the next big <code>for</code> loop (<code>malloc</code> loop) the faked <code>unsorted bin</code> will be removed/allocated.<br>As <code>evil_addr-&gt;bk</code> points to <code>heap</code> address, it bypasses limit of <code>bck-&gt;fd = unsorted_chunks (av)</code>. </p>
<h2 id="Tcache-Attack"><a href="#Tcache-Attack" class="headerlink" title="Tcache Attack"></a>Tcache Attack</h2><p>First have a look at the source of new structures: </p>
<ol>
<li><code>tcache_entry</code> <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* We overlay this structure on the user-data portion of a chunk when the chunk is stored in the per-thread cache.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br></pre></td></tr></table></figure></li>
<li>and <code>tcache_perthread_struct</code><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* There is one of these for each thread, which contains the per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping overall size low is mildly important.  Note that COUNTS and ENTRIES are redundant (we could have just counted the linked list each time), this is for performance reasons.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">char</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> __thread tcache_perthread_struct *tcache = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>
<img src="/imghost/hei/006AWYXBly1fw87zlnrhtj30nh0ciglz.jpg" alt="tcache"><br>And the running mechanism is:</li>
</ol>
<ul>
<li><code>free</code>: if size &lt; <code>smallbin</code> size<ul>
<li>before <code>tcache</code>:<ul>
<li>put chunks into <code>fastbin</code> or <code>unsortedbin</code></li>
</ul>
</li>
<li>after <code>tcache</code>:<ul>
<li>put into <code>tcache</code></li>
<li>but only 7 chunks by default, for <code>tcache</code> of same size</li>
<li>if the list is full, then put into <code>fastbin</code> or <code>unsortedbin</code></li>
</ul>
</li>
</ul>
</li>
<li><code>malloc</code>: if size in <code>tcache</code> size range<ul>
<li>take from <code>tcache</code> if not empty</li>
<li>find if <code>fastbin/smallbin/unsorted bin</code> have available chunks.</li>
<li>if they got, chunks will be moved from <code>fastbin/smallbin/unsorted bin</code> to <code>tcache</code> until it’s full</li>
<li>then <code>malloc</code> will take chunk in <code>tcache</code></li>
</ul>
</li>
</ul>
<ul>
<li><p>tcache poisoning<br>overwrite pointer <code>next</code>, without checks we can <code>malloc</code> everywhere.</p>
</li>
<li><p>tcache dup<br>since in libc 2.26 there is no checks for double free, so we can build cycliced list in <code>tcache</code> like what we do in old <code>fastbin</code> double free</p>
</li>
<li><p>tcache perthread corruption<br>the <code>tcache_perthread_struct</code> manage the whole <code>tcache</code> structure, if we find a way to control it, we can change the <code>entries</code> and other related addresses</p>
</li>
<li><p>tcache house of spirit<br>using <code>tcache</code> to do house of spirit, fake a chunk on stack or sth to bypass some checks, link in into <code>tcache</code> and we can alloc it.</p>
</li>
<li><p>smallbin unlink<br>when putting <code>smallbin</code> to <code>tcache</code>, there exists <code>unlink</code> operations with weak checks</p>
</li>
<li><p>tcache stashing unlink attack<br>when using <code>calloc</code> it won’t take chunks from <code>tcache</code>, so there will be unlinks</p>
</li>
<li><p>libc leak<br>if we want to reproduce <code>unsortedbin attack</code>, we have to fullfill the <code>tcache</code>, then the chunks will be put into <code>unsortedbin</code></p>
</li>
<li><p>protection enhancement in <code>glibc</code> 2.27</p>
</li>
</ul>
<ol>
<li>in <code>tcache_entry</code> add ptr <code>key</code></li>
<li>set max num of <code>tcache</code></li>
<li>in <code>tcache_put()</code>, let <code>key</code> of a <code>tcache_entry</code> point to <code>tcache</code>, for checking double free</li>
<li>in <code>tcache_get()</code>, clean pointer <code>key</code> when removing <code>chunk</code> from <code>tcache</code></li>
<li>in <code>int_free()</code>, check whether the chunk to free is in <code>tcache</code> list, and will print <code>free(): double free detected in tcache 2</code></li>
<li>in <code>_int_realloc()</code>, use <code>memcpy()</code> instead copy bit by bit, more concise</li>
<li>in <code>do_set_tcache_count()</code>, limit <code>tcache_count</code> to be smaller than <code>MAX_TCACHE_COUNT</code> (127)</li>
</ol>
<p>Visit <a href="/2020/10/26/2020-10-26-ADWorld-PWN-Challenge-Area-Write-ups-Tcache/">ADWorld PWN Challenge Area Write-ups (Tcache)</a> for some challenges.</p>
<h2 id="House-of-Einherjar"><a href="#House-of-Einherjar" class="headerlink" title="House of Einherjar"></a>House of Einherjar</h2><p>I can force <code>malloc</code> chunk at almost anywhere, by exploiting <code>consolidate backward</code> in <code>free</code>.</p>
<p>The key part of the code in <code>free</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* consolidate backward */</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">prev_inuse</span>(p)) &#123;</span><br><span class="line">    prevsize = <span class="built_in">prev_size</span>(p);</span><br><span class="line">    size += prevsize;</span><br><span class="line">    p = <span class="built_in">chunk_at_offset</span>(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">    <span class="built_in">unlink</span>(av, p, bck, fwd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And the effect is like:<img src="/imghost/hei/backward_consolidate.png" alt="backward_consolidate"><br>So the <code>p</code> we finally get is based on the original <code>p</code> and its <code>prevsize</code>, also with some security checks.</p>
<p>Before the overflow:<img src="/imghost/hei/einherjar_before_overflow.png" alt="einherjar_before_overflow"><br>If we can overflow (fake) the <code>prev_size</code> and the <code>PREV_INUSE</code> (off-by-one), then:<img src="/imghost/hei/einherjar_overflowing.png" alt="einherjar_overflowing"><br>After the overflow, we get new chunk: <code>chunk_at_offset(p1, -((long) prevsize))</code> <img src="/imghost/hei/einherjar_after_overflow.png" alt="einherjar_after_overflow"><br>But there are constraints like <code>unlink</code> has, so we have to fake the structure at the corresponding chunk. </p>
<h2 id="House-of-Force"><a href="#House-of-Force" class="headerlink" title="House of Force"></a>House of Force</h2><p>Control top chunk’s size and lift/lower top chunk address to control <code>GOT</code> items (can be used in VM escaping).</p>
<h2 id="House-of-Lore"><a href="#House-of-Lore" class="headerlink" title="House of Lore"></a>House of Lore</h2><p>Fake a small bin by changing <code>fd</code> and <code>bk</code> (bypass <code>malloc</code> check)</p>
<h2 id="House-of-Orange"><a href="#House-of-Orange" class="headerlink" title="House of Orange"></a>House of Orange</h2><p>It aims to exploit vulns to gain <code>free</code> ability, in a program without the function to <code>free</code>.</p>
<p>It mainly depends on the process when <code>top chunk</code> cannot meet the new <code>malloc</code> request. The old <code>top chunk</code> will be <code>freed</code> to <code>unsorted bin</code>, therefore we can obtain <code>unsorted bin</code> without <code>free</code> function.</p>
<p>Normally we carefully constructed the fake size of <code>top chunk</code>, and <code>malloc</code> a bigger <code>chunk</code> to link this <code>top chunk</code> into <code>unsorted bin</code>; next we are able to allocate <code>chunk</code> cutted from <code>unsorted bin</code>. Later exploitation part is related to IO_FILE. (More at <a href="/2020/10/26/2020-10-26-ADWorld-PWN-Challenge-Area-Write-ups-IO-FILE-related/">ADWorld PWN Challenge Area Write-ups (IO_FILE related)</a>)</p>
<p>Before <code>glibc</code> 2.23 the exploit is: modify <code>stdout</code> (e.g. <code>unsortedbin attack</code> to modify <code>_IO_list_all</code>, then using <code>unlink</code> of <code>unsortedbin</code> to put chunk into <code>smallbin</code>, which is the corresponding <code>_IO_list_all-&gt;_chain</code> linking fake <code>_IO_FILE</code>) and trigger <code>abort</code> of <code>libc</code>, use <code>_IO_flush_all_lockp</code> in <code>abort</code> to control program flow.</p>
<p>Whole calling process:<br><code>__libc_malloc</code> =&gt; <code>malloc_printerr</code> =&gt; <code>__libc_message</code> =&gt; <code>abort</code> =&gt; <code>_IO_flush_all_lockp</code><br><img src="/imghost/hei/abort_routine.001.jpg" alt="abort_routine.001"></p>
<p>After <code>glibc</code> 2.23 (like <code>glibc</code> 2.24) adds <code>_IO_vtable_check</code> which limits <code>vtable</code> address to be between <code>__stop___libc_IO_vtables</code> and <code>__start___libc_IO_vtables</code>. So we use <code>_IO_str_jumps-&gt;__finish</code>.</p>
<p>After <code>glibc</code> 2.27 the <code>flush</code> of stream is discarded.</p>
<p>As for House of Orange by thread, when the size of <code>thread_arena.top</code> is not enough it will call <code>sysmalloc</code> to extend <code>heap</code>, and if original heap is larger than <code>0x4000000</code> the <code>sysmalloc</code> will free <code>top chunk</code> and re-alloc in low address.</p>
<h2 id="House-of-Rabbit"><a href="#House-of-Rabbit" class="headerlink" title="House of Rabbit"></a>House of Rabbit</h2><p>Though it has a check for <code>size</code> when fetching <code>bin</code> in <code>fastbin</code>, there is no check when <code>malloc consolidate</code> works.</p>
<p>Therefore we can fake either <code>fd</code> or <code>size</code> part of the <code>fastbin</code>, and trigger <code>malloc consolidate</code> by merging the <code>top chunk</code> or <code>malloc</code> some big <code>chunk</code>.</p>
<p>After that we will find our forged overlapped <code>chunk</code>, or the <code>chunk</code> at our target address, in the <code>unsorted bin</code>, waiting to be allocated</p>
<h2 id="House-of-Roman"><a href="#House-of-Roman" class="headerlink" title="House of Roman"></a>House of Roman</h2><p>A trick combining <code>fastbin attack</code> with <code>unsorted bin attack</code>.</p>
<p>By modifying the size of a <code>chunk</code> which belongs to <code>unsorted bin</code> before to be a <code>fastbin chunk</code>, we can get the <code>main_arena + 0x88</code> remains in the <code>fd</code> of the <code>fastbin</code>. Then we can <code>malloc</code> the area around <code>main_arena + 0x88</code> like <code>malloc_hook</code>, and use <code>unsorted bin attack</code> to write a <code>main_arena + 0x88</code> (<code>libc</code> related address) to <code>malloc_hook</code>. By modifying the last 2 bytes, we can let <code>malloc_hook</code> points to <code>one gadget</code> (1/16 chance)</p>
<h2 id="House-of-Spirit"><a href="#House-of-Spirit" class="headerlink" title="House of Spirit"></a>House of Spirit</h2><p>It is to fake <code>chunk</code> by modifying just a little <code>bit</code>, get it freed to <code>fastbin</code>, and then allocate it to control a relatively big area.</p>
<h2 id="House-of-Banana"><a href="#House-of-Banana" class="headerlink" title="House of Banana"></a>House of Banana</h2><p>After <code>glibc 2.28</code> the <code>_int_malloc()</code> adds check for <code>bk</code> of <code>unsortedbin</code> to Invalidate <code>unsortedbin attack</code>. Then attackers consider <code>largebin attack</code> and using <code>House of Storm</code> to alloc anywhere.</p>
<p>However after <code>glibc</code> 2.29 the <code>House of Storm</code> is invalid, and after <code>glibc</code> 2.30 normal <code>largebin attack</code> also fails in some aspects (can only write <code>unsortedbin address</code> to anywhere in <code>glibc</code> 2.32, instead of writing any 2 heap addresses to 2 places).</p>
<p>The <code>House of Banana</code> starts from ptr <code>_rtld_global</code> in <code>ld.so</code> which pointing to struct <code>rtld_global</code>. There are many <code>_dl_ns</code> structs which store ELF segments symbol structs, include <code>fini_array</code> which is used in <code>_dl_fini()</code>.</p>
<p>So what <code>House of Banana</code> do is to fake a <code>rtld_global</code> struct, and using <code>largebin attack</code> to write heap addr into <code>rtld_global</code>. When the program exit, it will execute faked <code>fini_array</code>.</p>
<h2 id="House-of-Kiwi"><a href="#House-of-Kiwi" class="headerlink" title="House of Kiwi"></a>House of Kiwi</h2><p>Sometimes we encounter strict limits like sandbox restrictions, it gives us a special way to control the program.</p>
<p>First we should be able to trigger <code>__malloc_assert()</code> (heap overflow), second we should be able to write anywhere, edit <code>_IO_file_sync</code>, <code>IO_helper_jumps + 0xA0</code> and <code>IO_helper_jumps + 0xA8</code>.</p>
<p>In <code>__malloc_assert()</code> has a <code>flush(stderr)</code> which calls <code>_IO_file_jumps -&gt; sync</code> and there’re a few ways to trigger the assert.<br>By changing <code>_IO_file_sync</code> at <code>_IO_file_jumps + 0x60</code> as <code>setcontext + 61</code> and modifing <code>IO_helper_jumps + 0xA0 and 0xA8</code> as <code>ROP addr</code> and <code>ret gadget addr</code> can perform stack pivoting.</p>
<h2 id="House-of-Husk"><a href="#House-of-Husk" class="headerlink" title="House of Husk"></a>House of Husk</h2><p><a class="link"   target="_blank" rel="noopener" href="https://ptr-yudai.hatenablog.com/entry/2020/04/02/111507" >https://ptr-yudai.hatenablog.com/entry/2020/04/02/111507<i class="fas fa-external-link-alt"></i></a></p>
<h2 id="Updating…"><a href="#Updating…" class="headerlink" title="Updating…"></a>Updating…</h2>
        </div>

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2021/07/30/2021-07-30-ARM-MIPS-PWN-Intro/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">ARM &amp; MIPS PWN Intro</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2021/04/20/2021-04-20-Linux-Kernel-Building-Exploit-Preparation/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Linux Kernel Building &amp; Exploit Preparation</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2018</span>&nbsp;-&nbsp;
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">TyeYeah</a>
        </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.3</a>
        </div>
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Implementation"><span class="nav-number">1.</span> <span class="nav-text">Implementation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Heap-Overflow"><span class="nav-number">2.</span> <span class="nav-text">Heap Overflow</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unlink"><span class="nav-number">3.</span> <span class="nav-text">Unlink</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chunk-Extend-Overlapping"><span class="nav-number">4.</span> <span class="nav-text">Chunk Extend&#x2F;Overlapping</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Use-After-Free"><span class="nav-number">5.</span> <span class="nav-text">Use After Free</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Fastbin-Attack"><span class="nav-number">6.</span> <span class="nav-text">Fastbin Attack</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unsorted-Bin-Attack"><span class="nav-number">7.</span> <span class="nav-text">Unsorted Bin Attack</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Large-Bin-Attack"><span class="nav-number">8.</span> <span class="nav-text">Large Bin Attack</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#House-of-Storm"><span class="nav-number">9.</span> <span class="nav-text">House of Storm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tcache-Attack"><span class="nav-number">10.</span> <span class="nav-text">Tcache Attack</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#House-of-Einherjar"><span class="nav-number">11.</span> <span class="nav-text">House of Einherjar</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#House-of-Force"><span class="nav-number">12.</span> <span class="nav-text">House of Force</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#House-of-Lore"><span class="nav-number">13.</span> <span class="nav-text">House of Lore</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#House-of-Orange"><span class="nav-number">14.</span> <span class="nav-text">House of Orange</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#House-of-Rabbit"><span class="nav-number">15.</span> <span class="nav-text">House of Rabbit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#House-of-Roman"><span class="nav-number">16.</span> <span class="nav-text">House of Roman</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#House-of-Spirit"><span class="nav-number">17.</span> <span class="nav-text">House of Spirit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#House-of-Banana"><span class="nav-number">18.</span> <span class="nav-text">House of Banana</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#House-of-Kiwi"><span class="nav-number">19.</span> <span class="nav-text">House of Kiwi</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#House-of-Husk"><span class="nav-number">20.</span> <span class="nav-text">House of Husk</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Updating%E2%80%A6"><span class="nav-number">21.</span> <span class="nav-text">Updating…</span></a></li></ol>
    </div>
</div>
        </aside>
    

    .image-viewer-container {
  position: fixed;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0);
  visibility: hidden;
  z-index: $z-index-8;
  padding: 6%;
  box-sizing: border-box;
  transition-t("visibility, background", "0, 0", "0.3, 0.3", "ease, ease");

  &.active {
    background: rgba(0, 0, 0, 0.5);
    visibility: visible;

    img {
      cursor: zoom-out;
      transform: scale(1);
      padding: 2px;
      background: var(--background-color);
    }
  }

  img {
    max-width: 100%;
    max-height: 100%;
    transform: scale(0);
    transition-t("transform", "0", "0.3", "ease");
  }
}




    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>





<div class="post-scripts">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>



</body>
</html>
